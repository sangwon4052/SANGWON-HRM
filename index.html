<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¢ ì§ì›ê´€ë¦¬ ì‹œìŠ¤í…œ (Firebase ì—°ë™)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* í—¤ë” */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header-left p {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .user-info-bar {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-badge {
            background: #3498db;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .user-badge.admin {
            background: #e74c3c;
        }

        .header-btn, .logout-btn {
            padding: 10px 20px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .header-btn:hover, .logout-btn:hover {
            background: white;
            color: #2c3e50;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ íƒ­ */
        .nav-tabs {
            display: flex;
            background: #ecf0f1;
            border-bottom: 3px solid #bdc3c7;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 18px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            font-weight: 600;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: #d5dbdb;
            color: #2c3e50;
        }

        .nav-tab.active {
            color: #3498db;
            background: white;
            border-bottom-color: #3498db;
        }

        /* íƒ­ ì½˜í…ì¸  */
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ëŒ€ì‹œë³´ë“œ ì¹´ë“œ */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #ecf0f1;
            transition: all 0.3s;
            cursor: pointer;
        }

        .card:hover {
            border-color: #3498db;
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.3);
        }

        .card-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .card-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 8px;
        }

        .card-value {
            font-size: 2em;
            font-weight: 700;
            color: #2c3e50;
        }

        /* ë²„íŠ¼ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        /* í…Œì´ë¸” */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* ë°°ì§€ */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-secondary {
            background: #e2e3e5;
            color: #383d41;
        }

        /* í¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-header h2 {
            color: #2c3e50;
        }

        .close-modal {
            font-size: 2em;
            cursor: pointer;
            color: #7f8c8d;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: #e74c3c;
        }

        /* ì¸ì¦ ì˜¤ë²„ë ˆì´ */
        .auth-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .auth-overlay.active {
            display: flex;
        }

        .auth-box {
            background: white;
            border-radius: 15px;
            padding: 40px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .auth-box h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .auth-tab-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ecf0f1;
            background: #ecf0f1;
            color: #7f8c8d;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .auth-tab-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-error {
            display: none;
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .auth-error.visible {
            display: block;
        }

        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            text-align: center;
            color: white;
        }

        .spinner {
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ê²€ìƒ‰ */
        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            max-width: 400px;
            padding: 12px 20px;
            border: 2px solid #ecf0f1;
            border-radius: 25px;
            font-size: 1em;
        }

        /* ìê²©ì¦ ì¹´ë“œ */
        .certificate-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #dee2e6;
        }

        .certificate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .remove-cert-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .add-certificate-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        /* ì•Œë¦¼ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 10001;
            display: none;
            animation: slideIn 0.3s;
        }

        .notification.active {
            display: block;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            border-left: 5px solid #27ae60;
        }

        .notification.error {
            border-left: 5px solid #e74c3c;
        }

        /* ë°±ì—… ì •ë³´ */
        .backup-info {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
            margin-bottom: 20px;
        }

        .backup-info h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .backup-info p {
            margin: 5px 0;
            color: #34495e;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ecf0f1;
        }

        .info-item label {
            display: block;
            font-size: 0.85em;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .info-item .value {
            font-size: 1.3em;
            font-weight: 700;
            color: #2c3e50;
        }

        /* ê´€ë¦¬ì íŒ¨ë„ */
        .pending-users-section,
        .admin-settings-section {
            background: #fff9e6;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #f39c12;
            margin-bottom: 20px;
        }

        .pending-user-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #ecf0f1;
        }

        .user-detail {
            flex: 1;
        }

        .user-detail strong {
            color: #2c3e50;
            font-size: 1.1em;
        }

        .user-detail span {
            color: #7f8c8d;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <!-- ì•Œë¦¼ -->
    <div id="notification" class="notification"></div>

    <!-- ì¸ì¦ ì˜¤ë²„ë ˆì´ (ë¡œê·¸ì¸/íšŒì›ê°€ì…) -->
    <div id="authOverlay" class="auth-overlay active">
        <div class="auth-box">
            <h2>ğŸ¢ ì§ì›ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
            <div class="auth-tabs">
                <button class="auth-tab-btn active" onclick="switchAuthTab('login')">ë¡œê·¸ì¸</button>
                <button class="auth-tab-btn" onclick="switchAuthTab('register')">íšŒì›ê°€ì…</button>
            </div>

            <!-- ë¡œê·¸ì¸ í¼ -->
            <div id="loginForm" class="auth-form active">
                <div id="loginError" class="auth-error"></div>
                <div class="form-group">
                    <label>ì•„ì´ë””</label>
                    <input type="text" id="loginId" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="username">
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="current-password">
                </div>
                <button class="btn btn-primary" style="width:100%;" onclick="doLogin()">ë¡œê·¸ì¸</button>
            </div>

            <!-- íšŒì›ê°€ì… í¼ -->
            <div id="registerForm" class="auth-form">
                <div id="registerError" class="auth-error"></div>
                <div class="form-group">
                    <label>ì´ë¦„ (ì‹¤ëª…)</label>
                    <input type="text" id="registerName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group">
                    <label>ì•„ì´ë”” (4ì ì´ìƒ)</label>
                    <input type="text" id="registerId" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="username">
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
                    <input type="password" id="registerPw" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input type="password" id="registerPw2" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”" autocomplete="new-password">
                </div>
                <button class="btn btn-success" style="width:100%;" onclick="doRegister()">ê°€ì… ì‹ ì²­</button>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <div class="header-left">
                <h1>ğŸ¢ ì§ì›ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
                <p>Employee Management System (Firebase ì—°ë™)</p>
            </div>
            <div class="header-right">
                <div class="user-info-bar">
                    <span id="headerUserName">-</span>
                    <span id="headerUserBadge" class="user-badge">ì¼ë°˜</span>
                    <button class="logout-btn" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
                <button class="header-btn" onclick="downloadBackup()">ğŸ’¾ ë°±ì—…</button>
                <button class="header-btn" onclick="document.getElementById('restoreFileInput').click()">ğŸ“‚ ë³µêµ¬</button>
                <input type="file" id="restoreFileInput" accept=".json" style="display:none;" onchange="restoreBackup(event)">
            </div>
        </div>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ íƒ­ -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
            <button class="nav-tab" onclick="showTab('employees')">ğŸ‘¥ ì§ì›ê´€ë¦¬</button>
            <button class="nav-tab" id="annualLeaveTab" onclick="showAnnualLeaveTab()">ğŸ“… ì—°ì°¨ê´€ë¦¬ ğŸ”’</button>
            <button class="nav-tab" onclick="showTab('education')">ğŸ“š ì§ë¬´êµìœ¡</button>
            <button class="nav-tab" onclick="showTab('backup')">âš™ï¸ ë°±ì—…ê´€ë¦¬</button>
            <button class="nav-tab" id="adminTab" style="display:none;" onclick="showTab('admin')">ğŸ›¡ï¸ ê´€ë¦¬ì</button>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
        <div id="dashboard" class="tab-content active">
            <h2 style="margin-bottom: 25px; color: #2c3e50;">ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>
            <div class="dashboard">
                <div class="card" onclick="showTab('employees')">
                    <div class="card-icon">ğŸ‘¥</div>
                    <div class="card-label">ì „ì²´ ì§ì›</div>
                    <div class="card-value" id="dashTotalEmployees">0</div>
                </div>
                <div class="card" onclick="showTab('employees')">
                    <div class="card-icon">âœ…</div>
                    <div class="card-label">ì¬ì§ ì§ì›</div>
                    <div class="card-value" id="dashActiveEmployees">0</div>
                </div>
                <div class="card" onclick="showTab('employees')">
                    <div class="card-icon">ğŸ“¤</div>
                    <div class="card-label">í‡´ì‚¬ ì§ì›</div>
                    <div class="card-value" id="dashResignedEmployees">0</div>
                </div>
                <div class="card" onclick="showTab('education')">
                    <div class="card-icon">ğŸ“š</div>
                    <div class="card-label">êµìœ¡ ì˜ˆì • (6ê°œì›”)</div>
                    <div class="card-value" id="dashUpcomingEducation">0</div>
                </div>
            </div>
        </div>

        <!-- ì§ì›ê´€ë¦¬ íƒ­ -->
        <div id="employees" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">ğŸ‘¥ ì§ì›ê´€ë¦¬</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                <div class="search-box">
                    <input type="text" id="employeeSearch" placeholder="ğŸ” ì´ë¦„, ì´ë©”ì¼, ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰..." onkeyup="searchEmployees()">
                </div>
                <button class="btn btn-primary" onclick="openEmployeeModal()">+ ì§ì› ë“±ë¡</button>
            </div>
            <div class="table-container">
                <table id="employeeTable">
                    <thead>
                        <tr>
                            <th>ì„±ëª…</th>
                            <th>ì„±ë³„</th>
                            <th>ì „í™”ë²ˆí˜¸</th>
                            <th>ì´ë©”ì¼</th>
                            <th>ìê²©ì¦</th>
                            <th>ì…ì‚¬ì¼</th>
                            <th>ìƒíƒœ</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="employeeTableBody">
                        <tr><td colspan="8" style="text-align:center; padding: 40px; color: #7f8c8d;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ì—°ì°¨ê´€ë¦¬ íƒ­ -->
        <div id="annual-leave" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">ğŸ“… ì—°ì°¨ê´€ë¦¬</h2>
            <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="font-weight: 600; color: #2c3e50;">íšŒê³„ë…„ë„:</label>
                    <input type="number" id="fiscalYear" min="2020" max="2100" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 5px; width: 100px;">
                </div>
                <button class="btn btn-primary" onclick="calculateAllAnnualLeave()">ğŸ”„ ì—°ì°¨ ì¬ê³„ì‚°</button>
                <button class="btn btn-success" onclick="openBulkLeaveModal()">ğŸ“‹ ì¼ê´„ ì—°ì°¨ ë¶€ì—¬</button>
                <span style="color: #7f8c8d; font-size: 0.9em;">â€» íšŒê³„ë…„ë„ ê¸°ì¤€(12ì›” 31ì¼)ìœ¼ë¡œ ì—°ì°¨ê°€ ê³„ì‚°ë©ë‹ˆë‹¤.</span>
            </div>
            <div class="table-container">
                <table id="annualLeaveTable">
                    <thead>
                        <tr>
                            <th>ì„±ëª…</th>
                            <th>ì…ì‚¬ì¼</th>
                            <th>ê·¼ì†ì—°ìˆ˜</th>
                            <th>ì´ ì—°ì°¨</th>
                            <th>ì‚¬ìš© ì—°ì°¨</th>
                            <th>ì”ì—¬ ì—°ì°¨</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="annualLeaveTableBody">
                        <tr><td colspan="7" style="text-align:center; padding: 40px; color: #7f8c8d;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ì§ë¬´êµìœ¡ íƒ­ -->
        <div id="education" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">ğŸ“š ì§ë¬´êµìœ¡</h2>
            <div class="table-container">
                <table id="educationTable">
                    <thead>
                        <tr>
                            <th>ì„±ëª…</th>
                            <th>ìê²©ì¦</th>
                            <th>ì·¨ë“ì¼</th>
                            <th>êµìœ¡ìœ í˜•</th>
                            <th>êµìœ¡ì¼ì •</th>
                            <th>D-Day</th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody id="educationTableBody">
                        <tr><td colspan="7" style="text-align:center; padding: 40px; color: #7f8c8d;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ë°±ì—…ê´€ë¦¬ íƒ­ -->
        <div id="backup" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">âš™ï¸ ë°±ì—…ê´€ë¦¬</h2>
            
            <div class="backup-info">
                <h3>ğŸ’¾ ë°±ì—… ë‹¤ìš´ë¡œë“œ</h3>
                <p>â€¢ í˜„ì¬ Firebaseì— ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</p>
                <p>â€¢ íŒŒì¼ëª…ì— í˜„ì¬ ë‚ ì§œê°€ ìë™ìœ¼ë¡œ í¬í•¨ë©ë‹ˆë‹¤.</p>
                <p>â€¢ ì§ì›ì •ë³´, ì—°ì°¨ì •ë³´, êµìœ¡ì¼ì •, ì‚¬ìš©ì ì •ë³´ê°€ ëª¨ë‘ í¬í•¨ë©ë‹ˆë‹¤.</p>
                <button class="btn btn-primary" onclick="downloadBackup()" style="margin-top: 10px;">ğŸ’¾ ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
            </div>

            <div class="backup-info" style="background: #f0f8e8; border-left-color: #27ae60;">
                <h3>ğŸ“‚ ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°</h3>
                <p>â€¢ ì´ì „ì— ë‹¤ìš´ë¡œë“œí•œ ë°±ì—… íŒŒì¼ì„ ì„ íƒí•˜ì—¬ ë°ì´í„°ë¥¼ ë³µì›í•©ë‹ˆë‹¤.</p>
                <p>â€¢ <strong style="color: #e74c3c;">âš ï¸ ì£¼ì˜: Firebaseì˜ í˜„ì¬ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë˜ê³  ë°±ì—… íŒŒì¼ì˜ ë°ì´í„°ë¡œ êµì²´ë©ë‹ˆë‹¤.</strong></p>
                <p>â€¢ ë°±ì—… íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ê¸° ì „ì— í˜„ì¬ ë°ì´í„°ë¥¼ ë°±ì—…í•´ë‘ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
                <button class="btn btn-success" onclick="document.getElementById('restoreFileInput2').click()" style="margin-top: 10px;">ğŸ“‚ ë°±ì—… íŒŒì¼ ì„ íƒ</button>
                <input type="file" id="restoreFileInput2" accept=".json" style="display:none;" onchange="restoreBackup(event)">
            </div>

            <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">ğŸ“Š í˜„ì¬ ë°ì´í„° í˜„í™©</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>ì „ì²´ ì§ì›</label>
                        <div class="value" id="backupEmployeeCount">0ëª…</div>
                    </div>
                    <div class="info-item">
                        <label>ì—°ì°¨ ë°ì´í„°</label>
                        <div class="value" id="backupLeaveCount">0ê±´</div>
                    </div>
                    <div class="info-item">
                        <label>êµìœ¡ ì¼ì •</label>
                        <div class="value" id="backupEducationCount">0ê±´</div>
                    </div>
                    <div class="info-item">
                        <label>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</label>
                        <div class="value" id="lastUpdate">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê´€ë¦¬ì íŒ¨ë„ íƒ­ -->
        <div id="admin" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">ğŸ›¡ï¸ ê´€ë¦¬ì íŒ¨ë„</h2>

            <div class="pending-users-section">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">â³ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íšŒì›</h3>
                <div id="pendingUsersList">
                    <p style="color: #856404; font-style: italic;">ëŒ€ê¸° ì¤‘ì¸ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>

            <div class="admin-settings-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">ğŸ‘¥ ì „ì²´ íšŒì› ëª©ë¡</h3>
                <div id="allUsersList"></div>
            </div>

            <div class="admin-settings-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">ğŸ”‘ ê´€ë¦¬ì ê³„ì • ì„¤ì •</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>ìƒˆ ê´€ë¦¬ì ì•„ì´ë””</label>
                        <input type="text" id="newAdminId" placeholder="ë³€ê²½í•  ì•„ì´ë””">
                    </div>
                    <div class="form-group">
                        <label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" id="currentAdminPw" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="newAdminPw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
                    </div>
                    <div class="form-group">
                        <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" id="newAdminPw2" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="updateAdminAccount()">ê´€ë¦¬ì ê³„ì • ì—…ë°ì´íŠ¸</button>
            </div>
        </div>
    </div>

    <!-- ì§ì› ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="employeeModalTitle">ì§ì› ë“±ë¡</h2>
                <span class="close-modal" onclick="closeEmployeeModal()">&times;</span>
            </div>
            <form onsubmit="saveEmployee(event)">
                <input type="hidden" id="employeeId">
                
                <h3 style="color: #2c3e50; margin-bottom: 15px;">ê¸°ë³¸ ì •ë³´</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì„±ëª… *</label>
                        <input type="text" id="employeeName" required>
                    </div>
                    <div class="form-group">
                        <label>ì„±ë³„ *</label>
                        <select id="employeeGender" required>
                            <option value="">ì„ íƒ</option>
                            <option value="ë‚¨">ë‚¨</option>
                            <option value="ì—¬">ì—¬</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ì£¼ì†Œ</label>
                    <input type="text" id="employeeAddress">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ì „í™”ë²ˆí˜¸</label>
                        <input type="tel" id="employeePhone">
                    </div>
                    <div class="form-group">
                        <label>ì´ë©”ì¼</label>
                        <input type="email" id="employeeEmail">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ì…ì‚¬ì¼ *</label>
                        <input type="date" id="employeeHireDate" required>
                    </div>
                    <div class="form-group">
                        <label>í‡´ì‚¬ì¼</label>
                        <input type="date" id="employeeResignDate">
                    </div>
                </div>

                <h3 style="color: #2c3e50; margin-top: 30px; margin-bottom: 15px;">ìê²©ì¦ ì •ë³´</h3>
                <div id="certificatesContainer"></div>
                <button type="button" class="add-certificate-btn" onclick="addCertificateField()">+ ìê²©ì¦ ì¶”ê°€</button>

                <div style="margin-top: 30px; display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">ì €ì¥</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEmployeeModal()">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ì§ì› ìƒì„¸ì •ë³´ ëª¨ë‹¬ -->
    <div id="employeeDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ì§ì› ìƒì„¸ì •ë³´</h2>
                <span class="close-modal" onclick="closeEmployeeDetailModal()">&times;</span>
            </div>
            <div id="employeeDetailContent"></div>
        </div>
    </div>

    <!-- ì—°ì°¨ ì‚¬ìš© ë“±ë¡ ëª¨ë‹¬ -->
    <div id="annualLeaveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ì—°ì°¨ ì‚¬ìš© ë“±ë¡</h2>
                <span class="close-modal" onclick="closeAnnualLeaveModal()">&times;</span>
            </div>
            <form onsubmit="saveAnnualLeaveUsage(event)">
                <input type="hidden" id="leaveEmployeeId">
                <div class="form-group">
                    <label>ì§ì›ëª…</label>
                    <input type="text" id="leaveEmployeeName" readonly style="background: #f8f9fa;">
                </div>
                
                <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <div>
                            <small style="color: #7f8c8d;">ì´ ì—°ì°¨</small>
                            <div style="font-size: 1.2em; font-weight: 600; color: #2c3e50;" id="leaveTotalDays">0</div>
                        </div>
                        <div>
                            <small style="color: #7f8c8d;">ì‚¬ìš© ì—°ì°¨</small>
                            <div style="font-size: 1.2em; font-weight: 600; color: #e74c3c;" id="leaveUsedDays">0</div>
                        </div>
                        <div>
                            <small style="color: #7f8c8d;">ì”ì—¬ ì—°ì°¨</small>
                            <div style="font-size: 1.2em; font-weight: 600; color: #27ae60;" id="leaveRemainingDays">0</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ì‚¬ìš© ì¼ìˆ˜ *</label>
                        <input type="number" id="leaveUsageDays" min="0.5" step="0.5" required>
                    </div>
                    <div class="form-group">
                        <label>ì‚¬ìš© ë‚ ì§œ *</label>
                        <input type="date" id="leaveUsageDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>ì‚¬ìœ </label>
                    <textarea id="leaveUsageReason" rows="3"></textarea>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">ë“±ë¡</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAnnualLeaveModal()">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ì—°ì°¨ ì‚¬ìš©ë‚´ì—­ ëª¨ë‹¬ -->
    <div id="annualLeaveHistoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ì—°ì°¨ ì‚¬ìš©ë‚´ì—­</h2>
                <span class="close-modal" onclick="closeAnnualLeaveHistoryModal()">&times;</span>
            </div>
            <div id="annualLeaveHistoryContent"></div>
        </div>
    </div>

    <!-- ì¼ê´„ ì—°ì°¨ ë¶€ì—¬ ëª¨ë‹¬ -->
    <div id="bulkLeaveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ì§ì› ì¼ê´„ ì—°ì°¨ ë¶€ì—¬</h2>
                <span class="close-modal" onclick="closeBulkLeaveModal()">&times;</span>
            </div>
            <form onsubmit="saveBulkLeave(event)">
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <strong>âš ï¸ ì£¼ì˜ì‚¬í•­</strong>
                    <ul style="margin: 10px 0 0 20px; color: #856404;">
                        <li>ì¬ì§ ì¤‘ì¸ ëª¨ë“  ì§ì›ì—ê²Œ ì¼ê´„ ì ìš©ë©ë‹ˆë‹¤.</li>
                        <li>ì”ì—¬ ì—°ì°¨ê°€ ë¶€ì¡±í•œ ì§ì›ì€ ìë™ìœ¼ë¡œ ì œì™¸ë©ë‹ˆë‹¤.</li>
                        <li>ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ì ìš© ëŒ€ìƒì„ í™•ì¸í•˜ì„¸ìš”.</li>
                    </ul>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ì‚¬ìš© ì¼ìˆ˜ *</label>
                        <input type="number" id="bulkLeaveDays" min="0.5" step="0.5" required oninput="updateBulkLeavePreview()">
                    </div>
                    <div class="form-group">
                        <label>ì‚¬ìš© ë‚ ì§œ *</label>
                        <input type="date" id="bulkLeaveDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>ì‚¬ìœ  *</label>
                    <input type="text" id="bulkLeaveReason" placeholder="ì˜ˆ: íšŒì‚¬ íœ´ë¬´ì¼" required>
                </div>
                
                <div id="bulkLeavePreview" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="margin-bottom: 10px; color: #2c3e50;">ë¯¸ë¦¬ë³´ê¸°</h4>
                    <div id="bulkLeavePreviewContent">
                        <p style="color: #7f8c8d;">ì‚¬ìš© ì¼ìˆ˜ë¥¼ ì…ë ¥í•˜ë©´ ì ìš© ëŒ€ìƒì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">ì¼ê´„ ì ìš©</button>
                    <button type="button" class="btn btn-secondary" onclick="closeBulkLeaveModal()">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================
        // Firebase ì„¤ì •
        // ============================
        const FB_PROJ = 'sangwon-hrm';
        const FB_KEY = 'AIzaSyBebDpB0eFP2yDZ4NK6K8IoWS8aTseHkzc';
        const FB_BASE = `https://firestore.googleapis.com/v1/projects/${FB_PROJ}/databases/(default)/documents`;

        // ============================
        // ì „ì—­ ë³€ìˆ˜
        // ============================
        let employees = [];
        let annualLeaves = [];
        let educations = [];
        let currentUser = null;
        let certIdCounter = 1;

        // ============================
        // Firestore ë°ì´í„° ë³€í™˜ í•¨ìˆ˜
        // ============================
        function toFV(val) {
            if (val === null || val === undefined) return { nullValue: null };
            if (typeof val === 'string') return { stringValue: val };
            if (typeof val === 'number') {
                return Number.isInteger(val) ? { integerValue: String(val) } : { doubleValue: val };
            }
            if (typeof val === 'boolean') return { booleanValue: val };
            if (Array.isArray(val)) {
                return { arrayValue: { values: val.map(v => toFV(v)) } };
            }
            if (typeof val === 'object') {
                return { mapValue: { fields: toFs(val) } };
            }
            return { stringValue: String(val) };
        }

        function toFs(obj) {
            const fields = {};
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    fields[key] = toFV(obj[key]);
                }
            }
            return fields;
        }

        function fromFV(fv) {
            if (!fv) return null;
            if (fv.stringValue !== undefined) return fv.stringValue;
            if (fv.integerValue !== undefined) return parseInt(fv.integerValue, 10);
            if (fv.doubleValue !== undefined) return fv.doubleValue;
            if (fv.booleanValue !== undefined) return fv.booleanValue;
            if (fv.nullValue !== undefined) return null;
            if (fv.arrayValue) {
                return (fv.arrayValue.values || []).map(v => fromFV(v));
            }
            if (fv.mapValue) {
                return fromFs(fv.mapValue.fields || {});
            }
            return null;
        }

        function fromFs(fields) {
            const obj = {};
            for (const key in fields) {
                if (fields.hasOwnProperty(key)) {
                    obj[key] = fromFV(fields[key]);
                }
            }
            return obj;
        }

        // ============================
        // Firebase REST API í•¨ìˆ˜
        // ============================
        async function fbGetAll(col) {
            const r = await fetch(`${FB_BASE}/${col}?key=${FB_KEY}&pageSize=500`);
            if (!r.ok) throw new Error(`HTTP ${r.status} (${col})`);
            const j = await r.json();
            if (!j.documents) return [];
            return j.documents.map(d => {
                const data = fromFs(d.fields || {});
                // Firestore ë¬¸ì„œ IDë¥¼ idë¡œ ì‚¬ìš©
                const docId = d.name.split('/').pop();
                if (!data.id) data.id = docId;
                return data;
            });
        }

        async function fbSet(col, id, data) {
            const eid = encodeURIComponent(String(id));
            const r = await fetch(`${FB_BASE}/${col}/${eid}?key=${FB_KEY}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fields: toFs(JSON.parse(JSON.stringify(data))) })
            });
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
        }

        async function fbDel(col, id) {
            const eid = encodeURIComponent(String(id));
            const r = await fetch(`${FB_BASE}/${col}/${eid}?key=${FB_KEY}`, { method: 'DELETE' });
            if (!r.ok && r.status !== 404) throw new Error(`HTTP ${r.status}`);
        }

        async function fbReplaceAll(col, arr, idKey) {
            const old = await fbGetAll(col);
            for (const d of old) {
                const id = d[idKey] || d.id;
                if (id) await fbDel(col, id);
            }
            for (const item of arr) {
                const id = String(item[idKey] || item.id || Date.now() + Math.random());
                await fbSet(col, id, item);
            }
        }

        // ============================
        // ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        // ============================
        async function loadAllFromFirebase() {
            showLoading(true);
            try {
                [employees, annualLeaves, educations] = await Promise.all([
                    fbGetAll('employees'),
                    fbGetAll('annualLeaves'),
                    fbGetAll('educations')
                ]);
                updateDashboard();
                loadEmployees();
                loadAnnualLeave();
                loadEducation();
                updateBackupInfo();
                showLoading(false);
            } catch (error) {
                showLoading(false);
                throw error;
            }
        }

        // ============================
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        // ============================
        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} active`;
            setTimeout(() => {
                notification.classList.remove('active');
            }, 3000);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function showAnnualLeaveTab() {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('ğŸ”’ ì—°ì°¨ê´€ë¦¬ëŠ” ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            showTab('annual-leave');
        }

        // ============================
        // ì¸ì¦ ì‹œìŠ¤í…œ
        // ============================
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelectorAll('.auth-tab-btn').forEach(b => b.classList.remove('active'));
            
            if (tab === 'login') {
                document.getElementById('loginForm').classList.add('active');
                event.target.classList.add('active');
            } else {
                document.getElementById('registerForm').classList.add('active');
                event.target.classList.add('active');
            }
            
            document.getElementById('loginError').classList.remove('visible');
            document.getElementById('registerError').classList.remove('visible');
        }

        async function doLogin() {
            const id = document.getElementById('loginId').value.trim();
            const pw = document.getElementById('loginPw').value;
            const errEl = document.getElementById('loginError');
            
            if (!id || !pw) {
                errEl.textContent = 'ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
                errEl.classList.add('visible');
                return;
            }
            
            showLoading(true);
            try {
                const users = await fbGetAll('sysUsers');
                const user = users.find(u => u.id === id && u.pw === pw);
                
                if (!user) {
                    errEl.textContent = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    errEl.classList.add('visible');
                    showLoading(false);
                    return;
                }
                
                if (user.status === 'pending') {
                    errEl.textContent = 'â³ ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.';
                    errEl.classList.add('visible');
                    showLoading(false);
                    return;
                }
                
                if (user.status === 'rejected') {
                    errEl.textContent = 'âŒ ê°€ì…ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.';
                    errEl.classList.add('visible');
                    showLoading(false);
                    return;
                }
                
                currentUser = user;
                sessionStorage.setItem('currentUser', JSON.stringify(user));
                
                await loadAllFromFirebase();
                
                document.getElementById('authOverlay').classList.remove('active');
                document.getElementById('headerUserName').textContent = user.name;
                
                const badge = document.getElementById('headerUserBadge');
                if (user.role === 'admin') {
                    badge.textContent = 'ê´€ë¦¬ì';
                    badge.classList.add('admin');
                    document.getElementById('adminTab').style.display = 'block';
                    document.getElementById('annualLeaveTab').innerHTML = 'ğŸ“… ì—°ì°¨ê´€ë¦¬';
                } else {
                    badge.textContent = 'ì¼ë°˜';
                    badge.classList.remove('admin');
                }
                
                showNotification(`âœ… ${user.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`, 'success');
                showLoading(false);
            } catch (error) {
                errEl.textContent = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
                errEl.classList.add('visible');
                showLoading(false);
            }
        }

        async function doRegister() {
            const name = document.getElementById('registerName').value.trim();
            const id = document.getElementById('registerId').value.trim();
            const pw = document.getElementById('registerPw').value;
            const pw2 = document.getElementById('registerPw2').value;
            const errEl = document.getElementById('registerError');
            
            if (!name || !id || !pw || !pw2) {
                errEl.textContent = 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.';
                errEl.classList.add('visible');
                return;
            }
            
            if (id.length < 4) {
                errEl.textContent = 'ì•„ì´ë””ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                errEl.classList.add('visible');
                return;
            }
            
            if (pw.length < 6) {
                errEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                errEl.classList.add('visible');
                return;
            }
            
            if (pw !== pw2) {
                errEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                errEl.classList.add('visible');
                return;
            }
            
            showLoading(true);
            try {
                const users = await fbGetAll('sysUsers');
                
                if (users.find(u => u.id === id)) {
                    errEl.textContent = 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.';
                    errEl.classList.add('visible');
                    showLoading(false);
                    return;
                }
                
                const newUser = {
                    id: id,
                    pw: pw,
                    name: name,
                    role: 'user',
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                await fbSet('sysUsers', id, newUser);
                
                showNotification('âœ… ê°€ì… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'success');
                
                document.getElementById('registerName').value = '';
                document.getElementById('registerId').value = '';
                document.getElementById('registerPw').value = '';
                document.getElementById('registerPw2').value = '';
                
                switchAuthTab('login');
                showLoading(false);
            } catch (error) {
                errEl.textContent = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
                errEl.classList.add('visible');
                showLoading(false);
            }
        }

        function doLogout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                document.getElementById('authOverlay').classList.add('active');
                document.getElementById('adminTab').style.display = 'none';
                document.getElementById('annualLeaveTab').innerHTML = 'ğŸ“… ì—°ì°¨ê´€ë¦¬ ğŸ”’';
                showNotification('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        // ============================
        // ì´ˆê¸°í™”
        // ============================
        async function initAdmin() {
            try {
                const users = await fbGetAll('sysUsers');
                if (!users.find(u => u.role === 'admin')) {
                    const admin = {
                        id: 'admin',
                        pw: 'admin1234',
                        name: 'ê´€ë¦¬ì',
                        role: 'admin',
                        status: 'approved',
                        createdAt: new Date().toISOString()
                    };
                    await fbSet('sysUsers', 'admin', admin);
                }
            } catch (error) {
                console.error('ê´€ë¦¬ì ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            }
        }

        function showFatalError(msg) {
            document.getElementById('authOverlay').classList.remove('active');
            document.body.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column;gap:16px;font-family:sans-serif;background:#f8f9fa;">
                    <div style="font-size:48px">âŒ</div>
                    <h2 style="color:#e74c3c">Firebase ì—°ê²° ì˜¤ë¥˜</h2>
                    <p style="color:#7f8c8d;text-align:center;max-width:500px;">${msg}</p>
                    <button onclick="location.reload()" style="padding:12px 30px;background:#3498db;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">ë‹¤ì‹œ ì‹œë„</button>
                </div>`;
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // íšŒê³„ë…„ë„ ì´ˆê¸°í™”
            const fiscalYearInput = document.getElementById('fiscalYear');
            if (fiscalYearInput) {
                fiscalYearInput.value = new Date().getFullYear();
            }
            
            // ë¡œê·¸ì¸ ì—”í„°í‚¤ ì§€ì›
            document.getElementById('loginPw').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') doLogin();
            });
            
            // ì„¸ì…˜ ì²´í¬
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('authOverlay').classList.remove('active');
                document.getElementById('headerUserName').textContent = currentUser.name;
                
                const badge = document.getElementById('headerUserBadge');
                if (currentUser.role === 'admin') {
                    badge.textContent = 'ê´€ë¦¬ì';
                    badge.classList.add('admin');
                    document.getElementById('adminTab').style.display = 'block';
                    document.getElementById('annualLeaveTab').innerHTML = 'ğŸ“… ì—°ì°¨ê´€ë¦¬';
                } else {
                    badge.textContent = 'ì¼ë°˜';
                }
                
                try {
                    await initAdmin();
                    await loadAllFromFirebase();
                } catch (e) {
                    showFatalError('Firebase ì—°ê²° ì‹¤íŒ¨: ' + e.message + '<br><br>Firebase ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.');
                    return;
                }
            } else {
                // ê´€ë¦¬ì ê³„ì • ì´ˆê¸°í™”ë§Œ
                try {
                    await initAdmin();
                } catch (e) {
                    showFatalError('Firebase ì—°ê²° ì‹¤íŒ¨: ' + e.message + '<br><br>Firebase í”„ë¡œì íŠ¸ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.');
                }
            }
        });

        // ============================
        // ëŒ€ì‹œë³´ë“œ
        // ============================
        function updateDashboard() {
            const total = employees.length;
            const active = employees.filter(e => !e.resignDate || new Date(e.resignDate) > new Date()).length;
            const resigned = total - active;
            
            const sixMonthsLater = new Date();
            sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
            const upcoming = educations.filter(edu => {
                const eduDate = new Date(edu.educationDate);
                return eduDate >= new Date() && eduDate <= sixMonthsLater;
            }).length;
            
            document.getElementById('dashTotalEmployees').textContent = total;
            document.getElementById('dashActiveEmployees').textContent = active;
            document.getElementById('dashResignedEmployees').textContent = resigned;
            document.getElementById('dashUpcomingEducation').textContent = upcoming;
        }

        // ============================
        // ì§ì›ê´€ë¦¬
        // ============================
        function loadEmployees() {
            renderEmployeeTable(employees);
        }

        function renderEmployeeTable(employeeList) {
            const tbody = document.getElementById('employeeTableBody');
            
            if (employeeList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 40px; color: #7f8c8d;">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            tbody.innerHTML = employeeList.map(emp => {
                const isActive = !emp.resignDate || new Date(emp.resignDate) > new Date();
                const certCount = emp.certificates ? emp.certificates.length : 0;
                
                return `
                    <tr>
                        <td><strong>${emp.name}</strong></td>
                        <td>${emp.gender || '-'}</td>
                        <td>${emp.phone || '-'}</td>
                        <td>${emp.email || '-'}</td>
                        <td>${certCount}ê°œ</td>
                        <td>${emp.hireDate || '-'}</td>
                        <td>
                            <span class="badge ${isActive ? 'badge-success' : 'badge-secondary'}">
                                ${isActive ? 'ì¬ì§' : 'í‡´ì‚¬'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="showEmployeeDetail('${emp.id}')">ìƒì„¸</button>
                            <button class="btn btn-success btn-small" onclick="openEmployeeModal('${emp.id}')">ìˆ˜ì •</button>
                            <button class="btn btn-danger btn-small" onclick="deleteEmployee('${emp.id}')">ì‚­ì œ</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function searchEmployees() {
            const query = document.getElementById('employeeSearch').value.toLowerCase();
            const filtered = employees.filter(emp => 
                emp.name.toLowerCase().includes(query) ||
                (emp.email && emp.email.toLowerCase().includes(query)) ||
                (emp.phone && emp.phone.includes(query))
            );
            renderEmployeeTable(filtered);
        }

        function openEmployeeModal(employeeId = null) {
            const modal = document.getElementById('employeeModal');
            const title = document.getElementById('employeeModalTitle');
            const container = document.getElementById('certificatesContainer');
            
            // ì´ˆê¸°í™”
            document.getElementById('employeeId').value = '';
            document.getElementById('employeeName').value = '';
            document.getElementById('employeeGender').value = '';
            document.getElementById('employeeAddress').value = '';
            document.getElementById('employeePhone').value = '';
            document.getElementById('employeeEmail').value = '';
            document.getElementById('employeeHireDate').value = '';
            document.getElementById('employeeResignDate').value = '';
            container.innerHTML = '';
            certIdCounter = 1;
            
            if (employeeId) {
                const emp = employees.find(e => e.id === employeeId);
                if (emp) {
                    title.textContent = 'ì§ì› ì •ë³´ ìˆ˜ì •';
                    document.getElementById('employeeId').value = emp.id;
                    document.getElementById('employeeName').value = emp.name || '';
                    document.getElementById('employeeGender').value = emp.gender || '';
                    document.getElementById('employeeAddress').value = emp.address || '';
                    document.getElementById('employeePhone').value = emp.phone || '';
                    document.getElementById('employeeEmail').value = emp.email || '';
                    document.getElementById('employeeHireDate').value = emp.hireDate || '';
                    document.getElementById('employeeResignDate').value = emp.resignDate || '';
                    
                    if (emp.certificates && emp.certificates.length > 0) {
                        emp.certificates.forEach(cert => addCertificateField(cert));
                    }
                }
            } else {
                title.textContent = 'ì§ì› ë“±ë¡';
            }
            
            modal.classList.add('active');
        }

        function closeEmployeeModal() {
            document.getElementById('employeeModal').classList.remove('active');
        }

        function addCertificateField(certData = null) {
            const container = document.getElementById('certificatesContainer');
            const certId = certIdCounter++;
            
            const certDiv = document.createElement('div');
            certDiv.className = 'certificate-card';
            certDiv.id = `cert-${certId}`;
            
            certDiv.innerHTML = `
                <div class="certificate-header">
                    <strong>ìê²©ì¦ ${certId}</strong>
                    <button type="button" class="remove-cert-btn" onclick="removeCertificateField(${certId})">ì‚­ì œ</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ìê²©ì¦ëª…</label>
                        <input type="text" class="cert-name" value="${certData?.name || ''}">
                    </div>
                    <div class="form-group">
                        <label>ì·¨ë“ì¼</label>
                        <input type="date" class="cert-date" value="${certData?.date || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>êµìœ¡ ì¼ì •</label>
                    <div class="form-row">
                        <div class="form-group">
                            <label style="font-size: 0.85em;">ì´ˆê¸‰êµìœ¡</label>
                            <input type="date" class="cert-edu-basic" value="${certData?.education?.basic || ''}">
                        </div>
                        <div class="form-group">
                            <label style="font-size: 0.85em;">ì¤‘ê¸‰êµìœ¡</label>
                            <input type="date" class="cert-edu-intermediate" value="${certData?.education?.intermediate || ''}">
                        </div>
                        <div class="form-group">
                            <label style="font-size: 0.85em;">ê³ ê¸‰êµìœ¡</label>
                            <input type="date" class="cert-edu-advanced" value="${certData?.education?.advanced || ''}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label style="font-size: 0.85em;">íŠ¹ê¸‰êµìœ¡</label>
                            <input type="date" class="cert-edu-expert" value="${certData?.education?.expert || ''}">
                        </div>
                        <div class="form-group">
                            <label style="font-size: 0.85em;">í‰ê°€ì‚¬êµìœ¡</label>
                            <input type="date" class="cert-edu-evaluator" value="${certData?.education?.evaluator || ''}">
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(certDiv);
        }

        function removeCertificateField(certId) {
            const certDiv = document.getElementById(`cert-${certId}`);
            if (certDiv) certDiv.remove();
        }

        async function saveEmployee(event) {
            event.preventDefault();
            
            const id = document.getElementById('employeeId').value;
            const certificates = [];
            
            document.querySelectorAll('.certificate-card').forEach(card => {
                const name = card.querySelector('.cert-name').value;
                const date = card.querySelector('.cert-date').value;
                
                if (name && date) {
                    certificates.push({
                        name: name,
                        date: date,
                        education: {
                            basic: card.querySelector('.cert-edu-basic').value,
                            intermediate: card.querySelector('.cert-edu-intermediate').value,
                            advanced: card.querySelector('.cert-edu-advanced').value,
                            expert: card.querySelector('.cert-edu-expert').value,
                            evaluator: card.querySelector('.cert-edu-evaluator').value
                        }
                    });
                }
            });
            
            const employee = {
                id: id || String(Date.now()),
                name: document.getElementById('employeeName').value,
                gender: document.getElementById('employeeGender').value,
                address: document.getElementById('employeeAddress').value,
                phone: document.getElementById('employeePhone').value,
                email: document.getElementById('employeeEmail').value,
                hireDate: document.getElementById('employeeHireDate').value,
                resignDate: document.getElementById('employeeResignDate').value,
                certificates: certificates,
                updatedAt: new Date().toISOString()
            };
            
            showLoading(true);
            try {
                if (id) {
                    // ìˆ˜ì •
                    const index = employees.findIndex(e => e.id === id);
                    employees[index] = employee;
                    
                    // ê¸°ì¡´ êµìœ¡ ì¼ì • ì‚­ì œ
                    educations = educations.filter(edu => edu.employeeId !== employee.id);
                    await fbReplaceAll('educations', educations, 'id');
                } else {
                    // ì‹ ê·œ ë“±ë¡
                    employees.push(employee);
                    
                    // ì—°ì°¨ ê³„ì‚°
                    await calculateAnnualLeaveForEmployee(employee);
                }
                
                // Firebase ì €ì¥
                await fbSet('employees', employee.id, employee);
                
                // êµìœ¡ ì¼ì • ìƒì„±
                await generateEducationSchedule(employee);
                
                await loadAllFromFirebase();
                
                closeEmployeeModal();
                showNotification('âœ… ì§ì› ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                showLoading(false);
            } catch (error) {
                showNotification('âŒ ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
                showLoading(false);
            }
        }

        async function deleteEmployee(id) {
            if (!confirm('ì´ ì§ì› ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì—°ì°¨ ë° êµìœ¡ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)')) {
                return;
            }
            
            showLoading(true);
            try {
                await fbDel('employees', id);
                
                // ì—°ê´€ ë°ì´í„° ì‚­ì œ
                const leavesToDelete = annualLeaves.filter(a => a.employeeId === id);
                for (const leave of leavesToDelete) {
                    await fbDel('annualLeaves', leave.id);
                }
                
                const educationsToDelete = educations.filter(e => e.employeeId === id);
                for (const edu of educationsToDelete) {
                    await fbDel('educations', edu.id);
                }
                
                await loadAllFromFirebase();
                
                showNotification('âœ… ì§ì› ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                showLoading(false);
            } catch (error) {
                showNotification('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
                showLoading(false);
            }
        }

        function showEmployeeDetail(employeeId) {
            const emp = employees.find(e => e.id === employeeId);
            if (!emp) return;
            
            const isActive = !emp.resignDate || new Date(emp.resignDate) > new Date();
            
            let certHtml = '';
            if (emp.certificates && emp.certificates.length > 0) {
                certHtml = emp.certificates.map((cert, idx) => `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <h4 style="margin-bottom: 10px; color: #2c3e50;">${idx + 1}. ${cert.name}</h4>
                        <p><strong>ì·¨ë“ì¼:</strong> ${cert.date}</p>
                        ${cert.education ? `
                            <div style="margin-top: 10px;">
                                <strong>êµìœ¡ ì¼ì •:</strong>
                                <ul style="margin: 5px 0 0 20px;">
                                    ${cert.education.basic ? `<li>ì´ˆê¸‰: ${cert.education.basic}</li>` : ''}
                                    ${cert.education.intermediate ? `<li>ì¤‘ê¸‰: ${cert.education.intermediate}</li>` : ''}
                                    ${cert.education.advanced ? `<li>ê³ ê¸‰: ${cert.education.advanced}</li>` : ''}
                                    ${cert.education.expert ? `<li>íŠ¹ê¸‰: ${cert.education.expert}</li>` : ''}
                                    ${cert.education.evaluator ? `<li>í‰ê°€ì‚¬: ${cert.education.evaluator}</li>` : ''}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } else {
                certHtml = '<p style="color: #7f8c8d;">ë“±ë¡ëœ ìê²©ì¦ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
            
            document.getElementById('employeeDetailContent').innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">ê¸°ë³¸ ì •ë³´</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div><strong>ì„±ëª…:</strong> ${emp.name}</div>
                        <div><strong>ì„±ë³„:</strong> ${emp.gender || '-'}</div>
                        <div><strong>ì „í™”ë²ˆí˜¸:</strong> ${emp.phone || '-'}</div>
                        <div><strong>ì´ë©”ì¼:</strong> ${emp.email || '-'}</div>
                        <div><strong>ì…ì‚¬ì¼:</strong> ${emp.hireDate || '-'}</div>
                        <div><strong>í‡´ì‚¬ì¼:</strong> ${emp.resignDate || '-'}</div>
                        <div><strong>ìƒíƒœ:</strong> <span class="badge ${isActive ? 'badge-success' : 'badge-secondary'}">${isActive ? 'ì¬ì§' : 'í‡´ì‚¬'}</span></div>
                    </div>
                    ${emp.address ? `<div style="margin-top: 10px;"><strong>ì£¼ì†Œ:</strong> ${emp.address}</div>` : ''}
                </div>
                
                <div>
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">ìê²©ì¦ ì •ë³´</h3>
                    ${certHtml}
                </div>
            `;
            
            document.getElementById('employeeDetailModal').classList.add('active');
        }

        function closeEmployeeDetailModal() {
            document.getElementById('employeeDetailModal').classList.remove('active');
        }

        // ============================
        // ì—°ì°¨ê´€ë¦¬
        // ============================
        function loadAnnualLeave() {
            const activeEmployees = employees.filter(e => !e.resignDate || new Date(e.resignDate) > new Date());
            const tbody = document.getElementById('annualLeaveTableBody');
            
            if (activeEmployees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 40px; color: #7f8c8d;">ì¬ì§ ì¤‘ì¸ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            tbody.innerHTML = activeEmployees.map(emp => {
                let leave = annualLeaves.find(a => a.employeeId === emp.id);
                if (!leave) {
                    leave = {
                        totalDays: 0,
                        usedDays: 0,
                        yearsOfService: 0
                    };
                }
                
                const remaining = leave.totalDays - leave.usedDays;
                
                return `
                    <tr>
                        <td><strong>${emp.name}</strong></td>
                        <td>${emp.hireDate || '-'}</td>
                        <td>${leave.yearsOfService || 0}ë…„</td>
                        <td>${leave.totalDays || 0}ì¼</td>
                        <td style="color: #e74c3c; font-weight: 600;">${leave.usedDays || 0}ì¼</td>
                        <td style="color: #27ae60; font-weight: 600;">${remaining}ì¼</td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="openAnnualLeaveModal('${emp.id}')">ì‚¬ìš©ë“±ë¡</button>
                            <button class="btn btn-success btn-small" onclick="showAnnualLeaveHistory('${emp.id}')">ì‚¬ìš©ë‚´ì—­</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function calculateAnnualLeaveForEmployee(employee) {
            const fiscalYear = parseInt(document.getElementById('fiscalYear').value);
            const fiscalYearEnd = new Date(fiscalYear, 11, 31);
            const hireDate = new Date(employee.hireDate);
            
            const diffTime = fiscalYearEnd - hireDate;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);
            const yearsOfService = Math.floor(diffDays / 365.25);
            
            let totalDays = 0;
            if (yearsOfService < 1) {
                totalDays = 12;
            } else {
                totalDays = 15;
                if (yearsOfService >= 3) {
                    const additionalYears = Math.floor((yearsOfService - 1) / 2);
                    totalDays += additionalYears;
                    if (totalDays > 25) totalDays = 25;
                }
            }
            
            const existingLeave = annualLeaves.find(a => a.employeeId === employee.id);
            
            if (existingLeave) {
                existingLeave.fiscalYear = fiscalYear;
                existingLeave.totalDays = totalDays;
                existingLeave.yearsOfService = yearsOfService;
                existingLeave.updatedAt = new Date().toISOString();
                
                await fbSet('annualLeaves', existingLeave.id, existingLeave);
            } else {
                const newLeave = {
                    id: `leave_${employee.id}_${fiscalYear}`,
                    employeeId: employee.id,
                    fiscalYear: fiscalYear,
                    totalDays: totalDays,
                    usedDays: 0,
                    yearsOfService: yearsOfService,
                    usageHistory: [],
                    createdAt: new Date().toISOString()
                };
                
                annualLeaves.push(newLeave);
                await fbSet('annualLeaves', newLeave.id, newLeave);
            }
        }

        async function calculateAllAnnualLeave() {
            if (!confirm('ëª¨ë“  ì§ì›ì˜ ì—°ì°¨ë¥¼ ì¬ê³„ì‚°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            showLoading(true);
            try {
                const activeEmployees = employees.filter(e => !e.resignDate || new Date(e.resignDate) > new Date());
                
                for (const emp of activeEmployees) {
                    await calculateAnnualLeaveForEmployee(emp);
                }
                
                await loadAllFromFirebase();
                showNotification('âœ… ì—°ì°¨ê°€ ì¬ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                showLoading(false);
            } catch (error) {
                showNotification('âŒ ì¬ê³„ì‚° ì‹¤íŒ¨: ' + error.message, 'error');
                showLoading(false);
            }
        }

        function openAnnualLeaveModal(employeeId) {
            const emp = employees.find(e => e.id === employeeId);
            const leave = annualLeaves.find(a => a.employeeId === employeeId);
            
            if (!emp || !leave) {
                showNotification('âŒ ì§ì› ë˜ëŠ” ì—°ì°¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            document.getElementById('leaveEmployeeId').value = employeeId;
            document.getElementById('leaveEmployeeName').value = emp.name;
            document.getElementById('leaveTotalDays').textContent = leave.totalDays + 'ì¼';
            document.getElementById('leaveUsedDays').textContent = leave.usedDays + 'ì¼';
            document.getElementById('leaveRemainingDays').textContent = (leave.totalDays - leave.usedDays) + 'ì¼';
            
            document.getElementById('leaveUsageDays').value = '';
            document.getElementById('leaveUsageDate').value = '';
            document.getElementById('leaveUsageReason').value = '';
            
            document.getElementById('annualLeaveModal').classList.add('active');
        }

        function closeAnnualLeaveModal() {
            document.getElementById('annualLeaveModal').classList.remove('active');
        }

        async function saveAnnualLeaveUsage(event) {
            event.preventDefault();
            
            const employeeId = document.getElementById('leaveEmployeeId').value;
            const usageDays = parseFloat(document.getElementById('leaveUsageDays').value);
            const usageDate = document.getElementById('leaveUsageDate').value;
            const reason = document.getElementById('leaveUsageReason').value;
            
            const leave = annualLeaves.find(a => a.employeeId === employeeId);
            if (!leave) {
                showNotification('âŒ ì—°ì°¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            const remaining = leave.totalDays - leave.usedDays;
            if (usageDays > remaining) {
                showNotification(`âŒ ì”ì—¬ ì—°ì°¨(${remaining}ì¼)ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.`, 'error');
                return;
            }
            
            showLoading(true);
            try {
                leave.usedDays += usageDays;
                
                if (!leave.usageHistory) leave.usageHistory = [];
                leave.usageHistory.push({
                    date: usageDate,
                    days: usageDays,
                    reason: reason,
                    recordDate: new Date().toISOString()
                });
                
                leave.updatedAt = new Date().toISOString();
                
                await fbSet('annualLeaves', leave.id, leave);
                await loadAllFromFirebase();
                
                closeAnnualLeaveModal();
                showNotification('âœ… ì—°ì°¨ ì‚¬ìš©ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                showLoading(false);
            } catch (error) {
                showNotification('âŒ ë“±ë¡ ì‹¤íŒ¨: ' + error.message, 'error');
                showLoading(false);
            }
        }

        function showAnnualLeaveHistory(employeeId) {
            const emp = employees.find(e => e.id === employeeId);
            const leave = annualLeaves.find(a => a.employeeId === employeeId);
            
            if (!emp || !leave) {
                showNotification('âŒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            const history = leave.usageHistory || [];
            
            let historyHtml = '';
            if (history.length === 0) {
                historyHtml = '<p style="text-align:center; padding: 40px; color: #7f8c8d;">ì‚¬ìš© ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                historyHtml = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #34495e; color: white;">
                                <th style="padding: 12px;">ì‚¬ìš©ì¼</th>
                                <th style="padding: 12px;">ì¼ìˆ˜</th>
                                <th style="padding: 12px;">ì‚¬ìœ </th>
                                <th style="padding: 12px;">ë“±ë¡ì¼</th>
                                <th style="padding: 12px;">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${history.map((h, idx) => `
                                <tr style="border-bottom: 1px solid #ecf0f1;">
                                    <td style="padding: 12px;">${h.date}</td>
                                    <td style="padding: 12px; font-weight: 600;">${h.days}ì¼</td>
                                    <td style="padding: 12px;">${h.reason || '-'}</td>
                                    <td style="padding: 12px; font-size: 0.85em; color: #7f8c8d;">${new Date(h.recordDate).toLocaleString('ko-KR')}</td>
                                    <td style="padding: 12px;">
                                        <button class="btn btn-danger btn-small" onclick="deleteLeaveHistory('${employeeId}', ${idx})">ì‚­ì œ</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            document.getElementById('annualLeaveHistoryContent').innerHTML = `
                <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px;">${emp.name}ë‹˜ì˜ ì—°ì°¨ í˜„í™©</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div>
                            <small style="color: #7f8c8d;">ì´ ì—°ì°¨</small>
                            <div style="font-size: 1.3em; font-weight: 600;">${leave.totalDays}ì¼</div>
                        </div>
                        <div>
                            <small style="color: #7f8c8d;">ì‚¬ìš© ì—°ì°¨</small>
                            <div style="font-size: 1.3em; font-weight: 600; color: #e74c3c;">${leave.usedDays}ì¼</div>
                        </div>
                        <div>
                            <small style="color: #7f8c8d;">ì”ì—¬ ì—°ì°¨</small>
                            <div style="font-size: 1.3em; font-weight: 600; color: #27ae60;">${leave.totalDays - leave.usedDays}ì¼</div>
                        </div>
                    </div>
                </div>
                ${historyHtml}
            `;
            
            document.getElementById('annualLeaveHistoryModal').classList.add('active');
        }

        function closeAnnualLeaveHistoryModal() {
            document.getElementById('annualLeaveHistoryModal').classList.remove('active');
        }

        async function deleteLeaveHistory(employeeId, historyIndex) {
            if (!confirm('ì´ ì—°ì°¨ ì‚¬ìš© ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            showLoading(true);
            try {
                const leave = annualLeaves.find(a => a.employeeId === employeeId);
                if (!leave) throw new Error('ì—°ì°¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                
                const deletedHistory = leave.usageHistory[historyIndex];
                leave.usedDays -= deletedHistory.days;
                leave.usageHistory.splice(historyIndex, 1);
                leave.updatedAt = new Date().toISOString();
                
                await fbSet('annualLeaves', leave.id, leave);
                await loadAllFromFirebase();
                
                showAnnualLeaveHistory(employeeId);
                showNotification('âœ… ë‚´ì—­ì´ ì‚­ì œë˜ê³  ì—°ì°¨ê°€ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                showLoading(false);
            } catch (error) {
                showNotification('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
                showLoading(false);
            }
        }

        function openBulkLeaveModal() {
            document.getElementById('bulkLeaveDays').value = '';
            document.getElementById('bulkLeaveDate').value = '';
            document.getElementById('bulkLeaveReason').value = '';
            document.getElementById('bulkLeavePreviewContent').innerHTML = '<p style="color: #7f8c8d;">ì‚¬ìš© ì¼ìˆ˜ë¥¼ ì…ë ¥í•˜ë©´ ì ìš© ëŒ€ìƒì´ í‘œì‹œë©ë‹ˆë‹¤.</p>';
            
            document.getElementById('bulkLeaveModal').classList.add('active');
        }

        function closeBulkLeaveModal() {
            document.getElementById('bulkLeaveModal').classList.remove('active');
        }

        function updateBulkLeavePreview() {
            const days = parseFloat(document.getElementById('bulkLeaveDays').value);
            if (!days || days <= 0) {
                document.getElementById('bulkLeavePreviewContent').innerHTML = '<p style="color: #7f8c8d;">ì‚¬ìš© ì¼ìˆ˜ë¥¼ ì…ë ¥í•˜ë©´ ì ìš© ëŒ€ìƒì´ í‘œì‹œë©ë‹ˆë‹¤.</p>';
                return;
            }
            
            const activeEmployees = employees.filter(e => !e.resignDate || new Date(e.resignDate) > new Date());
            const applicable = [];
            const excluded = [];
            
            activeEmployees.forEach(emp => {
                const leave = annualLeaves.find(a => a.employeeId === emp.id);
                if (leave) {
                    const remaining = leave.totalDays - leave.usedDays;
                    if (remaining >= days) {
                        applicable.push(emp.name);
                    } else {
                        excluded.push(`${emp.name} (ì”ì—¬: ${remaining}ì¼)`);
                    }
                }
            });
            
            document.getElementById('bulkLeavePreviewContent').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong style="color: #27ae60;">âœ… ì ìš© ëŒ€ìƒ (${applicable.length}ëª…)</strong>
                    <div style="margin-top: 5px; color: #2c3e50;">${applicable.join(', ') || 'ì—†ìŒ'}</div>
                </div>
                ${excluded.length > 0 ? `
                    <div>
                        <strong style="color: #e74c3c;">âŒ ì œì™¸ ëŒ€ìƒ (${excluded.length}ëª…)</strong>
                        <div style="margin-top: 5px; color: #7f8c8d; font-size: 0.9em;">${excluded.join(', ')}</div>
                    </div>
                ` : ''}
            `;
        }

        async function saveBulkLeave(event) {
            event.preventDefault();
            
            const days = parseFloat(document.getElementById('bulkLeaveDays').value);
            const date = document.getElementById('bulkLeaveDate').value;
            const reason = document.getElementById('bulkLeaveReason').value;
            
            if (!confirm(`${days}ì¼ì˜ ì—°ì°¨ë¥¼ ì¬ì§ ì¤‘ì¸ ëª¨ë“  ì§ì›ì—ê²Œ ì¼ê´„ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            showLoading(true);
            try {
                const activeEmployees = employees.filter(e => !e.resignDate || new Date(e.resignDate) > new Date());
                let successCount = 0;
                let skipCount = 0;
                
                for (const emp of activeEmployees) {
                    const leave = annualLeaves.find(a => a.employeeId === emp.id);
                    if (leave) {
                        const remaining = leave.totalDays - leave.usedDays;
                        if (remaining >= days) {
                            leave.usedDays += days;
                            if (!leave.usageHistory) leave.usageHistory = [];
                            leave.usageHistory.push({
                                date: date,
                                days: days,
                                reason: reason,
                                isBulk: true,
                                recordDate: new Date().toISOString()
                            });
                            leave.updatedAt = new Date().toISOString();
                            
                            await fbSet('annualLeaves', leave.id, leave);
                            successCount++;
                        } else {
                            skipCount++;
                        }
                    }
                }
                
                await loadAllFromFirebase();
                closeBulkLeaveModal();
                showNotification(`âœ… ì¼ê´„ ì—°ì°¨ ì ìš© ì™„ë£Œ\nì ìš©: ${successCount}ëª… / ì œì™¸: ${skipCount}ëª…`, 'success');
                showLoading(false);
            } catch (error) {
                showNotification('âŒ ì¼ê´„ ì ìš© ì‹¤íŒ¨: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // ============================
        // ì§ë¬´êµìœ¡
        // ============================
        async function generateEducationSchedule(employee) {
            if (!employee.certificates || employee.certificates.length === 0) return;
            
            const newEducations = [];
            
            for (const cert of employee.certificates) {
                const eduTypes = [
                    { key: 'basic', label: 'ì´ˆê¸‰êµìœ¡' },
                    { key: 'intermediate', label: 'ì¤‘ê¸‰êµìœ¡' },
                    { key: 'advanced', label: 'ê³ ê¸‰êµìœ¡' },
                    { key: 'expert', label: 'íŠ¹ê¸‰êµìœ¡' },
                    { key: 'evaluator', label: 'í‰ê°€ì‚¬êµìœ¡' }
                ];
                
                for (const type of eduTypes) {
                    if (cert.education && cert.education[type.key]) {
                        const edu = {
                            id: `edu_${employee.id}_${cert.name}_${type.key}_${Date.now()}`,
                            employeeId: employee.id,
                            employeeName: employee.name,
                            certificate: cert.name,
                            certificateDate: cert.date,
                            type: type.label,
                            educationDate: cert.education[type.key],
                            createdAt: new Date().toISOString()
                        };
                        
                        newEducations.push(edu);
                        educations.push(edu);
                    }
                }
            }
            
            // Firebase ì €ì¥
            for (const edu of newEducations) {
                await fbSet('educations', edu.id, edu);
            }
        }

        function loadEducation() {
            const tbody = document.getElementById('educationTableBody');
            
            if (educations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 40px; color: #7f8c8d;">êµìœ¡ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            // D-Day ìˆœìœ¼ë¡œ ì •ë ¬
            const sorted = [...educations].sort((a, b) => {
                const dateA = new Date(a.educationDate);
                const dateB = new Date(b.educationDate);
                const now = new Date();
                const diffA = Math.abs(dateA - now);
                const diffB = Math.abs(dateB - now);
                return diffA - diffB;
            });
            
            tbody.innerHTML = sorted.map(edu => {
                const eduDate = new Date(edu.educationDate);
                const today = new Date();
                const diffTime = eduDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let statusBadge = '';
                let dDayText = '';
                
                if (diffDays < 0) {
                    statusBadge = '<span class="badge badge-secondary">ì™„ë£Œ</span>';
                    dDayText = `D+${Math.abs(diffDays)}`;
                } else if (diffDays === 0) {
                    statusBadge = '<span class="badge badge-danger">D-Day</span>';
                    dDayText = 'D-Day';
                } else if (diffDays <= 30) {
                    statusBadge = '<span class="badge badge-warning">ì„ë°•</span>';
                    dDayText = `D-${diffDays}`;
                } else {
                    statusBadge = '<span class="badge badge-info">ì˜ˆì •</span>';
                    dDayText = `D-${diffDays}`;
                }
                
                return `
                    <tr>
                        <td><strong>${edu.employeeName}</strong></td>
                        <td>${edu.certificate}</td>
                        <td>${edu.certificateDate}</td>
                        <td>${edu.type}</td>
                        <td>${edu.educationDate}</td>
                        <td style="font-weight: 600; color: ${diffDays <= 30 && diffDays >= 0 ? '#e74c3c' : '#7f8c8d'};">${dDayText}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        // ============================
        // ë°±ì—…ê´€ë¦¬
        // ============================
        async function downloadBackup() {
            showLoading(true);
            try {
                // ìµœì‹  ë°ì´í„° ë¡œë“œ
                await loadAllFromFirebase();
                
                const today = new Date();
                const dateString = today.getFullYear() + 
                    String(today.getMonth() + 1).padStart(2, '0') + 
                    String(today.getDate()).padStart(2, '0') + '_' +
                    String(today.getHours()).padStart(2, '0') + 
                    String(today.getMinutes()).padStart(2, '0');
                
                const users = await fbGetAll('sysUsers');
                
                const backupData = {
                    version: '1.0',
                    backupDate: today.toISOString(),
                    firebaseProject: FB_PROJ,
                    employees: employees,
                    annualLeaves: annualLeaves,
                    educations: educations,
                    sysUsers: users
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `ì§ì›ê´€ë¦¬ì‹œìŠ¤í…œ_Firebaseë°±ì—…_${dateString}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`âœ… ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\níŒŒì¼ëª…: ì§ì›ê´€ë¦¬ì‹œìŠ¤í…œ_Firebaseë°±ì—…_${dateString}.json`, 'success');
                showLoading(false);
            } catch (error) {
                showNotification('âŒ ë°±ì—… ì‹¤íŒ¨: ' + error.message, 'error');
                showLoading(false);
            }
        }

        async function restoreBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('âš ï¸ ë°±ì—…ì„ ë³µì›í•˜ë©´ Firebaseì˜ í˜„ì¬ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                showLoading(true);
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (!backupData.employees || !Array.isArray(backupData.employees)) {
                        throw new Error('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
                    }
                    
                    // ëª¨ë“  ì»¬ë ‰ì…˜ êµì²´
                    await fbReplaceAll('employees', backupData.employees, 'id');
                    await fbReplaceAll('annualLeaves', backupData.annualLeaves || [], 'id');
                    await fbReplaceAll('educations', backupData.educations || [], 'id');
                    
                    if (backupData.sysUsers) {
                        await fbReplaceAll('sysUsers', backupData.sysUsers, 'id');
                    }
                    
                    await loadAllFromFirebase();
                    
                    showNotification(`âœ… ë°±ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!\nì§ì›: ${backupData.employees.length}ëª…`, 'success');
                    showLoading(false);
                } catch (error) {
                    showNotification('âŒ ë°±ì—… ë³µì› ì‹¤íŒ¨: ' + error.message, 'error');
                    showLoading(false);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function updateBackupInfo() {
            document.getElementById('backupEmployeeCount').textContent = employees.length + 'ëª…';
            document.getElementById('backupLeaveCount').textContent = annualLeaves.length + 'ê±´';
            document.getElementById('backupEducationCount').textContent = educations.length + 'ê±´';
            
            const lastUpdateElem = document.getElementById('lastUpdate');
            if (employees.length > 0 || annualLeaves.length > 0 || educations.length > 0) {
                lastUpdateElem.textContent = new Date().toLocaleString('ko-KR');
            } else {
                lastUpdateElem.textContent = 'ë°ì´í„° ì—†ìŒ';
            }
        }

        // ============================
        // ê´€ë¦¬ì íŒ¨ë„
        // ============================
        async function loadAdminPanel() {
            showLoading(true);
            try {
                const users = await fbGetAll('sysUsers');
                const pending = users.filter(u => u.status === 'pending');
                const pendingEl = document.getElementById('pendingUsersList');
                
                if (pending.length === 0) {
                    pendingEl.innerHTML = '<p style="color:#856404; font-style:italic;">ëŒ€ê¸° ì¤‘ì¸ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    pendingEl.innerHTML = pending.map(u => `
                        <div class="pending-user-item">
                            <div class="user-detail">
                                <strong>${u.name}</strong> <span>(${u.id})</span>
                                <span style="font-size:0.8em; color:#aaa;">${new Date(u.createdAt).toLocaleDateString('ko-KR')} ì‹ ì²­</span>
                            </div>
                            <div style="display:flex; gap:8px;">
                                <button class="btn btn-success btn-small" onclick="approveUser('${u.id}')">ìŠ¹ì¸</button>
                                <button class="btn btn-danger btn-small" onclick="rejectUser('${u.id}')">ê±°ì ˆ</button>
                            </div>
                        </div>
                    `).join('');
                }
                
                const allEl = document.getElementById('allUsersList');
                const all = users.filter(u => u.role !== 'admin');
                
                if (all.length === 0) {
                    allEl.innerHTML = '<p style="color:#7f8c8d; font-style:italic;">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    allEl.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #34495e; color: white;">
                                    <th style="padding: 12px;">ì´ë¦„</th>
                                    <th style="padding: 12px;">ì•„ì´ë””</th>
                                    <th style="padding: 12px;">ê°€ì…ì¼</th>
                                    <th style="padding: 12px;">ìƒíƒœ</th>
                                    <th style="padding: 12px;">ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${all.map(u => `
                                    <tr style="border-bottom: 1px solid #ecf0f1;">
                                        <td style="padding: 12px;"><strong>${u.name}</strong></td>
                                        <td style="padding: 12px;">${u.id}</td>
                                        <td style="padding: 12px; font-size: 0.85em; color: #7f8c8d;">${new Date(u.createdAt).toLocaleDateString('ko-KR')}</td>
                                        <td style="padding: 12px;">
                                            ${u.status === 'approved' ? '<span class="badge badge-success">ìŠ¹ì¸ë¨</span>' : 
                                              u.status === 'pending' ? '<span class="badge badge-warning">ëŒ€ê¸°ì¤‘</span>' : 
                                              '<span class="badge badge-danger">ê±°ì ˆë¨</span>'}
                                        </td>
                                        <td style="padding: 12px;">
                                            ${u.status === 'pending' ? `<button class="btn btn-success btn-small" onclick="approveUser('${u.id}')">ìŠ¹ì¸</button>` : ''}
                                            <button class="btn btn-danger btn-small" onclick="deleteUser('${u.id}')">ì‚­ì œ</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
                
                showLoading(false);
            } catch (error) {
                showNotification('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
                showLoading(false);
            }
        }

        async function approveUser(userId) {
            if (!confirm('ì´ ì‚¬ìš©ìë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            showLoading(true);
            try {
                const users = await fbGetAll('sysUsers');
                const user = users.find(u => u.id === userId);
                
                if (user) {
                    user.status = 'approved';
                    user.approvedAt = new Date().toISOString();
                    await fbSet('sysUsers', userId, user);
                    
                    await loadAdminPanel();
                    showNotification(`âœ… ${user.name}ë‹˜ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                }
                
                showLoading(false);
            } catch (error) {
                showNotification('âŒ ìŠ¹ì¸ ì‹¤íŒ¨: ' + error.message, 'error');
                showLoading(false);
            }
        }

        async function rejectUser(userId) {
            if (!confirm('ì´ ì‚¬ìš©ìì˜ ê°€ì…ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            showLoading(true);
            try {
                const users = await fbGetAll('sysUsers');
                const user = users.find(u => u.id === userId);
                
                if (user) {
                    user.status = 'rejected';
                    user.rejectedAt = new Date().toISOString();
                    await fbSet('sysUsers', userId, user);
                    
                    await loadAdminPanel();
                    showNotification(`âŒ ${user.name}ë‹˜ì˜ ê°€ì…ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                }
                
                showLoading(false);
            } catch (error) {
                showNotification('âŒ ê±°ì ˆ ì²˜ë¦¬ ì‹¤íŒ¨: ' + error.message, 'error');
                showLoading(false);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            showLoading(true);
            try {
                await fbDel('sysUsers', userId);
                await loadAdminPanel();
                showNotification('âœ… ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                showLoading(false);
            } catch (error) {
                showNotification('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
                showLoading(false);
            }
        }

        async function updateAdminAccount() {
            const newId = document.getElementById('newAdminId').value.trim();
            const currentPw = document.getElementById('currentAdminPw').value;
            const newPw = document.getElementById('newAdminPw').value;
            const newPw2 = document.getElementById('newAdminPw2').value;
            
            if (!currentPw) {
                showNotification('âŒ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }
            
            showLoading(true);
            try {
                const users = await fbGetAll('sysUsers');
                const admin = users.find(u => u.role === 'admin');
                
                if (!admin || admin.pw !== currentPw) {
                    showNotification('âŒ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                    showLoading(false);
                    return;
                }
                
                let updated = false;
                
                if (newId && newId !== admin.id) {
                    if (newId.length < 4) {
                        showNotification('âŒ ì•„ì´ë””ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                        showLoading(false);
                        return;
                    }
                    
                    if (users.find(u => u.id === newId)) {
                        showNotification('âŒ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.', 'error');
                        showLoading(false);
                        return;
                    }
                    
                    await fbDel('sysUsers', admin.id);
                    admin.id = newId;
                    updated = true;
                }
                
                if (newPw) {
                    if (newPw.length < 6) {
                        showNotification('âŒ ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                        showLoading(false);
                        return;
                    }
                    
                    if (newPw !== newPw2) {
                        showNotification('âŒ ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                        showLoading(false);
                        return;
                    }
                    
                    admin.pw = newPw;
                    updated = true;
                }
                
                if (updated) {
                    admin.updatedAt = new Date().toISOString();
                    await fbSet('sysUsers', admin.id, admin);
                    
                    document.getElementById('newAdminId').value = '';
                    document.getElementById('currentAdminPw').value = '';
                    document.getElementById('newAdminPw').value = '';
                    document.getElementById('newAdminPw2').value = '';
                    
                    showNotification('âœ… ê´€ë¦¬ì ê³„ì •ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.', 'success');
                    
                    setTimeout(() => {
                        doLogout();
                    }, 2000);
                } else {
                    showNotification('âŒ ë³€ê²½í•  ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                }
                
                showLoading(false);
            } catch (error) {
                showNotification('âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // ê´€ë¦¬ì íƒ­ í™œì„±í™” ì‹œ ë°ì´í„° ë¡œë“œ
        const originalShowTab = showTab;
        showTab = function(tabName) {
            originalShowTab(tabName);
            if (tabName === 'admin' && currentUser && currentUser.role === 'admin') {
                loadAdminPanel();
            }
        };
    </script>
</body>
</html>