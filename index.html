<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§ì›ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 25px 30px;
            border-bottom: 3px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .header-left p {
            font-size: 0.95em;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .header-btn {
            padding: 10px 20px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .header-btn:hover {
            background: white;
            color: #2c3e50;
        }

        .nav-tabs {
            display: flex;
            background: #ecf0f1;
            border-bottom: 2px solid #bdc3c7;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.95em;
            font-weight: 600;
            color: #2c3e50;
            transition: all 0.3s;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background: #d5dbdb;
        }

        .nav-tab.active {
            color: #3498db;
            background: white;
            border-bottom-color: #3498db;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #ecf0f1;
            cursor: pointer;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: #3498db;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
        }

        .card h3 {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .card .icon {
            font-size: 2em;
            float: right;
            opacity: 0.3;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-info {
            background: #16a085;
            color: white;
        }

        .btn-info:hover {
            background: #138d75;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid #ecf0f1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: #34495e;
            color: white;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.9em;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-secondary {
            background: #e2e3e5;
            color: #383d41;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }

        .modal-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-header h2 {
            color: #2c3e50;
            font-size: 1.5em;
        }

        .close-modal {
            float: right;
            font-size: 1.5em;
            cursor: pointer;
            color: #7f8c8d;
            font-weight: normal;
        }

        .close-modal:hover {
            color: #2c3e50;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95em;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-left h1 {
                font-size: 1.5em;
            }

            .header-right {
                width: 100%;
            }

            .header-btn {
                flex: 1;
                justify-content: center;
            }

            .nav-tab {
                padding: 12px 15px;
                font-size: 0.85em;
            }

            .tab-content {
                padding: 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .card .number {
                font-size: 2em;
            }
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .certificate-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 3px solid #3498db;
        }

        .certificate-item h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .certificate-item .education-dates {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .certificate-item .education-dates label {
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .certificate-item .education-dates input {
            margin-top: 5px;
        }

        .add-certificate-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }

        .add-certificate-btn:hover {
            background: #229954;
        }

        .remove-certificate-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            float: right;
        }

        .detail-modal {
            max-width: 900px;
        }

        .info-section {
            margin-bottom: 25px;
        }

        .info-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .info-item label {
            font-size: 0.85em;
            color: #7f8c8d;
            display: block;
            margin-bottom: 5px;
        }

        .info-item .value {
            font-weight: 600;
            color: #2c3e50;
        }

        .annual-leave-history {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 3px solid #3498db;
        }

        .history-item .date {
            font-weight: 600;
            color: #2c3e50;
        }

        .history-item .days {
            color: #e74c3c;
            font-weight: 600;
        }

        .no-data {
            text-align: center;
            color: #7f8c8d;
            padding: 40px;
            font-style: italic;
        }

        .education-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        .education-date-item {
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .education-date-item label {
            font-size: 0.85em;
            color: #7f8c8d;
            display: block;
            margin-bottom: 5px;
        }

        .education-date-item input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .backup-info {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .backup-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .backup-info p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: #229954;
        }

        #fileInputName {
            margin-left: 15px;
            color: #7f8c8d;
            font-style: italic;
        }

        /* ===== ì¸ì¦ ì‹œìŠ¤í…œ ìŠ¤íƒ€ì¼ ===== */
        .auth-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a252f 0%, #2c3e50 50%, #2980b9 100%);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .auth-overlay.active { display: flex; }

        .auth-box {
            background: white;
            border-radius: 16px;
            padding: 44px 40px 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 24px 64px rgba(0,0,0,0.35);
            animation: authFadeIn 0.35s ease;
        }
        @keyframes authFadeIn {
            from { opacity:0; transform: translateY(-16px); }
            to   { opacity:1; transform: translateY(0); }
        }

        .auth-logo {
            font-size: 3em;
            text-align: center;
            margin-bottom: 8px;
        }

        .auth-box h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 6px;
            font-size: 1.55em;
            font-weight: 700;
        }

        .auth-box .auth-subtitle {
            text-align: center;
            color: #95a5a6;
            margin-bottom: 32px;
            font-size: 0.85em;
            letter-spacing: 0.05em;
        }

        .auth-box .form-group { margin-bottom: 18px; }
        .auth-box .form-group label {
            display: block; margin-bottom: 7px;
            font-weight: 600; color: #34495e; font-size: 0.88em;
        }
        .auth-box .form-group input {
            width: 100%; padding: 11px 14px;
            border: 1.5px solid #dfe6e9; border-radius: 8px;
            font-size: 0.95em; transition: border-color 0.2s;
            outline: none;
        }
        .auth-box .form-group input:focus { border-color: #3498db; }

        .auth-submit {
            width: 100%; padding: 13px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white; border: none; border-radius: 8px;
            font-size: 1em; font-weight: 700; cursor: pointer;
            margin-top: 6px; transition: opacity 0.2s;
            letter-spacing: 0.03em;
        }
        .auth-submit:hover   { opacity: 0.92; }
        .auth-submit:disabled { opacity: 0.55; cursor: not-allowed; }

        .auth-error {
            background: #fdecea;
            color: #c0392b;
            padding: 10px 14px;
            border-radius: 7px;
            font-size: 0.88em;
            margin-bottom: 16px;
            display: none;
            border-left: 3px solid #e74c3c;
        }
        .auth-error.visible { display: block; }

        .auth-success {
            background: #eafaf1;
            color: #1e8449;
            padding: 10px 14px;
            border-radius: 7px;
            font-size: 0.88em;
            margin-bottom: 16px;
            display: none;
            border-left: 3px solid #27ae60;
        }
        .auth-success.visible { display: block; }

        /* í—¤ë” ì‚¬ìš©ì ì •ë³´ */
        .user-info-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.88em;
        }

        .user-badge {
            background: #f39c12;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 700;
        }
        .user-badge.admin      { background: #e74c3c; }
        .user-badge.temp-admin { background: #e67e22; }

        .logout-btn {
            padding: 5px 12px;
            border: 1px solid rgba(255,255,255,0.6);
            background: transparent;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.2); }

        /* ê´€ë¦¬ì ìŠ¹ì¸ íŒ¨ë„ */
        .pending-users-section {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .pending-users-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .pending-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #f0e8c8;
        }

        .pending-user-item .user-detail {
            font-size: 0.9em;
        }

        .pending-user-item .user-detail strong { color: #2c3e50; }
        .pending-user-item .user-detail span { color: #7f8c8d; margin-left: 8px; }

        /* ì—°ì°¨ íƒ­ ì ê¸ˆ í‘œì‹œ */
        .tab-locked {
            opacity: 0.5;
            cursor: not-allowed !important;
            position: relative;
        }

        .admin-settings-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }

        /* ìƒˆë¡œê³ ì¹¨ ì•ˆë‚´ë°” */
        .refresh-bar {
            background: #e8f4f8;
            border-bottom: 1px solid #bee3f8;
            padding: 8px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.85em;
            color: #2980b9;
        }
        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .refresh-btn:hover { background: #2980b9; }
        .refresh-btn:disabled { background: #aaa; cursor: not-allowed; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            display: inline-block; width: 14px; height: 14px;
            border: 2px solid #ddd; border-top-color: #3498db;
            border-radius: 50%; animation: spin 0.6s linear infinite;
            vertical-align: middle; margin-right: 5px;
        }
        #empSaveBtn:disabled, #loginBtn:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body>

    <!-- ===== ì¸ì¦ ì˜¤ë²„ë ˆì´ ===== -->
    <div id="authOverlay" class="auth-overlay active">
        <div class="auth-box">
            <div class="auth-logo">ğŸ¢</div>
            <h2>ì§ì›ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
            <p class="auth-subtitle">Employee Management System</p>

            <div id="loginError" class="auth-error"></div>
            <div class="form-group">
                <label>ì•„ì´ë””</label>
                <input type="text" id="loginId" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="username">
            </div>
            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="current-password"
                       onkeydown="if(event.key==='Enter') doLogin()">
            </div>
            <button class="auth-submit" id="loginBtn" onclick="doLogin()">ë¡œê·¸ì¸</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>ğŸ¢ ì§ì›ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
                <p>Employee Management System</p>
            </div>
            <div class="header-right">
                <div class="user-info-bar">
                    <span id="headerUserName">-</span>
                    <span id="headerUserBadge" class="user-badge">ì¼ë°˜</span>
                    <button class="logout-btn" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
                <button class="header-btn" onclick="downloadBackup()">
                    <span>ğŸ’¾</span>
                    <span>ë°±ì—… ë‹¤ìš´ë¡œë“œ</span>
                </button>
                <button class="header-btn" onclick="document.getElementById('restoreFileInput').click()">
                    <span>ğŸ“‚</span>
                    <span>ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°</span>
                </button>
                <input type="file" id="restoreFileInput" accept=".json" style="display: none;" onchange="restoreBackup(event)">
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
            <button class="nav-tab" onclick="showTab('employees')">ğŸ‘¥ ì§ì›ê´€ë¦¬</button>
            <button class="nav-tab" id="annualLeaveTab" onclick="showAnnualLeaveTab()">ğŸ“… ì—°ì°¨ê´€ë¦¬ ğŸ”’</button>
            <button class="nav-tab" onclick="showTab('education')">ğŸ“š ì§ë¬´êµìœ¡</button>
            <button class="nav-tab" onclick="showTab('backup')">âš™ï¸ ë°±ì—…ê´€ë¦¬</button>
            <button class="nav-tab" id="adminTab" onclick="showAdminTab()" style="display:none;">ğŸ›¡ï¸ ê´€ë¦¬ì</button>
        </div>


        <!-- ìƒˆë¡œê³ ì¹¨ ì•ˆë‚´ë°” -->
        <div class="refresh-bar">
            <span>ğŸ“¡ ë°ì´í„°ëŠ” ë¡œê·¸ì¸ ì‹œ ë¡œë“œë©ë‹ˆë‹¤. ë‹¤ë¥¸ ê¸°ê¸°ì˜ ë³€ê²½ì‚¬í•­ì„ ë°˜ì˜í•˜ë ¤ë©´ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.</span>
            <button class="refresh-btn" id="refreshDataBtn" onclick="reloadAllData()">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ -->
        <div id="dashboard" class="tab-content active">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>
            <div class="dashboard">
                <div class="card" onclick="showAllEmployees()">
                    <span class="icon">ğŸ‘¥</span>
                    <h3>ì „ì²´ ì§ì›</h3>
                    <div class="number" id="totalEmployees">0</div>
                </div>
                <div class="card" onclick="showActiveEmployees()">
                    <span class="icon">âœ…</span>
                    <h3>ì¬ì§ ì§ì›</h3>
                    <div class="number" id="activeEmployees">0</div>
                </div>
                <div class="card" onclick="showInactiveEmployees()">
                    <span class="icon">ğŸ“¤</span>
                    <h3>í‡´ì‚¬ ì§ì›</h3>
                    <div class="number" id="inactiveEmployees">0</div>
                </div>
                <div class="card" onclick="showUpcomingEducation()">
                    <span class="icon">ğŸ“š</span>
                    <h3>êµìœ¡ ì˜ˆì • (6ê°œì›”)</h3>
                    <div class="number" id="upcomingEducation">0</div>
                </div>
            </div>
        </div>

        <!-- ì§ì›ê´€ë¦¬ -->
        <div id="employees" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">ğŸ‘¥ ì§ì›ê´€ë¦¬</h2>
            <button class="btn btn-primary" onclick="openEmployeeModal()">+ ìƒˆ ì§ì› ë“±ë¡</button>
            
            <div class="search-box" style="margin-top: 20px;">
                <input type="text" id="employeeSearch" placeholder="ğŸ” ì§ì› ê²€ìƒ‰ (ì„±ëª…, ì´ë©”ì¼, ì „í™”ë²ˆí˜¸)" onkeyup="searchEmployees()">
            </div>

            <div class="table-container">
                <table id="employeesTable">
                    <thead>
                        <tr>
                            <th>ì„±ëª…</th>
                            <th>ì„±ë³„</th>
                            <th>ì „í™”ë²ˆí˜¸</th>
                            <th>ì´ë©”ì¼</th>
                            <th>ìê²©ì¦ ìˆ˜</th>
                            <th>ì…ì‚¬ì¼</th>
                            <th>ìƒíƒœ</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="employeesTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- ì—°ì°¨ê´€ë¦¬ -->
        <div id="annual-leave" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">ğŸ“… ì—°ì°¨ê´€ë¦¬</h2>
            <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="font-weight: 600; color: #2c3e50;">íšŒê³„ë…„ë„:</label>
                    <input type="number" id="fiscalYear" value="2026" min="2020" max="2100" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; width: 100px;">
                </div>
                <button class="btn btn-primary" onclick="calculateAllAnnualLeave()">ğŸ”„ ì—°ì°¨ ì¬ê³„ì‚°</button>
                <button class="btn btn-success" onclick="openBulkLeaveModal()">ğŸ“‹ ì§ì› ì¼ê´„ì—°ì°¨</button>
                <span style="color: #7f8c8d; font-size: 0.9em;">â€» íšŒê³„ë…„ë„ ê¸°ì¤€(12ì›” 31ì¼)ìœ¼ë¡œ ì—°ì°¨ê°€ ê³„ì‚°ë©ë‹ˆë‹¤.</span>
            </div>
            
            <div class="table-container" style="margin-top: 20px;">
                <table id="annualLeaveTable">
                    <thead>
                        <tr>
                            <th>ì„±ëª…</th>
                            <th>ì…ì‚¬ì¼</th>
                            <th>ê·¼ì†ì—°ìˆ˜</th>
                            <th>ì´ ì—°ì°¨</th>
                            <th>ì‚¬ìš© ì—°ì°¨</th>
                            <th>ì”ì—¬ ì—°ì°¨</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="annualLeaveTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- ì§ë¬´êµìœ¡ -->
        <div id="education" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">ğŸ“š ì§ë¬´êµìœ¡</h2>
            <p style="color: #7f8c8d; margin-bottom: 20px;">â€» ì§ì›ì •ë³´ì˜ ìê²©ì¦ êµìœ¡ì¼ì— ë”°ë¼ ìë™ìœ¼ë¡œ êµìœ¡ì¼ì •ì´ ë“±ë¡ë©ë‹ˆë‹¤.</p>

            <div class="table-container">
                <table id="educationTable">
                    <thead>
                        <tr>
                            <th>ì„±ëª…</th>
                            <th>ìê²©ì¦</th>
                            <th>ì·¨ë“ì¼</th>
                            <th>êµìœ¡ìœ í˜•</th>
                            <th>êµìœ¡ì¼ì •</th>
                            <th>D-Day</th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody id="educationTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- ë°±ì—…ê´€ë¦¬ -->
        <div id="backup" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">âš™ï¸ ë°±ì—…ê´€ë¦¬</h2>
            
            <div class="backup-info">
                <h3>ğŸ’¾ ë°±ì—… ë‹¤ìš´ë¡œë“œ</h3>
                <p>â€¢ í˜„ì¬ ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</p>
                <p>â€¢ íŒŒì¼ëª…ì— í˜„ì¬ ë‚ ì§œê°€ ìë™ìœ¼ë¡œ í¬í•¨ë©ë‹ˆë‹¤.</p>
                <p>â€¢ ì§ì›ì •ë³´, ì—°ì°¨ì •ë³´, êµìœ¡ì¼ì •ì´ ëª¨ë‘ í¬í•¨ë©ë‹ˆë‹¤.</p>
                <button class="btn btn-primary" onclick="downloadBackup()" style="margin-top: 10px;">
                    ğŸ’¾ ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                </button>
            </div>

            <div class="backup-info" style="background: #f0f8e8; border-left-color: #27ae60;">
                <h3>ğŸ“‚ ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°</h3>
                <p>â€¢ ì´ì „ì— ë‹¤ìš´ë¡œë“œí•œ ë°±ì—… íŒŒì¼ì„ ì„ íƒí•˜ì—¬ ë°ì´í„°ë¥¼ ë³µì›í•©ë‹ˆë‹¤.</p>
                <p>â€¢ <strong style="color: #e74c3c;">âš ï¸ ì£¼ì˜: í˜„ì¬ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë˜ê³  ë°±ì—… íŒŒì¼ì˜ ë°ì´í„°ë¡œ êµì²´ë©ë‹ˆë‹¤.</strong></p>
                <p>â€¢ ë°±ì—… íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ê¸° ì „ì— í˜„ì¬ ë°ì´í„°ë¥¼ ë°±ì—…í•´ë‘ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
                <div class="file-input-wrapper" style="margin-top: 10px;">
                    <input type="file" id="restoreFileInput2" accept=".json" onchange="restoreBackup(event)">
                    <label for="restoreFileInput2" class="file-input-label">
                        ğŸ“‚ ë°±ì—… íŒŒì¼ ì„ íƒ
                    </label>
                    <span id="fileInputName"></span>
                </div>
            </div>

            <div class="info-section" style="margin-top: 30px;">
                <h3>ğŸ“Š í˜„ì¬ ë°ì´í„° í˜„í™©</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>ì „ì²´ ì§ì›</label>
                        <div class="value" id="backupEmployeeCount">0ëª…</div>
                    </div>
                    <div class="info-item">
                        <label>ì—°ì°¨ ë°ì´í„°</label>
                        <div class="value" id="backupLeaveCount">0ê±´</div>
                    </div>
                    <div class="info-item">
                        <label>êµìœ¡ ì¼ì •</label>
                        <div class="value" id="backupEducationCount">0ê±´</div>
                    </div>
                    <div class="info-item">
                        <label>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</label>
                        <div class="value" id="lastUpdate">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ê´€ë¦¬ì íŒ¨ë„ -->
    <div id="admin" class="tab-content">
        <h2 style="margin-bottom: 20px; color: #2c3e50;">ğŸ›¡ï¸ ê´€ë¦¬ì íŒ¨ë„</h2>

        <!-- ìƒˆ ê³„ì • ìƒì„± -->
        <div class="admin-settings-section" style="background:#e8f4f8; border-color:#bee3f8;">
            <h3 style="color:#1a5276; margin-bottom:18px;">â• ìƒˆ ê³„ì • ìƒì„±</h3>
            <p style="color:#5d7a8a; font-size:0.9em; margin-bottom:16px;">â€» íšŒì›ê°€ì… ì—†ì´ ê´€ë¦¬ìê°€ ì§ì ‘ ê³„ì •ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
            <div class="form-row">
                <div class="form-group">
                    <label>ì´ë¦„ *</label>
                    <input type="text" id="newUserName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group">
                    <label>ì•„ì´ë”” * (4ì ì´ìƒ)</label>
                    <input type="text" id="newUserId" placeholder="ì˜ë¬¸+ìˆ«ì, 4ì ì´ìƒ">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸ * (6ì ì´ìƒ)</label>
                    <input type="password" id="newUserPw" placeholder="6ì ì´ìƒ">
                </div>
                <div class="form-group">
                    <label>ê¶Œí•œ *</label>
                    <select id="newUserRole">
                        <option value="temp_admin">ğŸ”¶ ì„ì‹œê´€ë¦¬ì (ì—°ì°¨ê´€ë¦¬ ì œì™¸)</option>
                        <option value="admin">ğŸ”´ ê´€ë¦¬ì (ì „ì²´ ê¶Œí•œ)</option>
                    </select>
                </div>
            </div>
            <div style="background:#f8f9fa; padding:12px 16px; border-radius:6px; margin-bottom:14px; font-size:0.88em; color:#555;">
                <strong>ê¶Œí•œ ì•ˆë‚´</strong><br>
                ğŸ”¶ <strong>ì„ì‹œê´€ë¦¬ì</strong> : ëŒ€ì‹œë³´ë“œÂ·ì§ì›ê´€ë¦¬Â·ì§ë¬´êµìœ¡Â·ë°±ì—…ê´€ë¦¬ ê°€ëŠ¥ / ì—°ì°¨ê´€ë¦¬ <span style="color:#e74c3c;">ì ê¸ˆ</span><br>
                ğŸ”´ <strong>ê´€ë¦¬ì</strong> : ì—°ì°¨ê´€ë¦¬ í¬í•¨ ëª¨ë“  ê¸°ëŠ¥ + ê³„ì • ê´€ë¦¬ ê°€ëŠ¥
            </div>
            <div id="createUserMsg" class="auth-error" style="margin-bottom:0;"></div>
            <div id="createUserSuccess" class="auth-success" style="margin-bottom:0; margin-top:10px;"></div>
            <button class="btn btn-primary" onclick="createUser()" style="margin-top:14px;" id="createUserBtn">ê³„ì • ìƒì„±</button>
        </div>

        <!-- ê³„ì • ëª©ë¡ -->
        <div class="admin-settings-section">
            <h3 style="color:#2c3e50; margin-bottom:15px;">ğŸ‘¥ ê³„ì • ëª©ë¡</h3>
            <div id="allUsersList"><p style="color:#7f8c8d; font-style:italic;">ë¡œë”© ì¤‘...</p></div>
        </div>

        <!-- ë‚´ ê³„ì • ì„¤ì • -->
        <div class="admin-settings-section">
            <h3 style="color:#2c3e50; margin-bottom:15px;">ğŸ”‘ ë‚´ ê³„ì • ì„¤ì •</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>ìƒˆ ì•„ì´ë”” (ë¹„ì›Œë‘ë©´ ìœ ì§€)</label>
                    <input type="text" id="newAdminId" placeholder="ë³€ê²½í•  ì•„ì´ë””">
                </div>
                <div class="form-group">
                    <label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ *</label>
                    <input type="password" id="currentAdminPw" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ë¹„ì›Œë‘ë©´ ìœ ì§€)</label>
                    <input type="password" id="newAdminPw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
                </div>
                <div class="form-group">
                    <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input type="password" id="newAdminPw2" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥">
                </div>
            </div>
            <button class="btn btn-primary" onclick="updateAdminAccount()">ë‚´ ê³„ì • ì—…ë°ì´íŠ¸</button>
        </div>
    </div><!-- /admin tab-content -->

    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeEmployeeModal()">&times;</span>
                <h2 id="employeeModalTitle">ì§ì› ë“±ë¡</h2>
            </div>
            <form onsubmit="saveEmployee(event)">
                <input type="hidden" id="employeeId">
                
                <h3 style="color: #2c3e50; margin-bottom: 15px;">ê¸°ë³¸ ì •ë³´</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì„±ëª… *</label>
                        <input type="text" id="employeeName" required>
                    </div>
                    <div class="form-group">
                        <label>ì„±ë³„ *</label>
                        <select id="employeeGender" required>
                            <option value="">ì„ íƒ</option>
                            <option value="ë‚¨">ë‚¨</option>
                            <option value="ì—¬">ì—¬</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ì£¼ì†Œ</label>
                    <input type="text" id="employeeAddress">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ì „í™”ë²ˆí˜¸</label>
                        <input type="tel" id="employeePhone">
                    </div>
                    <div class="form-group">
                        <label>ì´ë©”ì¼</label>
                        <input type="email" id="employeeEmail">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ì…ì‚¬ì¼ *</label>
                        <input type="date" id="employeeHireDate" required>
                    </div>
                    <div class="form-group">
                        <label>í‡´ì‚¬ì¼</label>
                        <input type="date" id="employeeResignDate">
                    </div>
                </div>

                <h3 style="color: #2c3e50; margin-top: 30px; margin-bottom: 15px;">ìê²©ì¦ ì •ë³´</h3>
                <div id="certificatesContainer"></div>
                <button type="button" class="add-certificate-btn" onclick="addCertificateField()">+ ìê²©ì¦ ì¶”ê°€</button>

                <div style="margin-top: 30px;">
                    <button type="submit" class="btn btn-primary" id="empSaveBtn">ì €ì¥</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEmployeeModal()">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ì§ì› ìƒì„¸ì •ë³´ ëª¨ë‹¬ -->
    <div id="employeeDetailModal" class="modal">
        <div class="modal-content detail-modal">
            <div class="modal-header">
                <span class="close-modal" onclick="closeEmployeeDetailModal()">&times;</span>
                <h2>ì§ì› ìƒì„¸ì •ë³´</h2>
            </div>
            <div id="employeeDetailContent"></div>
        </div>
    </div>

    <!-- ì—°ì°¨ ì‚¬ìš© ëª¨ë‹¬ -->
    <div id="annualLeaveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeAnnualLeaveModal()">&times;</span>
                <h2>ì—°ì°¨ ì‚¬ìš© ë“±ë¡</h2>
            </div>
            <form onsubmit="saveAnnualLeaveUsage(event)">
                <input type="hidden" id="leaveEmployeeId">
                
                <div class="form-group">
                    <label>ì§ì›ëª…</label>
                    <input type="text" id="leaveEmployeeName" readonly style="background: #f8f9fa;">
                </div>
                
                <div class="info-section">
                    <h3>ì—°ì°¨ í˜„í™©</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>ì´ ì—°ì°¨</label>
                            <div class="value"><span id="leaveTotalDays">0</span>ì¼</div>
                        </div>
                        <div class="info-item">
                            <label>ì‚¬ìš© ì—°ì°¨</label>
                            <div class="value"><span id="leaveUsedDays">0</span>ì¼</div>
                        </div>
                        <div class="info-item">
                            <label>ì”ì—¬ ì—°ì°¨</label>
                            <div class="value" style="color: #27ae60;"><span id="leaveRemainingDays">0</span>ì¼</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ì‚¬ìš© ì¼ìˆ˜ *</label>
                        <input type="number" id="leaveUsageDays" min="0.5" step="0.5" required>
                    </div>
                    <div class="form-group">
                        <label>ì‚¬ìš© ë‚ ì§œ *</label>
                        <input type="date" id="leaveUsageDate" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ì‚¬ìœ </label>
                    <textarea id="leaveUsageReason" rows="3"></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary">ë“±ë¡</button>
                <button type="button" class="btn btn-secondary" onclick="closeAnnualLeaveModal()">ì·¨ì†Œ</button>
            </form>
        </div>
    </div>

    <!-- ì—°ì°¨ ì‚¬ìš©ë‚´ì—­ ëª¨ë‹¬ -->
    <div id="annualLeaveHistoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeAnnualLeaveHistoryModal()">&times;</span>
                <h2>ì—°ì°¨ ì‚¬ìš©ë‚´ì—­</h2>
            </div>
            <div id="annualLeaveHistoryContent"></div>
        </div>
    </div>

    <!-- ì§ì› ì¼ê´„ì—°ì°¨ ëª¨ë‹¬ -->
    <div id="bulkLeaveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeBulkLeaveModal()">&times;</span>
                <h2>ì§ì› ì¼ê´„ì—°ì°¨ ì‚¬ìš©</h2>
            </div>
            <form onsubmit="saveBulkLeave(event)">
                <div class="backup-info" style="background: #fff3cd; border-left-color: #ffc107;">
                    <h3>âš ï¸ ì£¼ì˜ì‚¬í•­</h3>
                    <p>â€¢ ì¬ì§ ì¤‘ì¸ ëª¨ë“  ì§ì›ì—ê²Œ ë™ì¼í•œ ì—°ì°¨ê°€ ì°¨ê°ë©ë‹ˆë‹¤.</p>
                    <p>â€¢ ì”ì—¬ ì—°ì°¨ê°€ ë¶€ì¡±í•œ ì§ì›ì€ ìë™ìœ¼ë¡œ ì œì™¸ë©ë‹ˆë‹¤.</p>
                    <p>â€¢ ì¼ê´„ ì—°ì°¨ëŠ” ê°œë³„ ì‚¬ìš©ë‚´ì—­ì— ê¸°ë¡ë©ë‹ˆë‹¤.</p>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ì‚¬ìš© ì¼ìˆ˜ *</label>
                        <input type="number" id="bulkLeaveDays" min="0.5" step="0.5" required>
                    </div>
                    <div class="form-group">
                        <label>ì‚¬ìš© ë‚ ì§œ *</label>
                        <input type="date" id="bulkLeaveDate" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ì‚¬ìœ </label>
                    <textarea id="bulkLeaveReason" rows="3" placeholder="ì˜ˆ: íšŒì‚¬ íœ´ë¬´ì¼, êµ­ê²½ì¼ ëŒ€ì²´íœ´ë¬´ë“±"></textarea>
                </div>
                
                <div id="bulkLeavePreview" style="margin-top: 20px;"></div>
                
                <button type="submit" class="btn btn-success">ì¼ê´„ ì ìš©</button>
                <button type="button" class="btn btn-secondary" onclick="closeBulkLeaveModal()">ì·¨ì†Œ</button>
            </form>
        </div>
    </div>

    <script>
    'use strict';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Firebase REST API ì„¤ì •
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const FB_PROJ = 'sangwon-hrm';
    const FB_KEY  = 'AIzaSyBebDpB0eFP2yDZ4NK6K8IoWS8aTseHkzc';
    const FB_BASE = `https://firestore.googleapis.com/v1/projects/${FB_PROJ}/databases/(default)/documents`;

    // â”€â”€ Firestore íƒ€ì… ë³€í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toFV(v) {
        if (v === null || v === undefined) return { nullValue: null };
        if (typeof v === 'boolean')  return { booleanValue: v };
        if (typeof v === 'number')   return Number.isInteger(v) ? { integerValue: String(v) } : { doubleValue: v };
        if (typeof v === 'string')   return { stringValue: v };
        if (Array.isArray(v))        return { arrayValue: { values: v.map(toFV) } };
        if (typeof v === 'object')   return { mapValue: { fields: toFs(v) } };
        return { stringValue: String(v) };
    }
    function toFs(obj) {
        const f = {};
        for (const [k, v] of Object.entries(obj)) f[k] = toFV(v);
        return f;
    }
    function fromFV(fv) {
        if (!fv) return null;
        if ('nullValue'    in fv) return null;
        if ('booleanValue' in fv) return fv.booleanValue;
        if ('integerValue' in fv) return Number(fv.integerValue);
        if ('doubleValue'  in fv) return fv.doubleValue;
        if ('stringValue'  in fv) return fv.stringValue;
        if ('arrayValue'   in fv) return (fv.arrayValue.values || []).map(fromFV);
        if ('mapValue'     in fv) return fromFs(fv.mapValue.fields || {});
        return null;
    }
    function fromFs(fields) {
        const o = {};
        for (const [k, v] of Object.entries(fields)) o[k] = fromFV(v);
        return o;
    }

    // â”€â”€ Firebase CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fbGetAll(col) {
        const r = await fetch(`${FB_BASE}/${col}?key=${FB_KEY}&pageSize=500`);
        if (!r.ok) throw new Error(`HTTP ${r.status} (${col})`);
        const j = await r.json();
        if (!j.documents) return [];
        return j.documents.map(d => fromFs(d.fields || {}));
    }
    async function fbSet(col, id, data) {
        const eid = encodeURIComponent(String(id));
        const r = await fetch(`${FB_BASE}/${col}/${eid}?key=${FB_KEY}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: toFs(JSON.parse(JSON.stringify(data))) })
        });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
    }
    async function fbDel(col, id) {
        const eid = encodeURIComponent(String(id));
        const r = await fetch(`${FB_BASE}/${col}/${eid}?key=${FB_KEY}`, { method: 'DELETE' });
        if (!r.ok && r.status !== 404) throw new Error(`HTTP ${r.status}`);
    }
    async function fbReplaceAll(col, arr, idKey) {
        const old = await fbGetAll(col);
        for (const d of old) { const id = d[idKey] || d.id; if (id) await fbDel(col, id); }
        for (const item of arr) { await fbSet(col, String(item[idKey] || item.id || Date.now()), item); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì•± ìƒíƒœ (ë©”ëª¨ë¦¬ ìºì‹œ â€” í´ë§ ì—†ìŒ)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let employees = [], annualLeaves = [], educations = [];
    let certificateCount = 0;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì´ˆê¸°í™”
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.addEventListener('DOMContentLoaded', async function () {
        document.getElementById('fiscalYear').value = new Date().getFullYear();
        document.getElementById('bulkLeaveDays').addEventListener('input', updateBulkLeavePreview);

        // Firebaseì—ì„œ ì „ì²´ ë°ì´í„° 1íšŒ ë¡œë“œ
        try { await loadAllFromFirebase(); }
        catch (e) { showFatalError('Firebase ì—°ê²° ì‹¤íŒ¨: ' + e.message); return; }

        await ensureAdminExists();

        // ë¡œê·¸ì¸ ìƒíƒœ ë³µì›
        const saved = sessionStorage.getItem('currentUser');
        if (saved) {
            try {
                const cu = JSON.parse(saved);
                const users = await fbGetAll('sysUsers');
                const fresh = users.find(u => u.id === cu.id);
                if (fresh) {
                    sessionStorage.setItem('currentUser', JSON.stringify(fresh));
                    document.getElementById('authOverlay').classList.remove('active');
                    onLoginSuccess(fresh);
                } else { sessionStorage.removeItem('currentUser'); }
            } catch (e) { sessionStorage.removeItem('currentUser'); }
        }

        updateDashboard(); loadEmployees(); loadAnnualLeave(); loadEducation(); updateBackupInfo();
    });

    async function loadAllFromFirebase() {
        const [e, l, ed] = await Promise.all([
            fbGetAll('employees'), fbGetAll('annualLeaves'), fbGetAll('educations')
        ]);
        employees = e; annualLeaves = l; educations = ed;
    }

    async function ensureAdminExists() {
        try {
            const users = await fbGetAll('sysUsers');
            if (!users.find(u => u.role === 'admin')) {
                await fbSet('sysUsers', 'admin', { id:'admin', pw:'admin1234', name:'ê´€ë¦¬ì',
                    role:'admin', status:'approved', createdAt: new Date().toISOString() });
            }
        } catch (e) { console.warn('ê´€ë¦¬ì ì´ˆê¸°í™” ì‹¤íŒ¨:', e); }
    }

    async function reloadAllData() {
        const btn = document.getElementById('refreshDataBtn');
        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>ë¡œë”© ì¤‘...';
        try {
            await loadAllFromFirebase();
            updateDashboard(); loadEmployees(); loadAnnualLeave(); loadEducation(); updateBackupInfo();
            btn.innerHTML = 'âœ… ì™„ë£Œ!';
            setTimeout(() => { btn.disabled = false; btn.innerHTML = 'ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨'; }, 2000);
        } catch (e) { btn.innerHTML = 'âŒ ì‹¤íŒ¨ - ì¬ì‹œë„'; btn.disabled = false; }
    }

    function showFatalError(msg) {
        document.getElementById('authOverlay').classList.remove('active');
        document.body.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column;gap:16px;font-family:sans-serif;">
            <div style="font-size:48px">âŒ</div><h2 style="color:#e74c3c">ì—°ê²° ì˜¤ë¥˜</h2>
            <p style="color:#7f8c8d">${msg}</p>
            <button onclick="location.reload()" style="padding:10px 24px;background:#3498db;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px">ë‹¤ì‹œ ì‹œë„</button>
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // íƒ­ ì „í™˜
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        document.querySelectorAll('.nav-tab').forEach(btn => {
            const oc = btn.getAttribute('onclick') || '';
            if (oc.includes("'" + tabName + "'") || (tabName === 'admin' && oc.includes('showAdminTab'))) btn.classList.add('active');
        });
        if (tabName === 'backup') updateBackupInfo();
    }
    async function showAdminTab() { showTab('admin'); await loadAdminPanel(); }
    function showAnnualLeaveTab() {
        const user = getCurrentUser();
        if (!user || user.role !== 'admin') {
            alert('ğŸ”’ ì—°ì°¨ê´€ë¦¬ëŠ” ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì„ì‹œê´€ë¦¬ìëŠ” ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        showTab('annual-leave');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ëŒ€ì‹œë³´ë“œ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function updateDashboard() {
        const now = new Date(), sixM = new Date();
        sixM.setMonth(sixM.getMonth() + 6);
        document.getElementById('totalEmployees').textContent    = employees.length;
        document.getElementById('activeEmployees').textContent   = employees.filter(e => !e.resignDate || new Date(e.resignDate) > now).length;
        document.getElementById('inactiveEmployees').textContent = employees.filter(e => e.resignDate && new Date(e.resignDate) <= now).length;
        document.getElementById('upcomingEducation').textContent = educations.filter(e => { const d=new Date(e.educationDate); return d>=now&&d<=sixM; }).length;
    }
    function showAllEmployees()      { showTab('employees'); renderEmployeeTable(employees); }
    function showActiveEmployees()   { showTab('employees'); renderEmployeeTable(employees.filter(e => !e.resignDate || new Date(e.resignDate) > new Date())); }
    function showInactiveEmployees() { showTab('employees'); renderEmployeeTable(employees.filter(e => e.resignDate && new Date(e.resignDate) <= new Date())); }
    function showUpcomingEducation() {
        showTab('education');
        const now=new Date(), sixM=new Date(); sixM.setMonth(sixM.getMonth()+6);
        renderEducationTable(educations.filter(e => { const d=new Date(e.educationDate); return d>=now&&d<=sixM; }));
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì§ì›ê´€ë¦¬
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderEmployeeTable(list) {
        const tbody = document.getElementById('employeesTableBody');
        if (!list.length) { tbody.innerHTML = '<tr><td colspan="8" class="no-data">í‘œì‹œí•  ì§ì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }
        tbody.innerHTML = list.map(emp => {
            const isActive = !emp.resignDate || new Date(emp.resignDate) > new Date();
            const certCount = emp.certificates ? emp.certificates.length : 0;
            return `<tr>
                <td>${emp.name}</td><td>${emp.gender}</td><td>${emp.phone||'-'}</td><td>${emp.email||'-'}</td>
                <td><span class="badge badge-info">${certCount}ê°œ</span></td>
                <td>${emp.hireDate ? new Date(emp.hireDate).toLocaleDateString('ko-KR') : '-'}</td>
                <td><span class="badge ${isActive?'badge-success':'badge-danger'}">${isActive?'ì¬ì§':'í‡´ì‚¬'}</span></td>
                <td><div class="action-buttons">
                    <button class="btn btn-info btn-small"    onclick="showEmployeeDetail(${emp.id})">ìƒì„¸</button>
                    <button class="btn btn-primary btn-small" onclick="openEmployeeModal(${emp.id})">ìˆ˜ì •</button>
                    <button class="btn btn-danger btn-small"  onclick="deleteEmployee(${emp.id})">ì‚­ì œ</button>
                </div></td></tr>`;
        }).join('');
    }
    function loadEmployees() { renderEmployeeTable(employees); }
    function searchEmployees() {
        const q = document.getElementById('employeeSearch').value.toLowerCase();
        renderEmployeeTable(employees.filter(e =>
            (e.name||'').toLowerCase().includes(q)||(e.email||'').toLowerCase().includes(q)||(e.phone||'').includes(q)));
    }

    // â”€â”€ ìê²©ì¦ í•„ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function addCertificateField(certData = null) {
        certificateCount++;
        const id = certificateCount;
        const div = document.createElement('div');
        div.className = 'certificate-item'; div.id = `cert-${id}`;
        const ed = certData && certData.educationDates ? certData.educationDates : {};
        div.innerHTML = `
            <button type="button" class="remove-cert-btn" onclick="removeCertificateField(${id})">Ã—</button>
            <h4>ğŸ“œ ìê²©ì¦ ${id}</h4>
            <div class="form-row">
                <div class="form-group"><label>ìê²©ì¦ëª… *</label><input type="text" class="cert-name" value="${certData?certData.name:''}" placeholder="ìê²©ì¦ ì´ë¦„"></div>
                <div class="form-group"><label>ì·¨ë“ì¼ *</label><input type="date" class="cert-date" value="${certData?certData.date:''}"></div>
            </div>
            <h4 style="margin-top:12px;font-size:0.85em;color:#7f8c8d;">êµìœ¡ ì¼ì •</h4>
            <div class="cert-education-grid">
                <div class="form-group"><label>ì´ˆê¸‰êµìœ¡</label><input type="date" class="cert-edu-basic"        value="${ed.basic||''}"></div>
                <div class="form-group"><label>ì¤‘ê¸‰êµìœ¡</label><input type="date" class="cert-edu-intermediate" value="${ed.intermediate||''}"></div>
                <div class="form-group"><label>ê³ ê¸‰êµìœ¡</label><input type="date" class="cert-edu-advanced"     value="${ed.advanced||''}"></div>
                <div class="form-group"><label>íŠ¹ê¸‰êµìœ¡</label><input type="date" class="cert-edu-expert"       value="${ed.expert||''}"></div>
                <div class="form-group"><label>í‰ê°€ì‚¬êµìœ¡</label><input type="date" class="cert-edu-evaluator"  value="${ed.evaluator||''}"></div>
            </div>`;
        document.getElementById('certificatesContainer').appendChild(div);
    }
    function removeCertificateField(id) { document.getElementById(`cert-${id}`)?.remove(); }

    // â”€â”€ ì§ì› ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openEmployeeModal(employeeId = null) {
        const container = document.getElementById('certificatesContainer');
        container.innerHTML = ''; certificateCount = 0;
        if (employeeId) {
            const emp = employees.find(e => e.id === employeeId);
            document.getElementById('employeeModalTitle').textContent = 'ì§ì› ì •ë³´ ìˆ˜ì •';
            document.getElementById('employeeId').value         = emp.id;
            document.getElementById('employeeName').value       = emp.name;
            document.getElementById('employeeGender').value     = emp.gender;
            document.getElementById('employeeAddress').value    = emp.address || '';
            document.getElementById('employeePhone').value      = emp.phone || '';
            document.getElementById('employeeEmail').value      = emp.email || '';
            document.getElementById('employeeHireDate').value   = emp.hireDate || '';
            document.getElementById('employeeResignDate').value = emp.resignDate || '';
            if (emp.certificates && emp.certificates.length > 0) emp.certificates.forEach(c => addCertificateField(c));
            else addCertificateField();
        } else {
            document.getElementById('employeeModalTitle').textContent = 'ì§ì› ë“±ë¡';
            document.getElementById('employeeId').value = '';
            document.querySelector('#employeeModal form').reset();
            addCertificateField();
        }
        document.getElementById('employeeModal').classList.add('active');
    }
    function closeEmployeeModal() { document.getElementById('employeeModal').classList.remove('active'); }

    async function saveEmployee(event) {
        event.preventDefault();
        const idVal = document.getElementById('employeeId').value;
        const btn   = document.getElementById('empSaveBtn');
        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>ì €ì¥ ì¤‘...';

        const certificates = [];
        document.querySelectorAll('.certificate-item').forEach(certDiv => {
            const name = certDiv.querySelector('.cert-name').value;
            const date = certDiv.querySelector('.cert-date').value;
            if (name && date) certificates.push({
                id: certDiv.id.replace('cert-', ''), name, date,
                educationDates: {
                    basic:        certDiv.querySelector('.cert-edu-basic').value,
                    intermediate: certDiv.querySelector('.cert-edu-intermediate').value,
                    advanced:     certDiv.querySelector('.cert-edu-advanced').value,
                    expert:       certDiv.querySelector('.cert-edu-expert').value,
                    evaluator:    certDiv.querySelector('.cert-edu-evaluator').value,
                }
            });
        });

        const empId = idVal ? parseInt(idVal) : Date.now();
        const emp = {
            id: empId, name: document.getElementById('employeeName').value,
            gender: document.getElementById('employeeGender').value,
            address: document.getElementById('employeeAddress').value,
            phone: document.getElementById('employeePhone').value,
            email: document.getElementById('employeeEmail').value,
            hireDate: document.getElementById('employeeHireDate').value,
            resignDate: document.getElementById('employeeResignDate').value,
            certificates,
        };

        try {
            await fbSet('employees', empId, emp);
            if (idVal) {
                const idx = employees.findIndex(e => e.id === empId);
                if (idx >= 0) employees[idx] = emp;
                // ê¸°ì¡´ êµìœ¡ì¼ì • ì‚­ì œ í›„ ì¬ìƒì„±
                const oldEduIds = educations.filter(ed => ed.employeeId === empId).map(ed => ed.id);
                educations = educations.filter(ed => ed.employeeId !== empId);
                for (const eid of oldEduIds) await fbDel('educations', eid);
            } else {
                employees.push(emp);
                calculateAnnualLeaveForEmployee(emp);
            }
            await generateEducationSchedule(emp);
            closeEmployeeModal();
            loadEmployees(); loadAnnualLeave(); loadEducation(); updateDashboard(); updateBackupInfo();
            alert('ì§ì› ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (e) { alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message); }
        btn.disabled = false; btn.innerHTML = 'ì €ì¥';
    }

    async function generateEducationSchedule(emp) {
        if (!emp.certificates) return;
        const eduTypes = [
            {key:'basic',name:'ì´ˆê¸‰êµìœ¡'},{key:'intermediate',name:'ì¤‘ê¸‰êµìœ¡'},
            {key:'advanced',name:'ê³ ê¸‰êµìœ¡'},{key:'expert',name:'íŠ¹ê¸‰êµìœ¡'},
            {key:'evaluator',name:'í‰ê°€ì‚¬êµìœ¡'}
        ];
        for (const cert of emp.certificates) {
            for (const type of eduTypes) {
                const dateVal = cert.educationDates && cert.educationDates[type.key];
                if (dateVal) {
                    const edu = {
                        id: `edu_${emp.id}_${cert.id}_${type.key}`,
                        employeeId: emp.id, employeeName: emp.name,
                        certificate: cert.name, certificateDate: cert.date,
                        type: type.name, educationDate: dateVal,
                    };
                    educations.push(edu);
                    await fbSet('educations', edu.id, edu);
                }
            }
        }
    }

    function showEmployeeDetail(employeeId) {
        const emp = employees.find(e => e.id === employeeId);
        const isActive = !emp.resignDate || new Date(emp.resignDate) > new Date();
        const eduTypes = [
            {key:'basic',name:'ì´ˆê¸‰êµìœ¡'},{key:'intermediate',name:'ì¤‘ê¸‰êµìœ¡'},
            {key:'advanced',name:'ê³ ê¸‰êµìœ¡'},{key:'expert',name:'íŠ¹ê¸‰êµìœ¡'},
            {key:'evaluator',name:'í‰ê°€ì‚¬êµìœ¡'}
        ];
        let certificatesHtml = '<p class="no-data">ë“±ë¡ëœ ìê²©ì¦ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        if (emp.certificates && emp.certificates.length > 0) {
            certificatesHtml = emp.certificates.map(cert => {
                let eduHtml = '';
                eduTypes.forEach(type => {
                    if (cert.educationDates && cert.educationDates[type.key])
                        eduHtml += `<div class="info-item"><label>${type.name}</label><div class="value">${new Date(cert.educationDates[type.key]).toLocaleDateString('ko-KR')}</div></div>`;
                });
                return `<div class="certificate-item">
                    <h4>ğŸ“œ ${cert.name}</h4>
                    <p style="color:#7f8c8d;margin-bottom:10px;">ì·¨ë“ì¼: ${new Date(cert.date).toLocaleDateString('ko-KR')}</p>
                    ${eduHtml ? `<div class="education-grid">${eduHtml}</div>` : '<p style="color:#7f8c8d;font-size:0.9em;">ë“±ë¡ëœ êµìœ¡ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
                </div>`;
            }).join('');
        }
        document.getElementById('employeeDetailContent').innerHTML = `<div style="padding:25px;">
            <div class="info-section"><h3>ê¸°ë³¸ ì •ë³´</h3><div class="info-grid">
                <div class="info-item"><label>ì„±ëª…</label><div class="value">${emp.name}</div></div>
                <div class="info-item"><label>ì„±ë³„</label><div class="value">${emp.gender}</div></div>
                <div class="info-item"><label>ì „í™”ë²ˆí˜¸</label><div class="value">${emp.phone||'-'}</div></div>
                <div class="info-item"><label>ì´ë©”ì¼</label><div class="value">${emp.email||'-'}</div></div>
                <div class="info-item"><label>ì…ì‚¬ì¼</label><div class="value">${emp.hireDate?new Date(emp.hireDate).toLocaleDateString('ko-KR'):'-'}</div></div>
                <div class="info-item"><label>ìƒíƒœ</label><div class="value"><span class="badge ${isActive?'badge-success':'badge-danger'}">${isActive?'ì¬ì§':'í‡´ì‚¬'}</span></div></div>
            </div>${emp.address?`<div class="info-item" style="margin-top:15px;"><label>ì£¼ì†Œ</label><div class="value">${emp.address}</div></div>`:''}</div>
            <div class="info-section"><h3>ìê²©ì¦ ì •ë³´</h3>${certificatesHtml}</div>
        </div>`;
        document.getElementById('employeeDetailModal').classList.add('active');
    }
    function closeEmployeeDetailModal() { document.getElementById('employeeDetailModal').classList.remove('active'); }

    async function deleteEmployee(id) {
        if (!confirm('ì´ ì§ì› ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì—°ì°¨ ë° êµìœ¡ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)')) return;
        try {
            await fbDel('employees', id);
            for (const lv of annualLeaves.filter(a => a.employeeId === id)) await fbDel('annualLeaves', lv.id || `lv_${id}`);
            for (const ed of educations.filter(e => e.employeeId === id)) await fbDel('educations', ed.id);
            employees    = employees.filter(e => e.id !== id);
            annualLeaves = annualLeaves.filter(a => a.employeeId !== id);
            educations   = educations.filter(e => e.employeeId !== id);
            loadEmployees(); loadAnnualLeave(); loadEducation(); updateDashboard(); updateBackupInfo();
            alert('ì§ì› ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (e) { alert('ì‚­ì œ ì‹¤íŒ¨: ' + e.message); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì—°ì°¨ê´€ë¦¬
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function calculateAnnualLeaveForEmployee(emp) {
        const fy     = parseInt(document.getElementById('fiscalYear').value) || new Date().getFullYear();
        const years  = (new Date(fy, 11, 31) - new Date(emp.hireDate)) / (365.25*24*3600*1000);
        const total  = years < 1 ? 12 : Math.min(15 + (years >= 3 ? Math.floor((years-1)/2) : 0), 25);
        const lid    = `lv_${emp.id}`;
        const existing = annualLeaves.find(a => a.employeeId === emp.id);
        if (existing) {
            existing.totalDays = total; existing.yearsOfService = years.toFixed(1); existing.fiscalYear = fy;
        } else {
            const lv = { id:lid, employeeId:emp.id, totalDays:total, usedDays:0,
                yearsOfService:years.toFixed(1), fiscalYear:fy, usageHistory:[] };
            annualLeaves.push(lv);
            fbSet('annualLeaves', lid, lv).catch(console.warn);
        }
    }

    function calculateAllAnnualLeave() {
        const fy = document.getElementById('fiscalYear').value;
        if (!fy) { alert('íšŒê³„ë…„ë„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
        if (!confirm(`${fy}ë…„ íšŒê³„ë…„ë„ ê¸°ì¤€ìœ¼ë¡œ\nì „ì²´ ì§ì›ì˜ ì—°ì°¨ë¥¼ ì¬ê³„ì‚°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        employees.filter(e => !e.resignDate || new Date(e.resignDate) > new Date()).forEach(emp => calculateAnnualLeaveForEmployee(emp));
        annualLeaves.forEach(lv => fbSet('annualLeaves', lv.id || `lv_${lv.employeeId}`, lv).catch(console.warn));
        loadAnnualLeave(); updateBackupInfo();
        alert(`${fy}ë…„ íšŒê³„ë…„ë„ ê¸°ì¤€ìœ¼ë¡œ\nì „ì²´ ì—°ì°¨ê°€ ì¬ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    function loadAnnualLeave() {
        const tbody  = document.getElementById('annualLeaveTableBody');
        const active = employees.filter(e => !e.resignDate || new Date(e.resignDate) > new Date());
        if (!active.length) { tbody.innerHTML = '<tr><td colspan="7" class="no-data">ì¬ì§ ì¤‘ì¸ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }
        tbody.innerHTML = active.map(emp => {
            let lv = annualLeaves.find(a => a.employeeId === emp.id);
            if (!lv) { calculateAnnualLeaveForEmployee(emp); lv = annualLeaves.find(a => a.employeeId === emp.id); }
            const rem = lv.totalDays - lv.usedDays;
            return `<tr>
                <td>${emp.name}</td>
                <td>${emp.hireDate?new Date(emp.hireDate).toLocaleDateString('ko-KR'):'-'}</td>
                <td>${lv.yearsOfService}ë…„</td><td>${lv.totalDays}ì¼</td><td>${lv.usedDays}ì¼</td>
                <td><span class="badge ${rem>5?'badge-success':rem>0?'badge-warning':'badge-danger'}">${rem}ì¼</span></td>
                <td><div class="action-buttons">
                    <button class="btn btn-primary btn-small" onclick="openAnnualLeaveModal(${emp.id})">ì—°ì°¨ì‚¬ìš©</button>
                    <button class="btn btn-info btn-small"    onclick="showAnnualLeaveHistory(${emp.id})">ì‚¬ìš©ë‚´ì—­</button>
                </div></td></tr>`;
        }).join('');
    }

    function openAnnualLeaveModal(empId) {
        const emp = employees.find(e => e.id === empId);
        const lv  = annualLeaves.find(a => a.employeeId === empId);
        document.getElementById('leaveEmployeeId').value          = empId;
        document.getElementById('leaveEmployeeName').value        = emp.name;
        document.getElementById('leaveTotalDays').textContent     = lv.totalDays;
        document.getElementById('leaveUsedDays').textContent      = lv.usedDays;
        document.getElementById('leaveRemainingDays').textContent = lv.totalDays - lv.usedDays;
        document.getElementById('annualLeaveModal').classList.add('active');
    }
    function closeAnnualLeaveModal() {
        document.getElementById('annualLeaveModal').classList.remove('active');
        document.querySelector('#annualLeaveModal form').reset();
    }

    async function saveAnnualLeaveUsage(event) {
        event.preventDefault();
        const empId   = parseInt(document.getElementById('leaveEmployeeId').value);
        const useDays = parseFloat(document.getElementById('leaveUsageDays').value);
        const useDate = document.getElementById('leaveUsageDate').value;
        const reason  = document.getElementById('leaveUsageReason').value;
        const lv      = annualLeaves.find(a => a.employeeId === empId);
        const rem     = lv.totalDays - lv.usedDays;
        if (useDays > rem) { alert(`ì‚¬ìš© ê°€ëŠ¥í•œ ì—°ì°¨ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (ì”ì—¬: ${rem}ì¼)`); return; }
        lv.usedDays += useDays;
        lv.usageHistory = lv.usageHistory || [];
        lv.usageHistory.push({ date:useDate, days:useDays, reason, recordDate:new Date().toISOString() });
        try {
            await fbSet('annualLeaves', lv.id || `lv_${empId}`, lv);
            closeAnnualLeaveModal(); loadAnnualLeave(); updateBackupInfo();
            alert('ì—°ì°¨ ì‚¬ìš©ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (e) { alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message); }
    }

    function showAnnualLeaveHistory(empId) {
        const emp = employees.find(e => e.id === empId);
        const lv  = annualLeaves.find(a => a.employeeId === empId);
        let histHtml = '<p class="no-data">ì—°ì°¨ ì‚¬ìš©ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        if (lv.usageHistory && lv.usageHistory.length > 0) {
            const sorted = [...lv.usageHistory].sort((a,b) => new Date(b.date)-new Date(a.date));
            histHtml = `
                <div class="info-section"><h3>${emp.name} - ì—°ì°¨ í˜„í™©</h3><div class="info-grid">
                    <div class="info-item"><label>ì´ ì—°ì°¨</label><div class="value">${lv.totalDays}ì¼</div></div>
                    <div class="info-item"><label>ì‚¬ìš© ì—°ì°¨</label><div class="value">${lv.usedDays}ì¼</div></div>
                    <div class="info-item"><label>ì”ì—¬ ì—°ì°¨</label><div class="value" style="color:#27ae60">${lv.totalDays-lv.usedDays}ì¼</div></div>
                </div></div>
                <table style="width:100%;border-collapse:collapse;font-size:0.9em;margin-top:15px;">
                    <thead><tr style="background:#34495e;color:white;">
                        <th style="padding:10px 12px;">ë‚ ì§œ</th><th style="padding:10px 12px;">ì¼ìˆ˜</th>
                        <th style="padding:10px 12px;">ì‚¬ìœ </th><th style="padding:10px 12px;">ê´€ë¦¬</th>
                    </tr></thead><tbody>
                    ${sorted.map(h => {
                        const realIdx = lv.usageHistory.indexOf(h);
                        return `<tr style="border-bottom:1px solid #ecf0f1;">
                            <td style="padding:10px 12px;">${h.date}</td>
                            <td style="padding:10px 12px;">${h.days}ì¼${h.isBulk?'<span class="badge badge-info" style="margin-left:4px;">ì¼ê´„</span>':''}</td>
                            <td style="padding:10px 12px;">${h.reason||'-'}</td>
                            <td style="padding:10px 12px;"><div class="action-buttons">
                                <button class="btn btn-warning btn-small" onclick="editLeaveHistory(${empId},${realIdx})">ìˆ˜ì •</button>
                                <button class="btn btn-danger btn-small"  onclick="deleteLeaveHistory(${empId},${realIdx})">ì‚­ì œ</button>
                            </div></td></tr>`;
                    }).join('')}
                    </tbody></table>`;
        }
        document.getElementById('annualLeaveHistoryContent').innerHTML = `<div style="padding:25px;">${histHtml}</div>`;
        document.getElementById('annualLeaveHistoryModal').classList.add('active');
    }
    function closeAnnualLeaveHistoryModal() { document.getElementById('annualLeaveHistoryModal').classList.remove('active'); }

    async function deleteLeaveHistory(empId, histIdx) {
        if (!confirm('ì´ ì—°ì°¨ ì‚¬ìš© ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const lv = annualLeaves.find(a => a.employeeId === empId);
        if (!lv || !lv.usageHistory || !lv.usageHistory[histIdx]) { alert('ì‚­ì œí•  ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
        const deleted = lv.usageHistory[histIdx];
        lv.usedDays -= deleted.days;
        lv.usageHistory.splice(histIdx, 1);
        try {
            await fbSet('annualLeaves', lv.id || `lv_${empId}`, lv);
            loadAnnualLeave(); updateBackupInfo(); showAnnualLeaveHistory(empId);
            alert('ì—°ì°¨ ì‚¬ìš© ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (e) { alert('ì‚­ì œ ì‹¤íŒ¨: ' + e.message); }
    }

    async function editLeaveHistory(empId, histIdx) {
        const lv = annualLeaves.find(a => a.employeeId === empId);
        if (!lv || !lv.usageHistory || !lv.usageHistory[histIdx]) { alert('ìˆ˜ì •í•  ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
        const h = lv.usageHistory[histIdx];
        const newDate = prompt('ì‚¬ìš© ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD):', h.date);
        if (!newDate) return;
        if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate)) { alert('ì˜¬ë°”ë¥¸ ë‚ ì§œ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (YYYY-MM-DD)'); return; }
        const newDaysStr = prompt('ì‚¬ìš© ì¼ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', h.days);
        if (!newDaysStr) return;
        const newDays = parseFloat(newDaysStr);
        if (isNaN(newDays) || newDays <= 0) { alert('ì˜¬ë°”ë¥¸ ì¼ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        const newReason = prompt('ì‚¬ìš© ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', h.reason || '');
        const curUsed = lv.usedDays - h.days;
        if (curUsed + newDays > lv.totalDays) {
            alert(`ì”ì—¬ ì—°ì°¨ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\nì´ ì—°ì°¨: ${lv.totalDays}ì¼\ní˜„ì¬ ì‚¬ìš©: ${curUsed}ì¼\nì”ì—¬: ${lv.totalDays-curUsed}ì¼`);
            return;
        }
        lv.usedDays = curUsed + newDays;
        h.date = newDate; h.days = newDays; h.reason = newReason; h.modifiedDate = new Date().toISOString();
        try {
            await fbSet('annualLeaves', lv.id || `lv_${empId}`, lv);
            loadAnnualLeave(); updateBackupInfo(); showAnnualLeaveHistory(empId);
            alert('ì—°ì°¨ ì‚¬ìš© ë‚´ì—­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (e) { alert('ìˆ˜ì • ì‹¤íŒ¨: ' + e.message); }
    }

    function openBulkLeaveModal() {
        if (!employees.filter(e => !e.resignDate || new Date(e.resignDate) > new Date()).length) {
            alert('ì¬ì§ ì¤‘ì¸ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.'); return;
        }
        document.getElementById('bulkLeaveModal').classList.add('active');
        updateBulkLeavePreview();
    }
    function closeBulkLeaveModal() {
        document.getElementById('bulkLeaveModal').classList.remove('active');
        document.querySelector('#bulkLeaveModal form').reset();
        document.getElementById('bulkLeavePreview').innerHTML = '';
    }
    function updateBulkLeavePreview() {
        const days   = parseFloat(document.getElementById('bulkLeaveDays').value) || 0;
        const active = employees.filter(e => !e.resignDate || new Date(e.resignDate) > new Date());
        if (days <= 0) { document.getElementById('bulkLeavePreview').innerHTML = ''; return; }
        let ok=0, skip=0, skipList=[];
        active.forEach(emp => {
            const lv = annualLeaves.find(a => a.employeeId === emp.id);
            if (lv) { const rem=lv.totalDays-lv.usedDays; if(rem>=days) ok++; else { skip++; skipList.push(`${emp.name} (ì”ì—¬: ${rem}ì¼)`); } }
        });
        document.getElementById('bulkLeavePreview').innerHTML = `
            <div class="info-section"><h3>ì ìš© ëŒ€ìƒ ë¯¸ë¦¬ë³´ê¸°</h3><div class="info-grid">
                <div class="info-item"><label>ì ìš© ëŒ€ìƒ</label><div class="value" style="color:#27ae60">${ok}ëª…</div></div>
                <div class="info-item"><label>ì œì™¸ ëŒ€ìƒ</label><div class="value" style="color:#e74c3c">${skip}ëª…</div></div>
                <div class="info-item"><label>ì‚¬ìš© ì¼ìˆ˜</label><div class="value">${days}ì¼</div></div>
            </div>${skip>0?`<div style="margin-top:15px;padding:10px;background:#f8d7da;border-radius:5px;border-left:3px solid #e74c3c;">
                <strong>ì œì™¸ë˜ëŠ” ì§ì›:</strong><br><span style="color:#721c24;font-size:0.9em;">${skipList.join(', ')}</span></div>`:''}</div>`;
    }
    async function saveBulkLeave(event) {
        event.preventDefault();
        const days   = parseFloat(document.getElementById('bulkLeaveDays').value);
        const date   = document.getElementById('bulkLeaveDate').value;
        const reason = document.getElementById('bulkLeaveReason').value;
        if (!days||days<=0) { alert('ì‚¬ìš© ì¼ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
        if (!date)          { alert('ì‚¬ìš© ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
        const active = employees.filter(e => !e.resignDate || new Date(e.resignDate) > new Date());
        let ok=0, skip=0, skipNames=[];
        try {
            for (const emp of active) {
                const lv = annualLeaves.find(a => a.employeeId === emp.id);
                if (lv) {
                    const rem = lv.totalDays - lv.usedDays;
                    if (rem >= days) {
                        lv.usedDays += days;
                        lv.usageHistory = lv.usageHistory || [];
                        lv.usageHistory.push({ date, days, reason: reason||'ì¼ê´„ ì—°ì°¨ ì‚¬ìš©', recordDate:new Date().toISOString(), isBulk:true });
                        await fbSet('annualLeaves', lv.id || `lv_${emp.id}`, lv);
                        ok++;
                    } else { skip++; skipNames.push(emp.name); }
                }
            }
            closeBulkLeaveModal(); loadAnnualLeave(); updateBackupInfo();
            let msg = `âœ… ì¼ê´„ì—°ì°¨ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì ìš© ì§ì›: ${ok}ëª…\nì‚¬ìš© ì¼ìˆ˜: ${days}ì¼`;
            if (skip > 0) msg += `\n\nâš ï¸ ì œì™¸ëœ ì§ì›: ${skip}ëª…\n(ì”ì—¬ ì—°ì°¨ ë¶€ì¡±: ${skipNames.join(', ')})`;
            alert(msg);
        } catch (e) { alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì§ë¬´êµìœ¡
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderEducationTable(list) {
        const tbody = document.getElementById('educationTableBody');
        if (!list.length) { tbody.innerHTML = '<tr><td colspan="7" class="no-data">ë“±ë¡ëœ êµìœ¡ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }
        const today = new Date();
        tbody.innerHTML = list.sort((a,b) => new Date(a.educationDate)-new Date(b.educationDate)).map(edu => {
            const diff = Math.ceil((new Date(edu.educationDate)-today)/86400000);
            let dDay,dCls,sTxt,sCls;
            if      (diff<0)   {dDay='ì™„ë£Œ';    dCls='badge-secondary';sTxt='ì™„ë£Œ';  sCls='badge-secondary';}
            else if (diff===0) {dDay='D-Day';   dCls='badge-danger';   sTxt='ë‹¹ì¼';  sCls='badge-danger';}
            else if (diff<=30) {dDay=`D-${diff}`;dCls='badge-warning'; sTxt='ì„ë°•';  sCls='badge-warning';}
            else if (diff<=180){dDay=`D-${diff}`;dCls='badge-info';    sTxt='ì˜ˆì •';  sCls='badge-info';}
            else               {dDay=`D-${diff}`;dCls='badge-secondary';sTxt='ì˜ˆì •'; sCls='badge-secondary';}
            return `<tr>
                <td>${edu.employeeName}</td>
                <td>${edu.certificate||'-'}</td>
                <td>${edu.certificateDate?new Date(edu.certificateDate).toLocaleDateString('ko-KR'):'-'}</td>
                <td><span class="badge badge-info">${edu.type}</span></td>
                <td>${new Date(edu.educationDate).toLocaleDateString('ko-KR')}</td>
                <td><span class="badge ${dCls}">${dDay}</span></td>
                <td><span class="badge ${sCls}">${sTxt}</span></td>
            </tr>`;
        }).join('');
    }
    function loadEducation() { renderEducationTable(educations); }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ë°±ì—…
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function updateBackupInfo() {
        document.getElementById('backupEmployeeCount').textContent  = employees.length    + 'ëª…';
        document.getElementById('backupLeaveCount').textContent     = annualLeaves.length + 'ê±´';
        document.getElementById('backupEducationCount').textContent = educations.length   + 'ê±´';
        const el = document.getElementById('lastUpdate');
        el.textContent = (employees.length||annualLeaves.length||educations.length) ? new Date().toLocaleString('ko-KR') : 'ë°ì´í„° ì—†ìŒ';
    }
    function downloadBackup() {
        const d     = new Date();
        const fname = `backup_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}.json`;
        const a     = document.createElement('a');
        a.href      = URL.createObjectURL(new Blob([JSON.stringify({ employees, annualLeaves, educations, exportedAt: d.toISOString() }, null, 2)], { type:'application/json' }));
        a.download  = fname; a.click();
    }
    async function restoreBackup(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (!confirm('í˜„ì¬ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ê³  ë°±ì—… ë°ì´í„°ë¡œ êµì²´ë©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { event.target.value=''; return; }
        try {
            const bd = JSON.parse(await file.text());
            if (bd.employees)    { await fbReplaceAll('employees',    bd.employees,    'id'); employees    = bd.employees; }
            if (bd.annualLeaves) { await fbReplaceAll('annualLeaves', bd.annualLeaves, 'id'); annualLeaves = bd.annualLeaves; }
            if (bd.educations)   { await fbReplaceAll('educations',   bd.educations,   'id'); educations   = bd.educations; }
            loadEmployees(); loadAnnualLeave(); loadEducation(); updateDashboard(); updateBackupInfo();
            alert('âœ… ë°±ì—… ë³µì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (e) { alert('ë°±ì—… íŒŒì¼ ì˜¤ë¥˜: ' + e.message); }
        event.target.value = '';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì¸ì¦
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function getCurrentUser() { const s=sessionStorage.getItem('currentUser'); return s?JSON.parse(s):null; }

    async function doLogin() {
        const id    = document.getElementById('loginId').value.trim();
        const pw    = document.getElementById('loginPw').value;
        const errEl = document.getElementById('loginError');
        const btn   = document.getElementById('loginBtn');
        errEl.classList.remove('visible');
        if (!id||!pw) { errEl.textContent='ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; errEl.classList.add('visible'); return; }

        btn.disabled=true; btn.innerHTML='<span class="spinner"></span>í™•ì¸ ì¤‘...';
        let users;
        try { users = await fbGetAll('sysUsers'); }
        catch (e) {
            errEl.textContent='ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.'; errEl.classList.add('visible');
            btn.disabled=false; btn.innerHTML='ë¡œê·¸ì¸'; return;
        }
        const user = users.find(u => u.id===id && u.pw===pw);
        if (!user) { errEl.textContent='ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; errEl.classList.add('visible'); btn.disabled=false; btn.innerHTML='ë¡œê·¸ì¸'; return; }

        btn.innerHTML='<span class="spinner"></span>ë°ì´í„° ë¡œë”© ì¤‘...';
        try { await loadAllFromFirebase(); } catch (e) { console.warn('ì¼ë¶€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e); }
        btn.disabled=false; btn.innerHTML='ë¡œê·¸ì¸';
        sessionStorage.setItem('currentUser', JSON.stringify(user));
        document.getElementById('authOverlay').classList.remove('active');
        onLoginSuccess(user);
    }

    function doLogout() {
        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { sessionStorage.removeItem('currentUser'); location.reload(); }
    }

    function onLoginSuccess(user) {
        document.getElementById('headerUserName').textContent = user.name;
        const badge = document.getElementById('headerUserBadge');
        if (user.role === 'admin') {
            badge.textContent = 'ê´€ë¦¬ì';
            badge.className   = 'user-badge admin';
        } else if (user.role === 'temp_admin') {
            badge.textContent = 'ì„ì‹œê´€ë¦¬ì';
            badge.className   = 'user-badge temp-admin';
        } else {
            badge.textContent = 'ì¼ë°˜';
            badge.className   = 'user-badge';
        }
        // ê´€ë¦¬ì & ì„ì‹œê´€ë¦¬ì â†’ ê´€ë¦¬ì íƒ­ í‘œì‹œ
        if (user.role === 'admin' || user.role === 'temp_admin') {
            document.getElementById('adminTab').style.display = '';
        }
        // ì—°ì°¨ê´€ë¦¬ íƒ­: adminë§Œ ì ê¸ˆ í•´ì œ, temp_adminì€ ì ê¸ˆ ìœ ì§€
        const leaveTab = document.getElementById('annualLeaveTab');
        if (user.role === 'admin') {
            leaveTab.textContent = 'ğŸ“… ì—°ì°¨ê´€ë¦¬';
            leaveTab.classList.remove('tab-locked');
        } else {
            leaveTab.textContent = 'ğŸ“… ì—°ì°¨ê´€ë¦¬ ğŸ”’';
            leaveTab.classList.add('tab-locked');
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ê´€ë¦¬ì íŒ¨ë„ (íƒ­ í´ë¦­ ì‹œì—ë§Œ Firebase ë¡œë“œ)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadAdminPanel() {
        let users;
        try { users = await fbGetAll('sysUsers'); }
        catch (e) { alert('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + e.message); return; }

        // ê´€ë¦¬ì ë³¸ì¸ ì œì™¸í•œ ì „ì²´ ê³„ì • ëª©ë¡
        const cu  = getCurrentUser();
        const all = users.filter(u => u.id !== cu.id);

        function roleBadge(role) {
            if (role === 'admin')      return '<span class="badge" style="background:#f8d7da;color:#721c24;">ğŸ”´ ê´€ë¦¬ì</span>';
            if (role === 'temp_admin') return '<span class="badge" style="background:#fde8d5;color:#7d4e12;">ğŸ”¶ ì„ì‹œê´€ë¦¬ì</span>';
            return '<span class="badge badge-secondary">ì¼ë°˜</span>';
        }

        document.getElementById('allUsersList').innerHTML = !all.length
            ? '<p style="color:#7f8c8d;font-style:italic;">ë“±ë¡ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>'
            : `<table style="width:100%;border-collapse:collapse;font-size:0.9em;">
                <thead style="background:#34495e;color:white;"><tr>
                    <th style="padding:10px 12px;">ì´ë¦„</th>
                    <th style="padding:10px 12px;">ì•„ì´ë””</th>
                    <th style="padding:10px 12px;">ê¶Œí•œ</th>
                    <th style="padding:10px 12px;">ìƒì„±ì¼</th>
                    <th style="padding:10px 12px;">ê´€ë¦¬</th>
                </tr></thead><tbody>
                ${all.map(u => `<tr style="border-bottom:1px solid #ecf0f1;">
                    <td style="padding:10px 12px;">${u.name}</td>
                    <td style="padding:10px 12px;">${u.id}</td>
                    <td style="padding:10px 12px;">${roleBadge(u.role)}</td>
                    <td style="padding:10px 12px;color:#7f8c8d;">${new Date(u.createdAt).toLocaleDateString('ko-KR')}</td>
                    <td style="padding:10px 12px;">
                        ${u.role === 'temp_admin'
                            ? `<button class="btn btn-success btn-small" onclick="changeUserRole('${u.id}','admin')">ê´€ë¦¬ìë¡œ ìŠ¹ê²©</button>`
                            : u.role === 'admin'
                                ? `<button class="btn btn-secondary btn-small" onclick="changeUserRole('${u.id}','temp_admin')">ì„ì‹œê´€ë¦¬ìë¡œ ë³€ê²½</button>`
                                : ''}
                        <button class="btn btn-danger btn-small" style="margin-left:4px;" onclick="deleteUser('${u.id}')">ì‚­ì œ</button>
                    </td></tr>`).join('')}
                </tbody></table>`;
    }

    async function createUser() {
        const name   = document.getElementById('newUserName').value.trim();
        const id     = document.getElementById('newUserId').value.trim();
        const pw     = document.getElementById('newUserPw').value;
        const role   = document.getElementById('newUserRole').value;
        const msgEl  = document.getElementById('createUserMsg');
        const sucEl  = document.getElementById('createUserSuccess');
        const btn    = document.getElementById('createUserBtn');
        msgEl.classList.remove('visible'); sucEl.classList.remove('visible');
        if (!name)        { msgEl.textContent='ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.';              msgEl.classList.add('visible'); return; }
        if (id.length<4)  { msgEl.textContent='ì•„ì´ë””ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; msgEl.classList.add('visible'); return; }
        if (pw.length<6)  { msgEl.textContent='ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; msgEl.classList.add('visible'); return; }
        btn.disabled=true; btn.innerHTML='<span class="spinner"></span>ìƒì„± ì¤‘...';
        try {
            const users = await fbGetAll('sysUsers');
            if (users.find(u => u.id===id)) { msgEl.textContent='ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.'; msgEl.classList.add('visible'); btn.disabled=false; btn.innerHTML='ê³„ì • ìƒì„±'; return; }
            const nu = { id, pw, name, role, status:'approved', createdAt: new Date().toISOString() };
            await fbSet('sysUsers', id, nu);
            sucEl.textContent = `âœ… [${role==='admin'?'ê´€ë¦¬ì':'ì„ì‹œê´€ë¦¬ì'}] ${name}(${id}) ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            sucEl.classList.add('visible');
            ['newUserName','newUserId','newUserPw'].forEach(x => document.getElementById(x).value='');
            await loadAdminPanel();
        } catch (e) { msgEl.textContent='ì„œë²„ ì˜¤ë¥˜: ' + e.message; msgEl.classList.add('visible'); }
        btn.disabled=false; btn.innerHTML='ê³„ì • ìƒì„±';
    }

    async function changeUserRole(userId, newRole) {
        const roleLabel = newRole === 'admin' ? 'ê´€ë¦¬ì' : 'ì„ì‹œê´€ë¦¬ì';
        if (!confirm(`ì´ ê³„ì •ì˜ ê¶Œí•œì„ [${roleLabel}]ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        try {
            const users = await fbGetAll('sysUsers');
            const u = users.find(u => u.id === userId); if (!u) return;
            u.role = newRole;
            await fbSet('sysUsers', userId, u);
            await loadAdminPanel();
            alert(`âœ… ${u.name}(${u.id}) ê¶Œí•œì´ [${roleLabel}]ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } catch (e) { alert('ì²˜ë¦¬ ì‹¤íŒ¨: ' + e.message); }
    }
    async function deleteUser(userId) {
        try {
            const users = await fbGetAll('sysUsers');
            const u = users.find(u => u.id===userId);
            if (!u||!confirm(`${u.name}(${u.id}) íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            await fbDel('sysUsers', userId); await loadAdminPanel();
        } catch (e) { alert('ì‚­ì œ ì‹¤íŒ¨: ' + e.message); }
    }
    async function updateAdminAccount() {
        const newId=document.getElementById('newAdminId').value.trim();
        const curPw=document.getElementById('currentAdminPw').value;
        const newPw=document.getElementById('newAdminPw').value;
        const newPw2=document.getElementById('newAdminPw2').value;
        const cu=getCurrentUser();
        if (!curPw)              { alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        if (cu.pw!==curPw)       { alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
        if (newId&&newId.length<4){ alert('ì•„ì´ë””ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); return; }
        if (newPw&&newPw.length<6){ alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); return; }
        if (newPw&&newPw!==newPw2){ alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
        try {
            const users = await fbGetAll('sysUsers');
            const me = users.find(u => u.id===cu.id);
            if (!me) { alert('ê³„ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
            if (newId&&newId!==me.id&&users.find(u=>u.id===newId)) { alert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.'); return; }
            const oldId=me.id;
            if (newId) me.id=newId; if (newPw) me.pw=newPw;
            await fbSet('sysUsers', me.id, me);
            if (newId&&newId!==oldId) await fbDel('sysUsers', oldId);
            sessionStorage.setItem('currentUser', JSON.stringify(me));
            document.getElementById('headerUserName').textContent = me.name;
            ['newAdminId','currentAdminPw','newAdminPw','newAdminPw2'].forEach(x => document.getElementById(x).value='');
            alert(`âœ… ê³„ì •ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.\nì•„ì´ë””: ${me.id}`);
        } catch (e) { alert('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + e.message); }
    }
    </script>
</body>
</html>
