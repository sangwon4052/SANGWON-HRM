<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì§ì›ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f0f2f5;min-height:100vh;}

    /* â”€â”€ ì¸ì¦ ì˜¤ë²„ë ˆì´ â”€â”€ */
    #authOverlay{position:fixed;inset:0;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);display:flex;align-items:center;justify-content:center;z-index:9999;}
    #authOverlay.hidden{display:none;}
    .auth-box{background:#fff;border-radius:16px;padding:40px;width:100%;max-width:420px;box-shadow:0 20px 60px rgba(0,0,0,.4);}
    .auth-logo{text-align:center;margin-bottom:28px;}
    .auth-logo h1{font-size:24px;color:#2c3e50;font-weight:700;}
    .auth-logo p{color:#7f8c8d;font-size:14px;margin-top:6px;}
    .auth-tabs{display:flex;border-bottom:2px solid #ecf0f1;margin-bottom:24px;}
    .auth-tab{flex:1;padding:10px;text-align:center;cursor:pointer;font-weight:600;color:#95a5a6;border-bottom:3px solid transparent;margin-bottom:-2px;transition:.2s;}
    .auth-tab.active{color:#3498db;border-bottom-color:#3498db;}
    .auth-form{display:none;}
    .auth-form.active{display:block;}
    .form-group{margin-bottom:16px;}
    .form-group label{display:block;font-size:13px;font-weight:600;color:#555;margin-bottom:6px;}
    .form-group input,.form-group select{width:100%;padding:10px 14px;border:1.5px solid #ddd;border-radius:8px;font-size:14px;transition:.2s;outline:none;}
    .form-group input:focus,.form-group select:focus{border-color:#3498db;}
    .btn-auth{width:100%;padding:12px;background:#3498db;color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;transition:.2s;margin-top:4px;}
    .btn-auth:hover{background:#2980b9;}
    .auth-error{color:#e74c3c;font-size:13px;margin-top:8px;min-height:18px;}
    .auth-success{color:#27ae60;font-size:13px;margin-top:8px;min-height:18px;}

    /* â”€â”€ í—¤ë” â”€â”€ */
    .header{background:linear-gradient(135deg,#2c3e50,#3498db);color:#fff;padding:16px 24px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,.2);}
    .header-left h1{font-size:20px;font-weight:700;}
    .header-left p{font-size:12px;opacity:.8;margin-top:2px;}
    .header-right{display:flex;align-items:center;gap:12px;}
    .user-info{display:flex;align-items:center;gap:8px;}
    .user-avatar{width:36px;height:36px;background:rgba(255,255,255,.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;}
    .user-name{font-size:14px;font-weight:600;}
    .badge-role{font-size:11px;padding:2px 8px;border-radius:20px;font-weight:600;}
    .badge-admin{background:#e74c3c;color:#fff;}
    .badge-user{background:rgba(255,255,255,.25);color:#fff;}
    .btn-header{padding:7px 14px;border:1.5px solid rgba(255,255,255,.5);background:transparent;color:#fff;border-radius:6px;cursor:pointer;font-size:13px;transition:.2s;}
    .btn-header:hover{background:rgba(255,255,255,.15);}

    /* â”€â”€ íƒ­ â”€â”€ */
    .tabs{background:#fff;border-bottom:1px solid #e0e0e0;padding:0 24px;display:flex;gap:0;overflow-x:auto;}
    .tab{padding:14px 20px;cursor:pointer;font-size:14px;font-weight:600;color:#7f8c8d;border-bottom:3px solid transparent;white-space:nowrap;transition:.2s;}
    .tab:hover{color:#3498db;}
    .tab.active{color:#3498db;border-bottom-color:#3498db;}
    .tab.locked{color:#bdc3c7;cursor:not-allowed;}
    .tab-content{display:none;padding:24px;}
    .tab-content.active{display:block;}

    /* â”€â”€ ì»¨í…Œì´ë„ˆ â”€â”€ */
    .main-container{max-width:1400px;margin:0 auto;background:#fff;border-radius:0 0 12px 12px;box-shadow:0 2px 12px rgba(0,0,0,.08);overflow:hidden;}

    /* â”€â”€ ëŒ€ì‹œë³´ë“œ â”€â”€ */
    .dashboard-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:24px;}
    .dash-card{background:#fff;border-radius:12px;padding:20px;border:1px solid #e8ecef;cursor:pointer;transition:.2s;box-shadow:0 2px 8px rgba(0,0,0,.05);}
    .dash-card:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,.1);}
    .dash-icon{font-size:32px;margin-bottom:12px;}
    .dash-value{font-size:32px;font-weight:700;color:#2c3e50;}
    .dash-label{font-size:13px;color:#7f8c8d;margin-top:4px;}
    .dash-card.blue .dash-value{color:#3498db;}
    .dash-card.green .dash-value{color:#27ae60;}
    .dash-card.red .dash-value{color:#e74c3c;}
    .dash-card.orange .dash-value{color:#e67e22;}

    /* â”€â”€ ì„¹ì…˜ í—¤ë” â”€â”€ */
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px;}
    .section-title{font-size:18px;font-weight:700;color:#2c3e50;}
    .btn-primary{padding:9px 18px;background:#3498db;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:.2s;}
    .btn-primary:hover{background:#2980b9;}
    .btn-success{padding:9px 18px;background:#27ae60;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:.2s;}
    .btn-success:hover{background:#229954;}
    .btn-danger{padding:7px 14px;background:#e74c3c;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;transition:.2s;}
    .btn-danger:hover{background:#c0392b;}
    .btn-warning{padding:7px 14px;background:#f39c12;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;transition:.2s;}
    .btn-warning:hover{background:#e67e22;}
    .btn-info{padding:7px 14px;background:#17a2b8;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;transition:.2s;}
    .btn-secondary{padding:7px 14px;background:#95a5a6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;transition:.2s;}

    /* â”€â”€ ê²€ìƒ‰ â”€â”€ */
    .search-bar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
    .search-bar input{flex:1;min-width:200px;padding:9px 14px;border:1.5px solid #ddd;border-radius:8px;font-size:14px;outline:none;}
    .search-bar input:focus{border-color:#3498db;}

    /* â”€â”€ í…Œì´ë¸” â”€â”€ */
    .table-wrap{overflow-x:auto;border-radius:10px;border:1px solid #e8ecef;}
    table{width:100%;border-collapse:collapse;font-size:14px;}
    th{background:#f8f9fa;padding:12px 14px;text-align:left;font-weight:700;color:#555;border-bottom:2px solid #e0e0e0;}
    td{padding:11px 14px;border-bottom:1px solid #f0f0f0;color:#333;vertical-align:middle;}
    tr:hover td{background:#fafbfc;}
    tr:last-child td{border-bottom:none;}
    .badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600;}
    .badge-active{background:#d5f5e3;color:#27ae60;}
    .badge-inactive{background:#fde8e8;color:#e74c3c;}
    .badge-pending{background:#fef9e7;color:#f39c12;}
    .badge-approved{background:#d5f5e3;color:#27ae60;}
    .badge-rejected{background:#fde8e8;color:#e74c3c;}
    .badge-dday{background:#fde8e8;color:#e74c3c;}
    .badge-imminent{background:#fef9e7;color:#e67e22;}
    .badge-scheduled{background:#d6eaf8;color:#2980b9;}
    .badge-completed{background:#f2f3f4;color:#7f8c8d;}
    .actions{display:flex;gap:6px;flex-wrap:wrap;}
    .empty-msg{text-align:center;padding:40px;color:#aaa;font-size:15px;}

    /* â”€â”€ ëª¨ë‹¬ â”€â”€ */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;}
    .modal-overlay.hidden{display:none;}
    .modal{background:#fff;border-radius:14px;width:100%;max-width:660px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3);}
    .modal-header{padding:20px 24px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;z-index:1;}
    .modal-header h3{font-size:17px;font-weight:700;color:#2c3e50;}
    .modal-close{background:none;border:none;font-size:22px;cursor:pointer;color:#aaa;line-height:1;}
    .modal-body{padding:24px;}
    .modal-footer{padding:16px 24px;border-top:1px solid #eee;display:flex;justify-content:flex-end;gap:10px;position:sticky;bottom:0;background:#fff;}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    .form-row.single{grid-template-columns:1fr;}
    .section-divider{margin:20px 0 16px;font-size:13px;font-weight:700;color:#7f8c8d;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid #eee;padding-bottom:8px;}

    /* â”€â”€ ìê²©ì¦ â”€â”€ */
    .cert-block{background:#f8f9fa;border-radius:10px;padding:16px;margin-bottom:14px;border:1px solid #e8ecef;position:relative;}
    .cert-block .remove-cert{position:absolute;top:10px;right:10px;background:none;border:none;color:#e74c3c;font-size:18px;cursor:pointer;}
    .edu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-top:10px;}

    /* â”€â”€ ì—°ì°¨ â”€â”€ */
    .leave-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:20px;}
    .leave-card{background:#f8f9fa;border-radius:10px;padding:16px;text-align:center;border:1px solid #e8ecef;}
    .leave-card .val{font-size:28px;font-weight:700;color:#3498db;}
    .leave-card .lbl{font-size:12px;color:#7f8c8d;margin-top:4px;}

    /* â”€â”€ ë°±ì—… â”€â”€ */
    .backup-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;}
    .backup-card{background:#f8f9fa;border-radius:12px;padding:24px;border:1px solid #e8ecef;}
    .backup-card h3{font-size:16px;font-weight:700;margin-bottom:8px;color:#2c3e50;}
    .backup-card p{font-size:13px;color:#7f8c8d;margin-bottom:16px;}
    .stat-list{list-style:none;margin-top:12px;}
    .stat-list li{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #e0e0e0;font-size:13px;}
    .stat-list li:last-child{border-bottom:none;}

    /* â”€â”€ ë¡œë”© â”€â”€ */
    #loadingOverlay{position:fixed;inset:0;background:rgba(255,255,255,.85);z-index:8000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
    #loadingOverlay.hidden{display:none;}
    .spinner{width:44px;height:44px;border:4px solid #e0e0e0;border-top-color:#3498db;border-radius:50%;animation:spin .8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}

    /* â”€â”€ ì•Œë¦¼ í† ìŠ¤íŠ¸ â”€â”€ */
    #toast{position:fixed;bottom:30px;right:30px;padding:12px 22px;border-radius:10px;color:#fff;font-size:14px;font-weight:600;z-index:9998;opacity:0;transition:opacity .3s;pointer-events:none;}
    #toast.show{opacity:1;}
    #toast.success{background:#27ae60;}
    #toast.error{background:#e74c3c;}
    #toast.info{background:#3498db;}

    /* ë°˜ì‘í˜• */
    @media(max-width:600px){
      .form-row{grid-template-columns:1fr;}
      .header{flex-wrap:wrap;gap:10px;}
      .edu-grid{grid-template-columns:1fr 1fr;}
    }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ë¡œë”© â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <p style="color:#555;font-size:15px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• í† ìŠ¤íŠ¸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ì¸ì¦ ì˜¤ë²„ë ˆì´ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="authOverlay">
  <div class="auth-box">
    <div class="auth-logo">
      <h1>ğŸ¢ ì§ì›ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
      <p>ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
    </div>
    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchAuthTab('login')">ë¡œê·¸ì¸</div>
      <div class="auth-tab" onclick="switchAuthTab('register')">íšŒì›ê°€ì…</div>
    </div>
    <!-- ë¡œê·¸ì¸ -->
    <div id="loginForm" class="auth-form active">
      <div class="form-group"><label>ì•„ì´ë””</label><input id="loginId" placeholder="ì•„ì´ë”” ì…ë ¥" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <div class="form-group"><label>ë¹„ë°€ë²ˆí˜¸</label><input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <button class="btn-auth" onclick="doLogin()">ë¡œê·¸ì¸</button>
      <div id="loginError" class="auth-error"></div>
    </div>
    <!-- íšŒì›ê°€ì… -->
    <div id="registerForm" class="auth-form">
      <div class="form-group"><label>ì´ë¦„(ì‹¤ëª…)</label><input id="regName" placeholder="ì‹¤ëª… ì…ë ¥"></div>
      <div class="form-group"><label>ì•„ì´ë”” (4ì ì´ìƒ)</label><input id="regId" placeholder="ì•„ì´ë”” ì…ë ¥"></div>
      <div class="form-group"><label>ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label><input id="regPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"></div>
      <div class="form-group"><label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input id="regPw2" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥"></div>
      <button class="btn-auth" onclick="doRegister()">ê°€ì… ì‹ ì²­</button>
      <div id="registerMsg" class="auth-error"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ë©”ì¸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mainApp" style="display:none;">
  <!-- í—¤ë” -->
  <div class="header">
    <div class="header-left">
      <h1>ğŸ¢ ì§ì›ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
      <p>Firebase ì‹¤ì‹œê°„ ì—°ë™</p>
    </div>
    <div class="header-right">
      <div class="user-info">
        <div class="user-avatar">ğŸ‘¤</div>
        <div>
          <div class="user-name" id="headerUserName"></div>
          <span id="headerRoleBadge" class="badge-role"></span>
        </div>
      </div>
      <button class="btn-header" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

  <!-- íƒ­ ë©”ë‰´ -->
  <div class="main-container">
    <div class="tabs">
      <div class="tab active" id="tab-dashboard" onclick="switchTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</div>
      <div class="tab" id="tab-employees" onclick="switchTab('employees')">ğŸ‘¥ ì§ì›ê´€ë¦¬</div>
      <div class="tab locked" id="tab-leaves" onclick="switchTab('leaves')">ğŸ“… ì—°ì°¨ê´€ë¦¬ ğŸ”’</div>
      <div class="tab" id="tab-education" onclick="switchTab('education')">ğŸ“š ì§ë¬´êµìœ¡</div>
      <div class="tab" id="tab-backup" onclick="switchTab('backup')">ğŸ’¾ ë°±ì—…ê´€ë¦¬</div>
      <div class="tab locked" id="tab-admin" onclick="switchTab('admin')">ğŸ›¡ï¸ ê´€ë¦¬ìíŒ¨ë„ ğŸ”’</div>
    </div>

    <!-- â”€â”€ ëŒ€ì‹œë³´ë“œ â”€â”€ -->
    <div id="content-dashboard" class="tab-content active">
      <div class="dashboard-cards">
        <div class="dash-card blue" onclick="switchTab('employees')">
          <div class="dash-icon">ğŸ‘¥</div>
          <div class="dash-value" id="dc-total">0</div>
          <div class="dash-label">ì „ì²´ ì§ì›</div>
        </div>
        <div class="dash-card green" onclick="goEmpFilter('active')">
          <div class="dash-icon">âœ…</div>
          <div class="dash-value" id="dc-active">0</div>
          <div class="dash-label">ì¬ì§ ì§ì›</div>
        </div>
        <div class="dash-card red" onclick="goEmpFilter('inactive')">
          <div class="dash-icon">ğŸ“¤</div>
          <div class="dash-value" id="dc-inactive">0</div>
          <div class="dash-label">í‡´ì‚¬ ì§ì›</div>
        </div>
        <div class="dash-card orange" onclick="switchTab('education')">
          <div class="dash-icon">ğŸ“š</div>
          <div class="dash-value" id="dc-edu">0</div>
          <div class="dash-label">êµìœ¡ ì˜ˆì • (6ê°œì›”)</div>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>ì„±ëª…</th><th>ì „í™”ë²ˆí˜¸</th><th>ì…ì‚¬ì¼</th><th>ìê²©ì¦</th><th>ìƒíƒœ</th></tr></thead>
          <tbody id="dashEmpTable"><tr><td colspan="5" class="empty-msg">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ ì§ì›ê´€ë¦¬ â”€â”€ -->
    <div id="content-employees" class="tab-content">
      <div class="section-header">
        <div class="section-title">ğŸ‘¥ ì§ì›ê´€ë¦¬</div>
        <button class="btn-primary" onclick="openEmpModal()">+ ì§ì› ë“±ë¡</button>
      </div>
      <div class="search-bar">
        <input id="empSearch" placeholder="ğŸ” ì´ë¦„, ì „í™”ë²ˆí˜¸, ì´ë©”ì¼ ê²€ìƒ‰..." oninput="renderEmployees()">
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>ì„±ëª…</th><th>ì„±ë³„</th><th>ì „í™”ë²ˆí˜¸</th><th>ì´ë©”ì¼</th><th>ìê²©ì¦</th><th>ì…ì‚¬ì¼</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
          <tbody id="empTable"><tr><td colspan="8" class="empty-msg">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ ì—°ì°¨ê´€ë¦¬ â”€â”€ -->
    <div id="content-leaves" class="tab-content">
      <div class="section-header">
        <div class="section-title">ğŸ“… ì—°ì°¨ê´€ë¦¬</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <span style="font-size:14px;color:#555;">íšŒê³„ë…„ë„:</span>
          <input id="fiscalYear" type="number" value="" style="width:80px;padding:7px 10px;border:1.5px solid #ddd;border-radius:6px;font-size:14px;">
          <button class="btn-primary" onclick="recalcLeaves()">ğŸ”„ ì¬ê³„ì‚°</button>
          <button class="btn-success" onclick="openBulkLeaveModal()">ğŸ“‹ ì¼ê´„ ì—°ì°¨</button>
        </div>
      </div>
      <div class="leave-summary">
        <div class="leave-card"><div class="val" id="ls-total">0</div><div class="lbl">ëŒ€ìƒ ì§ì›</div></div>
        <div class="leave-card"><div class="val" id="ls-avgTotal" style="color:#27ae60;">0</div><div class="lbl">í‰ê·  ì´ì—°ì°¨</div></div>
        <div class="leave-card"><div class="val" id="ls-avgUsed" style="color:#e74c3c;">0</div><div class="lbl">í‰ê·  ì‚¬ìš©ì—°ì°¨</div></div>
        <div class="leave-card"><div class="val" id="ls-avgRemain" style="color:#e67e22;">0</div><div class="lbl">í‰ê·  ì”ì—¬ì—°ì°¨</div></div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>ì„±ëª…</th><th>ì…ì‚¬ì¼</th><th>ê·¼ì†ì—°ìˆ˜</th><th>ì´ì—°ì°¨</th><th>ì‚¬ìš©</th><th>ì”ì—¬</th><th>ê´€ë¦¬</th></tr></thead>
          <tbody id="leaveTable"><tr><td colspan="7" class="empty-msg">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ ì§ë¬´êµìœ¡ â”€â”€ -->
    <div id="content-education" class="tab-content">
      <div class="section-header">
        <div class="section-title">ğŸ“š ì§ë¬´êµìœ¡</div>
      </div>
      <div class="search-bar">
        <input id="eduSearch" placeholder="ğŸ” ì´ë¦„, ìê²©ì¦ëª… ê²€ìƒ‰..." oninput="renderEducation()">
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>ì„±ëª…</th><th>ìê²©ì¦ëª…</th><th>ì·¨ë“ì¼</th><th>êµìœ¡ìœ í˜•</th><th>êµìœ¡ì¼ì •</th><th>D-Day</th><th>ìƒíƒœ</th></tr></thead>
          <tbody id="eduTable"><tr><td colspan="7" class="empty-msg">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â”€â”€ ë°±ì—…ê´€ë¦¬ â”€â”€ -->
    <div id="content-backup" class="tab-content">
      <div class="section-header"><div class="section-title">ğŸ’¾ ë°±ì—…ê´€ë¦¬</div></div>
      <div class="backup-grid">
        <div class="backup-card">
          <h3>ğŸ“¥ ë°ì´í„° ë°±ì—…</h3>
          <p>í˜„ì¬ Firebaseì— ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</p>
          <button class="btn-primary" onclick="downloadBackup()">ë°±ì—… ë‹¤ìš´ë¡œë“œ</button>
        </div>
        <div class="backup-card">
          <h3>ğŸ“¤ ë°ì´í„° ë³µì›</h3>
          <p>ë°±ì—… JSON íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ Firebaseì— ë°ì´í„°ë¥¼ ë³µì›í•©ë‹ˆë‹¤.</p>
          <input type="file" id="restoreFile" accept=".json" style="display:none" onchange="restoreBackup(event)">
          <button class="btn-warning" onclick="document.getElementById('restoreFile').click()">ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        <div class="backup-card">
          <h3>ğŸ“Š ë°ì´í„° í˜„í™©</h3>
          <ul class="stat-list" id="statList">
            <li><span>ì „ì²´ ì§ì›</span><span id="st-emp">-</span></li>
            <li><span>ì—°ì°¨ ê¸°ë¡</span><span id="st-leave">-</span></li>
            <li><span>êµìœ¡ ì¼ì •</span><span id="st-edu">-</span></li>
            <li><span>ì‹œìŠ¤í…œ ì‚¬ìš©ì</span><span id="st-user">-</span></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- â”€â”€ ê´€ë¦¬ì íŒ¨ë„ â”€â”€ -->
    <div id="content-admin" class="tab-content">
      <div class="section-header"><div class="section-title">ğŸ›¡ï¸ ê´€ë¦¬ì íŒ¨ë„</div></div>

      <!-- ìŠ¹ì¸ ëŒ€ê¸° -->
      <div style="margin-bottom:32px;">
        <h3 style="font-size:16px;font-weight:700;color:#e74c3c;margin-bottom:14px;">â³ ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡</h3>
        <div class="table-wrap">
          <table>
            <thead><tr><th>ì•„ì´ë””</th><th>ì´ë¦„</th><th>ê°€ì…ì¼</th><th>ê´€ë¦¬</th></tr></thead>
            <tbody id="pendingTable"><tr><td colspan="4" class="empty-msg">ëŒ€ê¸° ì¤‘ì¸ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- ì „ì²´ íšŒì› -->
      <div style="margin-bottom:32px;">
        <h3 style="font-size:16px;font-weight:700;color:#2c3e50;margin-bottom:14px;">ğŸ‘¤ ì „ì²´ íšŒì› ëª©ë¡</h3>
        <div class="table-wrap">
          <table>
            <thead><tr><th>ì•„ì´ë””</th><th>ì´ë¦„</th><th>ê¶Œí•œ</th><th>ìƒíƒœ</th><th>ê°€ì…ì¼</th><th>ê´€ë¦¬</th></tr></thead>
            <tbody id="allUserTable"><tr><td colspan="6" class="empty-msg">ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- ê´€ë¦¬ì ê³„ì • ì„¤ì • -->
      <div>
        <h3 style="font-size:16px;font-weight:700;color:#2c3e50;margin-bottom:14px;">âš™ï¸ ê´€ë¦¬ì ê³„ì • ì„¤ì •</h3>
        <div style="background:#f8f9fa;border-radius:12px;padding:24px;max-width:420px;border:1px solid #e8ecef;">
          <div class="form-group"><label>ìƒˆ ì•„ì´ë””</label><input id="newAdminId" placeholder="ë³€ê²½í•  ì•„ì´ë””"></div>
          <div class="form-group"><label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label><input id="curAdminPw" type="password" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸"></div>
          <div class="form-group"><label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input id="newAdminPw" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)"></div>
          <div class="form-group"><label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input id="newAdminPw2" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥"></div>
          <button class="btn-primary" onclick="updateAdminAccount()">ê³„ì • ì—…ë°ì´íŠ¸</button>
          <div id="adminAccMsg" class="auth-error"></div>
        </div>
      </div>
    </div>

  </div><!-- /main-container -->
</div><!-- /mainApp -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â• ì§ì› ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="empModal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <h3 id="empModalTitle">ì§ì› ë“±ë¡</h3>
      <button class="modal-close" onclick="closeEmpModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="empId">
      <div class="form-row">
        <div class="form-group"><label>ì„±ëª… *</label><input id="empName" placeholder="ì„±ëª…"></div>
        <div class="form-group"><label>ì„±ë³„ *</label>
          <select id="empGender"><option value="">ì„ íƒ</option><option value="ë‚¨">ë‚¨</option><option value="ì—¬">ì—¬</option></select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>ì „í™”ë²ˆí˜¸</label><input id="empPhone" placeholder="010-0000-0000"></div>
        <div class="form-group"><label>ì´ë©”ì¼</label><input id="empEmail" type="email" placeholder="email@example.com"></div>
      </div>
      <div class="form-row single">
        <div class="form-group"><label>ì£¼ì†Œ</label><input id="empAddress" placeholder="ì£¼ì†Œ ì…ë ¥"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>ì…ì‚¬ì¼ *</label><input id="empHire" type="date"></div>
        <div class="form-group"><label>í‡´ì‚¬ì¼</label><input id="empResign" type="date"></div>
      </div>

      <div class="section-divider">ğŸ“œ ìê²©ì¦ ì •ë³´</div>
      <div id="certList"></div>
      <button class="btn-info" onclick="addCert()" style="margin-top:4px;width:100%;">+ ìê²©ì¦ ì¶”ê°€</button>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeEmpModal()">ì·¨ì†Œ</button>
      <button class="btn-primary" onclick="saveEmployee()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• ì§ì› ìƒì„¸ ëª¨ë‹¬ â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="detailModal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <h3>ì§ì› ìƒì„¸ ì •ë³´</h3>
      <button class="modal-close" onclick="document.getElementById('detailModal').classList.add('hidden')">âœ•</button>
    </div>
    <div class="modal-body" id="detailBody"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• ì—°ì°¨ ì‚¬ìš© ë“±ë¡ ëª¨ë‹¬ â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="leaveUseModal" class="modal-overlay hidden">
  <div class="modal" style="max-width:440px;">
    <div class="modal-header">
      <h3 id="leaveUseTitle">ì—°ì°¨ ì‚¬ìš© ë“±ë¡</h3>
      <button class="modal-close" onclick="document.getElementById('leaveUseModal').classList.add('hidden')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="leaveEmpId">
      <div class="form-group"><label>ì‚¬ìš© ì¼ìˆ˜</label>
        <select id="leaveDays"><option value="0.5">0.5ì¼ (ë°˜ì°¨)</option><option value="1" selected>1ì¼</option><option value="1.5">1.5ì¼</option><option value="2">2ì¼</option><option value="3">3ì¼</option><option value="4">4ì¼</option><option value="5">5ì¼</option></select>
      </div>
      <div class="form-group"><label>ì‚¬ìš© ë‚ ì§œ</label><input id="leaveDate" type="date"></div>
      <div class="form-group"><label>ì‚¬ìœ </label><input id="leaveReason" placeholder="ì˜ˆ: ê°œì¸ ì‚¬ì •, ë³‘ê°€ ë“±"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="document.getElementById('leaveUseModal').classList.add('hidden')">ì·¨ì†Œ</button>
      <button class="btn-primary" onclick="saveLeaveUse()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• ì—°ì°¨ ë‚´ì—­ ëª¨ë‹¬ â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="leaveHistModal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-header">
      <h3 id="leaveHistTitle">ì—°ì°¨ ì‚¬ìš© ë‚´ì—­</h3>
      <button class="modal-close" onclick="document.getElementById('leaveHistModal').classList.add('hidden')">âœ•</button>
    </div>
    <div class="modal-body" id="leaveHistBody"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• ì¼ê´„ ì—°ì°¨ ëª¨ë‹¬ â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="bulkLeaveModal" class="modal-overlay hidden">
  <div class="modal" style="max-width:500px;">
    <div class="modal-header">
      <h3>ğŸ“‹ ì¼ê´„ ì—°ì°¨ ë“±ë¡</h3>
      <button class="modal-close" onclick="document.getElementById('bulkLeaveModal').classList.add('hidden')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label>ì‚¬ìš© ì¼ìˆ˜</label>
        <select id="bulkDays" onchange="updateBulkPreview()"><option value="0.5">0.5ì¼</option><option value="1" selected>1ì¼</option><option value="1.5">1.5ì¼</option><option value="2">2ì¼</option><option value="3">3ì¼</option></select>
      </div>
      <div class="form-group"><label>ì‚¬ìš© ë‚ ì§œ</label><input id="bulkDate" type="date" onchange="updateBulkPreview()"></div>
      <div class="form-group"><label>ì‚¬ìœ </label><input id="bulkReason" placeholder="ì˜ˆ: íšŒì‚¬ ì°½ë¦½ê¸°ë…ì¼"></div>
      <div id="bulkPreview" style="background:#f8f9fa;border-radius:8px;padding:14px;margin-top:12px;font-size:13px;color:#555;display:none;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="document.getElementById('bulkLeaveModal').classList.add('hidden')">ì·¨ì†Œ</button>
      <button class="btn-primary" onclick="saveBulkLeave()">ì¼ê´„ ì ìš©</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Firebase REST API ì„¤ì •
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FB_PROJ = 'sangwon-hrm';
const FB_KEY  = 'AIzaSyBebDpB0eFP2yDZ4NK6K8IoWS8aTseHkzc';
const FB_BASE = `https://firestore.googleapis.com/v1/projects/${FB_PROJ}/databases/(default)/documents`;

// â”€â”€ Firestore íƒ€ì… ë³€í™˜ â”€â”€
function toFV(v){
  if(v===null||v===undefined) return {nullValue:null};
  if(typeof v==='boolean') return {booleanValue:v};
  if(typeof v==='number') return Number.isInteger(v)?{integerValue:String(v)}:{doubleValue:v};
  if(typeof v==='string') return {stringValue:v};
  if(Array.isArray(v)) return {arrayValue:{values:v.map(toFV)}};
  if(typeof v==='object') return {mapValue:{fields:toFs(v)}};
  return {stringValue:String(v)};
}
function toFs(obj){
  const f={};
  for(const k in obj) if(obj[k]!==undefined) f[k]=toFV(obj[k]);
  return f;
}
function fromFV(fv){
  if(!fv) return null;
  if('nullValue' in fv) return null;
  if('booleanValue' in fv) return fv.booleanValue;
  if('integerValue' in fv) return Number(fv.integerValue);
  if('doubleValue' in fv) return fv.doubleValue;
  if('stringValue' in fv) return fv.stringValue;
  if('arrayValue' in fv) return (fv.arrayValue.values||[]).map(fromFV);
  if('mapValue' in fv) return fromFs(fv.mapValue.fields||{});
  return null;
}
function fromFs(fields){
  const o={};
  for(const k in fields) o[k]=fromFV(fields[k]);
  return o;
}

// â”€â”€ CRUD â”€â”€
async function fbGetAll(col){
  const r=await fetch(`${FB_BASE}/${col}?key=${FB_KEY}&pageSize=500`);
  if(!r.ok) throw new Error(`HTTP ${r.status} (${col})`);
  const j=await r.json();
  if(!j.documents) return [];
  return j.documents.map(d=>({_docId:d.name.split('/').pop(),...fromFs(d.fields||{})}));
}
async function fbSet(col,id,data){
  const eid=encodeURIComponent(String(id));
  const body={fields:toFs(JSON.parse(JSON.stringify(data)))};
  const r=await fetch(`${FB_BASE}/${col}/${eid}?key=${FB_KEY}`,{
    method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)
  });
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
}
async function fbDel(col,id){
  const eid=encodeURIComponent(String(id));
  const r=await fetch(`${FB_BASE}/${col}/${eid}?key=${FB_KEY}`,{method:'DELETE'});
  if(!r.ok&&r.status!==404) throw new Error(`HTTP ${r.status}`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì•± ìƒíƒœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let employees=[], annualLeaves=[], educations=[], sysUsers=[];
let currentUser=null, currentTab='dashboard';
// sessionStorage ëŒ€ì‹  ë©”ëª¨ë¦¬ ë³€ìˆ˜ ì‚¬ìš© (sandbox í™˜ê²½ í˜¸í™˜)
window._currentUserCache=null;
let _empFilterStatus='';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì´ˆê¸° ë¡œë“œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAll(){
  showLoading(true);
  try{
    [employees,annualLeaves,educations,sysUsers]=await Promise.all([
      fbGetAll('employees'),fbGetAll('annualLeaves'),
      fbGetAll('educations'),fbGetAll('sysUsers')
    ]);
    // ê´€ë¦¬ì ê³„ì • ì—†ìœ¼ë©´ ìƒì„±
    if(!sysUsers.find(u=>u.role==='admin')){
      const adm={id:'admin',pw:'admin1234',name:'ê´€ë¦¬ì',role:'admin',status:'approved',createdAt:new Date().toISOString()};
      await fbSet('sysUsers','admin',adm);
      sysUsers=[adm];
    }
  }catch(e){
    showFatalError('Firebase ì—°ê²° ì‹¤íŒ¨: '+e.message);
    return false;
  }finally{ showLoading(false); }
  return true;
}

async function init(){
  const ok=await loadAll();
  if(!ok) return;
  const saved=window._currentUserCache;
  if(saved){
    currentUser=typeof saved==='string'?JSON.parse(saved):saved;
    // ì‚¬ìš©ì ì •ë³´ ìµœì‹ í™”
    const fresh=sysUsers.find(u=>u.id===currentUser.id);
    if(fresh&&fresh.status==='approved'){
      currentUser=fresh;
      window._currentUserCache=currentUser;
      enterApp();
    } else { showAuthOverlay(); }
  } else { showAuthOverlay(); }
}

function showAuthOverlay(){ document.getElementById('authOverlay').classList.remove('hidden'); }
function hideAuthOverlay(){ document.getElementById('authOverlay').classList.add('hidden'); }
function showLoading(v){ document.getElementById('loadingOverlay').classList.toggle('hidden',!v); }

function showFatalError(msg){
  document.getElementById('loadingOverlay').classList.add('hidden');
  document.body.innerHTML=`<div style="display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column;gap:16px;font-family:sans-serif;">
    <div style="font-size:56px">âŒ</div>
    <h2 style="color:#e74c3c">ì—°ê²° ì˜¤ë¥˜</h2>
    <p style="color:#7f8c8d">${msg}</p>
    <button onclick="location.reload()" style="padding:10px 24px;background:#3498db;color:#fff;border:none;border-radius:8px;font-size:15px;cursor:pointer;">ë‹¤ì‹œ ì‹œë„</button>
  </div>`;
}

function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='show '+type;
  setTimeout(()=>t.className='',2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì¸ì¦
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchAuthTab(t){
  document.querySelectorAll('.auth-tab').forEach((el,i)=>el.classList.toggle('active',i===(t==='login'?0:1)));
  document.getElementById('loginForm').classList.toggle('active',t==='login');
  document.getElementById('registerForm').classList.toggle('active',t==='register');
}

async function doLogin(){
  const id=document.getElementById('loginId').value.trim();
  const pw=document.getElementById('loginPw').value;
  const errEl=document.getElementById('loginError');
  errEl.textContent='';
  if(!id||!pw){errEl.textContent='ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';return;}
  showLoading(true);
  try{ sysUsers=await fbGetAll('sysUsers'); }
  catch(e){ errEl.textContent='ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.'; showLoading(false); return; }
  showLoading(false);
  const u=sysUsers.find(x=>x.id===id&&x.pw===pw);
  if(!u){errEl.textContent='ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';return;}
  if(u.status==='pending'){errEl.textContent='ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.';return;}
  if(u.status==='rejected'){errEl.textContent='ê°€ì…ì´ ê±°ì ˆëœ ê³„ì •ì…ë‹ˆë‹¤.';return;}
  currentUser=u;
  window._currentUserCache=u;
  hideAuthOverlay();
  enterApp();
}

async function doRegister(){
  const name=document.getElementById('regName').value.trim();
  const id=document.getElementById('regId').value.trim();
  const pw=document.getElementById('regPw').value;
  const pw2=document.getElementById('regPw2').value;
  const msgEl=document.getElementById('registerMsg');
  msgEl.style.color='#e74c3c'; msgEl.textContent='';
  if(!name||!id||!pw||!pw2){msgEl.textContent='ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.';return;}
  if(id.length<4){msgEl.textContent='ì•„ì´ë””ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';return;}
  if(pw.length<6){msgEl.textContent='ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';return;}
  if(pw!==pw2){msgEl.textContent='ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';return;}
  showLoading(true);
  try{ sysUsers=await fbGetAll('sysUsers'); }
  catch(e){ msgEl.textContent='ì„œë²„ ì—°ê²° ì‹¤íŒ¨.'; showLoading(false); return; }
  if(sysUsers.find(u=>u.id===id)){showLoading(false);msgEl.textContent='ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.';return;}
  const newUser={id,pw,name,role:'user',status:'pending',createdAt:new Date().toISOString()};
  try{ await fbSet('sysUsers',id,newUser); sysUsers.push(newUser); }
  catch(e){ msgEl.textContent='ê°€ì… ì²˜ë¦¬ ì‹¤íŒ¨: '+e.message; showLoading(false); return; }
  showLoading(false);
  msgEl.style.color='#27ae60';
  msgEl.textContent='ê°€ì… ì‹ ì²­ì´ ì™„ë£ŒëìŠµë‹ˆë‹¤! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
  document.getElementById('regName').value='';
  document.getElementById('regId').value='';
  document.getElementById('regPw').value='';
  document.getElementById('regPw2').value='';
}

function doLogout(){
  window._currentUserCache=null;
  currentUser=null;
  document.getElementById('mainApp').style.display='none';
  document.getElementById('authOverlay').classList.remove('hidden');
  document.getElementById('loginId').value='';
  document.getElementById('loginPw').value='';
  document.getElementById('loginError').textContent='';
}

function enterApp(){
  document.getElementById('mainApp').style.display='block';
  document.getElementById('headerUserName').textContent=currentUser.name;
  const badge=document.getElementById('headerRoleBadge');
  badge.textContent=currentUser.role==='admin'?'ê´€ë¦¬ì':'ì¼ë°˜';
  badge.className='badge-role '+(currentUser.role==='admin'?'badge-admin':'badge-user');
  // ì—°ì°¨/ê´€ë¦¬ì íƒ­ ì ê¸ˆ í•´ì œ
  const lTab=document.getElementById('tab-leaves');
  const aTab=document.getElementById('tab-admin');
  if(currentUser.role==='admin'){
    lTab.classList.remove('locked'); lTab.textContent='ğŸ“… ì—°ì°¨ê´€ë¦¬';
    aTab.classList.remove('locked'); aTab.textContent='ğŸ›¡ï¸ ê´€ë¦¬ìíŒ¨ë„';
  } else {
    lTab.classList.add('locked'); lTab.textContent='ğŸ“… ì—°ì°¨ê´€ë¦¬ ğŸ”’';
    aTab.classList.add('locked'); aTab.textContent='ğŸ›¡ï¸ ê´€ë¦¬ìíŒ¨ë„ ğŸ”’';
  }
  document.getElementById('fiscalYear').value=new Date().getFullYear();
  switchTab('dashboard');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  íƒ­ ì „í™˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(t){
  if((t==='leaves'||t==='admin')&&currentUser?.role!=='admin'){showToast('ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤','error');return;}
  currentTab=t;
  document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-'+t).classList.add('active');
  document.getElementById('content-'+t).classList.add('active');
  if(t==='dashboard') renderDashboard();
  else if(t==='employees') renderEmployees();
  else if(t==='leaves') renderLeaves();
  else if(t==='education') renderEducation();
  else if(t==='backup') renderBackup();
  else if(t==='admin') renderAdmin();
}

function goEmpFilter(s){ _empFilterStatus=s; switchTab('employees'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ëŒ€ì‹œë³´ë“œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const today=new Date(); today.setHours(0,0,0,0);
  const active=employees.filter(e=>isActive(e));
  const inactive=employees.filter(e=>!isActive(e));
  const sixM=new Date(today); sixM.setMonth(sixM.getMonth()+6);
  const eduCount=educations.filter(e=>{const d=new Date(e.educationDate);return d>=today&&d<=sixM;}).length;
  document.getElementById('dc-total').textContent=employees.length;
  document.getElementById('dc-active').textContent=active.length;
  document.getElementById('dc-inactive').textContent=inactive.length;
  document.getElementById('dc-edu').textContent=eduCount;
  const tbody=document.getElementById('dashEmpTable');
  if(!employees.length){tbody.innerHTML='<tr><td colspan="5" class="empty-msg">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';return;}
  tbody.innerHTML=employees.slice(0,10).map(e=>`
    <tr>
      <td><strong>${e.name||'-'}</strong></td>
      <td>${e.phone||'-'}</td>
      <td>${e.hireDate||'-'}</td>
      <td>${(e.certificates||[]).length}ê°œ</td>
      <td><span class="badge ${isActive(e)?'badge-active':'badge-inactive'}">${isActive(e)?'ì¬ì§':'í‡´ì‚¬'}</span></td>
    </tr>`).join('');
}

function isActive(e){
  if(!e.resignDate) return true;
  return new Date(e.resignDate)>new Date();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì§ì›ê´€ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEmployees(){
  const q=(document.getElementById('empSearch').value||'').toLowerCase();
  let list=employees;
  if(_empFilterStatus==='active') list=list.filter(isActive);
  else if(_empFilterStatus==='inactive') list=list.filter(e=>!isActive(e));
  _empFilterStatus='';
  if(q) list=list.filter(e=>(e.name||'').toLowerCase().includes(q)||(e.phone||'').includes(q)||(e.email||'').toLowerCase().includes(q));
  const tbody=document.getElementById('empTable');
  if(!list.length){tbody.innerHTML='<tr><td colspan="8" class="empty-msg">ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';return;}
  tbody.innerHTML=list.map(e=>`
    <tr>
      <td><strong>${e.name||'-'}</strong></td>
      <td>${e.gender||'-'}</td>
      <td>${e.phone||'-'}</td>
      <td>${e.email||'-'}</td>
      <td>${(e.certificates||[]).length}ê°œ</td>
      <td>${e.hireDate||'-'}</td>
      <td><span class="badge ${isActive(e)?'badge-active':'badge-inactive'}">${isActive(e)?'ì¬ì§':'í‡´ì‚¬'}</span></td>
      <td class="actions">
        <button class="btn-info" onclick="openDetailModal('${e._docId}')">ìƒì„¸</button>
        <button class="btn-warning" onclick="openEmpModal('${e._docId}')">ìˆ˜ì •</button>
        <button class="btn-danger" onclick="deleteEmployee('${e._docId}')">ì‚­ì œ</button>
      </td>
    </tr>`).join('');
}

function openDetailModal(docId){
  const e=employees.find(x=>x._docId===docId); if(!e) return;
  const body=document.getElementById('detailBody');
  const certs=(e.certificates||[]).map(c=>`
    <div style="background:#f8f9fa;border-radius:8px;padding:12px;margin-bottom:8px;border:1px solid #e8ecef;">
      <strong>${c.name||'-'}</strong> (ì·¨ë“ì¼: ${c.date||'-'})
      <div style="margin-top:6px;font-size:13px;color:#555;">
        ${['ì´ˆê¸‰','ì¤‘ê¸‰','ê³ ê¸‰','íŠ¹ê¸‰','í‰ê°€ì‚¬'].map((lv,i)=>`<span style="margin-right:10px;">${lv}: ${c['edu'+(i+1)]||'-'}</span>`).join('')}
      </div>
    </div>`).join('')||'<p style="color:#aaa;">ìê²©ì¦ ì—†ìŒ</p>';
  body.innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
      <div><label style="font-size:12px;color:#999;">ì„±ëª…</label><p style="font-weight:600;">${e.name||'-'}</p></div>
      <div><label style="font-size:12px;color:#999;">ì„±ë³„</label><p>${e.gender||'-'}</p></div>
      <div><label style="font-size:12px;color:#999;">ì „í™”ë²ˆí˜¸</label><p>${e.phone||'-'}</p></div>
      <div><label style="font-size:12px;color:#999;">ì´ë©”ì¼</label><p>${e.email||'-'}</p></div>
      <div><label style="font-size:12px;color:#999;">ì…ì‚¬ì¼</label><p>${e.hireDate||'-'}</p></div>
      <div><label style="font-size:12px;color:#999;">í‡´ì‚¬ì¼</label><p>${e.resignDate||'-'}</p></div>
      <div style="grid-column:1/-1;"><label style="font-size:12px;color:#999;">ì£¼ì†Œ</label><p>${e.address||'-'}</p></div>
    </div>
    <div class="section-divider">ìê²©ì¦ ì •ë³´</div>${certs}`;
  document.getElementById('detailModal').classList.remove('hidden');
}

let certCount=0;
function openEmpModal(docId){
  certCount=0;
  document.getElementById('certList').innerHTML='';
  document.getElementById('empId').value='';
  ['empName','empPhone','empEmail','empAddress','empHire','empResign'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('empGender').value='';
  document.getElementById('empModalTitle').textContent='ì§ì› ë“±ë¡';
  if(docId){
    const e=employees.find(x=>x._docId===docId); if(!e) return;
    document.getElementById('empModalTitle').textContent='ì§ì› ìˆ˜ì •';
    document.getElementById('empId').value=docId;
    document.getElementById('empName').value=e.name||'';
    document.getElementById('empGender').value=e.gender||'';
    document.getElementById('empPhone').value=e.phone||'';
    document.getElementById('empEmail').value=e.email||'';
    document.getElementById('empAddress').value=e.address||'';
    document.getElementById('empHire').value=e.hireDate||'';
    document.getElementById('empResign').value=e.resignDate||'';
    (e.certificates||[]).forEach(c=>addCert(c));
  }
  document.getElementById('empModal').classList.remove('hidden');
}
function closeEmpModal(){ document.getElementById('empModal').classList.add('hidden'); }

function addCert(data={}){
  certCount++;
  const n=certCount;
  const div=document.createElement('div');
  div.className='cert-block'; div.id='cert-'+n;
  div.innerHTML=`
    <button class="remove-cert" onclick="document.getElementById('cert-${n}').remove()">âœ•</button>
    <div class="form-row">
      <div class="form-group"><label>ìê²©ì¦ëª…</label><input class="cert-name" value="${data.name||''}" placeholder="ìê²©ì¦ ì´ë¦„"></div>
      <div class="form-group"><label>ì·¨ë“ì¼</label><input class="cert-date" type="date" value="${data.date||''}"></div>
    </div>
    <div class="edu-grid">
      ${['ì´ˆê¸‰','ì¤‘ê¸‰','ê³ ê¸‰','íŠ¹ê¸‰','í‰ê°€ì‚¬'].map((lv,i)=>`
        <div class="form-group"><label>${lv}êµìœ¡</label><input class="cert-edu" data-idx="${i+1}" type="date" value="${data['edu'+(i+1)]||''}"></div>
      `).join('')}
    </div>`;
  document.getElementById('certList').appendChild(div);
}

function getCertsFromForm(){
  return Array.from(document.querySelectorAll('.cert-block')).map(bl=>{
    const cert={name:bl.querySelector('.cert-name').value,date:bl.querySelector('.cert-date').value};
    bl.querySelectorAll('.cert-edu').forEach(el=>cert['edu'+el.dataset.idx]=el.value);
    return cert;
  });
}

async function saveEmployee(){
  const name=document.getElementById('empName').value.trim();
  const gender=document.getElementById('empGender').value;
  const hireDate=document.getElementById('empHire').value;
  if(!name||!gender||!hireDate){showToast('ì„±ëª…, ì„±ë³„, ì…ì‚¬ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤','error');return;}
  const docId=document.getElementById('empId').value||('emp_'+Date.now());
  const certs=getCertsFromForm();
  const data={
    name,gender,
    phone:document.getElementById('empPhone').value,
    email:document.getElementById('empEmail').value,
    address:document.getElementById('empAddress').value,
    hireDate,resignDate:document.getElementById('empResign').value,
    certificates:certs,
    updatedAt:new Date().toISOString()
  };
  showLoading(true);
  try{
    await fbSet('employees',docId,data);
    // êµìœ¡ ì¼ì • ì—…ë°ì´íŠ¸
    const oldEdus=educations.filter(e=>e.employeeId===docId);
    for(const oe of oldEdus) await fbDel('educations',oe._docId||oe.id);
    const newEdus=[];
    for(const c of certs){
      const eduTypes=['ì´ˆê¸‰','ì¤‘ê¸‰','ê³ ê¸‰','íŠ¹ê¸‰','í‰ê°€ì‚¬'];
      for(let i=0;i<5;i++){
        const dt=c['edu'+(i+1)];
        if(dt){
          const eid='edu_'+Date.now()+'_'+Math.random().toString(36).substr(2,5);
          const ed={employeeId:docId,employeeName:name,certificate:c.name,certificateDate:c.date,educationType:eduTypes[i],educationDate:dt};
          await fbSet('educations',eid,ed);
          newEdus.push({_docId:eid,...ed});
        }
      }
    }
    educations=educations.filter(e=>e.employeeId!==docId).concat(newEdus);
    // ì—°ì°¨ ê³„ì‚°
    await calcLeaveForEmp(docId,name,hireDate);
    // ë¡œì»¬ ì—…ë°ì´íŠ¸
    const idx=employees.findIndex(e=>e._docId===docId);
    if(idx>=0) employees[idx]={_docId:docId,...data};
    else employees.push({_docId:docId,...data});
    closeEmpModal();
    renderEmployees();
    showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤','success');
  }catch(e){ showToast('ì €ì¥ ì‹¤íŒ¨: '+e.message,'error'); }
  finally{ showLoading(false); }
}

async function deleteEmployee(docId){
  if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  showLoading(true);
  try{
    await fbDel('employees',docId);
    const toDelEdu=educations.filter(e=>e.employeeId===docId);
    for(const e of toDelEdu) await fbDel('educations',e._docId);
    const toDelLv=annualLeaves.filter(l=>l.employeeId===docId);
    for(const l of toDelLv) await fbDel('annualLeaves',l._docId);
    employees=employees.filter(e=>e._docId!==docId);
    educations=educations.filter(e=>e.employeeId!==docId);
    annualLeaves=annualLeaves.filter(l=>l.employeeId!==docId);
    renderEmployees();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤','success');
  }catch(e){ showToast('ì‚­ì œ ì‹¤íŒ¨: '+e.message,'error'); }
  finally{ showLoading(false); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì—°ì°¨ê´€ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcLeaveTotal(hireDate,fiscalYear){
  const hire=new Date(hireDate);
  const end=new Date(fiscalYear,11,31);
  if(hire>end) return 0;
  const months=(end.getFullYear()-hire.getFullYear())*12+(end.getMonth()-hire.getMonth());
  if(months<12) return 12;
  const years=Math.floor(months/12);
  let total=15;
  if(years>=3) total+=Math.floor((years-1)/2);
  return Math.min(total,25);
}

async function calcLeaveForEmp(docId,name,hireDate){
  const fy=parseInt(document.getElementById('fiscalYear').value)||new Date().getFullYear();
  const total=calcLeaveTotal(hireDate,fy);
  const existing=annualLeaves.find(l=>l.employeeId===docId&&l.fiscalYear===fy);
  if(existing){
    const used=existing.used||0;
    await fbSet('annualLeaves',existing._docId,{...existing,total,remaining:total-used});
    existing.total=total; existing.remaining=total-used;
  } else {
    const lid='lv_'+Date.now()+'_'+Math.random().toString(36).substr(2,5);
    const lv={employeeId:docId,employeeName:name,fiscalYear:fy,total,used:0,remaining:total,history:[]};
    await fbSet('annualLeaves',lid,lv);
    annualLeaves.push({_docId:lid,...lv});
  }
}

async function recalcLeaves(){
  const fy=parseInt(document.getElementById('fiscalYear').value);
  if(!fy){showToast('íšŒê³„ë…„ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš”','error');return;}
  showLoading(true);
  try{
    for(const e of employees.filter(isActive)){
      await calcLeaveForEmp(e._docId,e.name,e.hireDate);
    }
    annualLeaves=await fbGetAll('annualLeaves');
    renderLeaves();
    showToast('ì¬ê³„ì‚° ì™„ë£Œ','success');
  }catch(e){ showToast('ì¬ê³„ì‚° ì‹¤íŒ¨: '+e.message,'error'); }
  finally{ showLoading(false); }
}

function renderLeaves(){
  const fy=parseInt(document.getElementById('fiscalYear').value)||new Date().getFullYear();
  const list=annualLeaves.filter(l=>l.fiscalYear===fy);
  const tbody=document.getElementById('leaveTable');
  // ìš”ì•½
  document.getElementById('ls-total').textContent=list.length;
  if(list.length){
    document.getElementById('ls-avgTotal').textContent=(list.reduce((s,l)=>s+(l.total||0),0)/list.length).toFixed(1);
    document.getElementById('ls-avgUsed').textContent=(list.reduce((s,l)=>s+(l.used||0),0)/list.length).toFixed(1);
    document.getElementById('ls-avgRemain').textContent=(list.reduce((s,l)=>s+(l.remaining||0),0)/list.length).toFixed(1);
  }
  if(!list.length){tbody.innerHTML='<tr><td colspan="7" class="empty-msg">ì—°ì°¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤ (ì¬ê³„ì‚° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”)</td></tr>';return;}
  tbody.innerHTML=list.map(l=>{
    const e=employees.find(x=>x._docId===l.employeeId);
    const hire=e?e.hireDate:'-';
    const years=hire!=='-'?((new Date(fy,11,31)-new Date(hire))/(1000*60*60*24*365.25)).toFixed(1):'-';
    return `<tr>
      <td><strong>${l.employeeName||'-'}</strong></td>
      <td>${hire}</td>
      <td>${years}ë…„</td>
      <td style="color:#27ae60;font-weight:700;">${l.total||0}</td>
      <td style="color:#e74c3c;font-weight:700;">${l.used||0}</td>
      <td style="color:#e67e22;font-weight:700;">${l.remaining||0}</td>
      <td class="actions">
        <button class="btn-primary" onclick="openLeaveUseModal('${l._docId}')">ì‚¬ìš©ë“±ë¡</button>
        <button class="btn-info" onclick="openLeaveHist('${l._docId}')">ë‚´ì—­</button>
      </td>
    </tr>`;
  }).join('');
}

function openLeaveUseModal(docId){
  document.getElementById('leaveEmpId').value=docId;
  const l=annualLeaves.find(x=>x._docId===docId);
  document.getElementById('leaveUseTitle').textContent=`ì—°ì°¨ ì‚¬ìš© ë“±ë¡ - ${l?.employeeName||''} (ì”ì—¬ ${l?.remaining||0}ì¼)`;
  document.getElementById('leaveDate').value=new Date().toISOString().split('T')[0];
  document.getElementById('leaveDays').value='1';
  document.getElementById('leaveReason').value='';
  document.getElementById('leaveUseModal').classList.remove('hidden');
}

async function saveLeaveUse(){
  const docId=document.getElementById('leaveEmpId').value;
  const days=parseFloat(document.getElementById('leaveDays').value);
  const date=document.getElementById('leaveDate').value;
  const reason=document.getElementById('leaveReason').value;
  if(!date){showToast('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”','error');return;}
  const l=annualLeaves.find(x=>x._docId===docId);
  if(!l){showToast('ë°ì´í„° ì˜¤ë¥˜','error');return;}
  if(l.remaining<days){showToast('ì”ì—¬ ì—°ì°¨ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤','error');return;}
  l.used=(l.used||0)+days;
  l.remaining=(l.remaining||0)-days;
  l.history=[...(l.history||[]),{days,date,reason,createdAt:new Date().toISOString()}];
  showLoading(true);
  try{
    await fbSet('annualLeaves',docId,l);
    document.getElementById('leaveUseModal').classList.add('hidden');
    renderLeaves();
    showToast('ì—°ì°¨ ì‚¬ìš©ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤','success');
  }catch(e){ showToast('ì €ì¥ ì‹¤íŒ¨: '+e.message,'error'); }
  finally{ showLoading(false); }
}

function openLeaveHist(docId){
  const l=annualLeaves.find(x=>x._docId===docId); if(!l) return;
  document.getElementById('leaveHistTitle').textContent=`ì—°ì°¨ ë‚´ì—­ - ${l.employeeName}`;
  const hist=(l.history||[]);
  const body=document.getElementById('leaveHistBody');
  if(!hist.length){body.innerHTML='<p style="color:#aaa;text-align:center;padding:20px;">ì‚¬ìš© ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
  }else{
    body.innerHTML=`<table style="width:100%;border-collapse:collapse;font-size:14px;">
      <thead><tr style="background:#f8f9fa;">
        <th style="padding:10px;text-align:left;border-bottom:2px solid #eee;">ë‚ ì§œ</th>
        <th style="padding:10px;text-align:left;border-bottom:2px solid #eee;">ì¼ìˆ˜</th>
        <th style="padding:10px;text-align:left;border-bottom:2px solid #eee;">ì‚¬ìœ </th>
        <th style="padding:10px;border-bottom:2px solid #eee;">ì‚­ì œ</th>
      </tr></thead>
      <tbody>${hist.map((h,i)=>`
        <tr>
          <td style="padding:10px;border-bottom:1px solid #f0f0f0;">${h.date}</td>
          <td style="padding:10px;border-bottom:1px solid #f0f0f0;">${h.days}ì¼</td>
          <td style="padding:10px;border-bottom:1px solid #f0f0f0;">${h.reason||'-'}</td>
          <td style="padding:10px;border-bottom:1px solid #f0f0f0;text-align:center;">
            <button class="btn-danger" onclick="deleteLeaveHist('${docId}',${i})">ì‚­ì œ</button>
          </td>
        </tr>`).join('')}
      </tbody></table>`;
  }
  document.getElementById('leaveHistModal').classList.remove('hidden');
}

async function deleteLeaveHist(docId,idx){
  if(!confirm('ì´ ë‚´ì—­ì„ ì‚­ì œí• ê¹Œìš”?')) return;
  const l=annualLeaves.find(x=>x._docId===docId); if(!l) return;
  const item=l.history[idx];
  l.used=Math.max(0,(l.used||0)-item.days);
  l.remaining=(l.remaining||0)+item.days;
  l.history.splice(idx,1);
  showLoading(true);
  try{
    await fbSet('annualLeaves',docId,l);
    openLeaveHist(docId);
    renderLeaves();
    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤','success');
  }catch(e){ showToast('ì‚­ì œ ì‹¤íŒ¨: '+e.message,'error'); }
  finally{ showLoading(false); }
}

function openBulkLeaveModal(){
  document.getElementById('bulkDate').value=new Date().toISOString().split('T')[0];
  document.getElementById('bulkDays').value='1';
  document.getElementById('bulkReason').value='';
  document.getElementById('bulkPreview').style.display='none';
  document.getElementById('bulkLeaveModal').classList.remove('hidden');
  updateBulkPreview();
}

function updateBulkPreview(){
  const fy=parseInt(document.getElementById('fiscalYear').value)||new Date().getFullYear();
  const days=parseFloat(document.getElementById('bulkDays').value);
  const list=annualLeaves.filter(l=>l.fiscalYear===fy);
  const ok=list.filter(l=>(l.remaining||0)>=days);
  const skip=list.filter(l=>(l.remaining||0)<days);
  const prev=document.getElementById('bulkPreview');
  prev.style.display='block';
  prev.innerHTML=`âœ… ì ìš© ê°€ëŠ¥: <strong>${ok.length}ëª…</strong> &nbsp;|&nbsp; âš ï¸ ì”ì—¬ ë¶€ì¡±ìœ¼ë¡œ ì œì™¸: <strong style="color:#e74c3c">${skip.length}ëª…</strong>${skip.length?'<br><small>ì œì™¸: '+skip.map(l=>l.employeeName).join(', ')+'</small>':''}`;
}

async function saveBulkLeave(){
  const fy=parseInt(document.getElementById('fiscalYear').value)||new Date().getFullYear();
  const days=parseFloat(document.getElementById('bulkDays').value);
  const date=document.getElementById('bulkDate').value;
  const reason=document.getElementById('bulkReason').value;
  if(!date){showToast('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”','error');return;}
  const list=annualLeaves.filter(l=>l.fiscalYear===fy&&(l.remaining||0)>=days);
  if(!list.length){showToast('ì ìš© ê°€ëŠ¥í•œ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤','error');return;}
  if(!confirm(`${list.length}ëª…ì—ê²Œ ${days}ì¼ ì—°ì°¨ë¥¼ ì¼ê´„ ì ìš©í•©ë‹ˆë‹¤.`)) return;
  showLoading(true);
  try{
    for(const l of list){
      l.used=(l.used||0)+days;
      l.remaining=(l.remaining||0)-days;
      l.history=[...(l.history||[]),{days,date,reason,isBulk:true,createdAt:new Date().toISOString()}];
      await fbSet('annualLeaves',l._docId,l);
    }
    document.getElementById('bulkLeaveModal').classList.add('hidden');
    renderLeaves();
    showToast(`${list.length}ëª… ì¼ê´„ ì ìš© ì™„ë£Œ`,'success');
  }catch(e){ showToast('ì˜¤ë¥˜: '+e.message,'error'); }
  finally{ showLoading(false); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì§ë¬´êµìœ¡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEducation(){
  const q=(document.getElementById('eduSearch').value||'').toLowerCase();
  const today=new Date(); today.setHours(0,0,0,0);
  let list=educations;
  if(q) list=list.filter(e=>(e.employeeName||'').toLowerCase().includes(q)||(e.certificate||'').toLowerCase().includes(q));
  list=list.sort((a,b)=>new Date(a.educationDate)-new Date(b.educationDate));
  const tbody=document.getElementById('eduTable');
  if(!list.length){tbody.innerHTML='<tr><td colspan="7" class="empty-msg">êµìœ¡ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';return;}
  tbody.innerHTML=list.map(e=>{
    const d=new Date(e.educationDate); d.setHours(0,0,0,0);
    const diff=Math.round((d-today)/(1000*60*60*24));
    let badge='',status='';
    if(diff<0){badge='badge-completed';status='ì™„ë£Œ';}
    else if(diff===0){badge='badge-dday';status='D-Day';}
    else if(diff<=30){badge='badge-imminent';status='ì„ë°•';}
    else{badge='badge-scheduled';status='ì˜ˆì •';}
    return `<tr>
      <td><strong>${e.employeeName||'-'}</strong></td>
      <td>${e.certificate||'-'}</td>
      <td>${e.certificateDate||'-'}</td>
      <td>${e.educationType||'-'}</td>
      <td>${e.educationDate||'-'}</td>
      <td style="font-weight:700;">${diff<0?'-':('D-'+diff)}</td>
      <td><span class="badge ${badge}">${status}</span></td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë°±ì—…ê´€ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBackup(){
  document.getElementById('st-emp').textContent=employees.length+'ëª…';
  document.getElementById('st-leave').textContent=annualLeaves.length+'ê±´';
  document.getElementById('st-edu').textContent=educations.length+'ê±´';
  document.getElementById('st-user').textContent=sysUsers.length+'ëª…';
}

function downloadBackup(){
  const data={version:'2.0',backupDate:new Date().toISOString(),employees,annualLeaves,educations,sysUsers};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url;
  a.download='hrm_backup_'+new Date().toISOString().slice(0,10)+'.json';
  a.click(); URL.revokeObjectURL(url);
  showToast('ë°±ì—… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ','success');
}

async function restoreBackup(ev){
  const file=ev.target.files[0]; if(!file) return;
  if(!confirm('ê¸°ì¡´ ë°ì´í„°ê°€ ëª¨ë‘ êµì²´ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ev.target.value='';return;}
  const reader=new FileReader();
  reader.onload=async e=>{
    try{
      const d=JSON.parse(e.target.result);
      showLoading(true);
      // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
      for(const x of employees) await fbDel('employees',x._docId);
      for(const x of annualLeaves) await fbDel('annualLeaves',x._docId);
      for(const x of educations) await fbDel('educations',x._docId);
      // ìƒˆ ë°ì´í„° ì €ì¥ (_docId í•„ë“œ ì œê±° í›„ ì €ì¥)
      for(const x of (d.employees||[])){
        const id=x._docId||String(x.id)||('emp_'+Date.now());
        const {_docId,...data}=x;
        await fbSet('employees',id,data);
      }
      for(const x of (d.annualLeaves||[])){
        const id=x._docId||String(x.employeeId)||('lv_'+Date.now());
        const {_docId,...data}=x;
        await fbSet('annualLeaves',id,data);
      }
      for(const x of (d.educations||[])){
        const id=x._docId||('edu_'+Date.now()+'_'+Math.random().toString(36).substr(2,5));
        const {_docId,...data}=x;
        await fbSet('educations',id,data);
      }
      // ë‹¤ì‹œ ë¡œë“œ
      [employees,annualLeaves,educations]=await Promise.all([fbGetAll('employees'),fbGetAll('annualLeaves'),fbGetAll('educations')]);
      // ëª¨ë“  í™”ë©´ ê°±ì‹ 
      updateDashboard();
      renderEmployees();
      renderAnnualLeave();
      renderEducation();
      renderBackup();
      showToast('ë³µì› ì™„ë£Œ! ì§ì› '+employees.length+'ëª… ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤','success');
    }catch(err){ showToast('ë³µì› ì‹¤íŒ¨: '+err.message,'error'); }
    finally{ showLoading(false); ev.target.value=''; }
  };
  reader.readAsText(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ê´€ë¦¬ì íŒ¨ë„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAdmin(){
  const pending=sysUsers.filter(u=>u.status==='pending');
  const pt=document.getElementById('pendingTable');
  pt.innerHTML=pending.length?pending.map(u=>`
    <tr>
      <td>${u.id}</td><td>${u.name}</td>
      <td>${u.createdAt?u.createdAt.slice(0,10):'-'}</td>
      <td class="actions">
        <button class="btn-success" onclick="approveUser('${u.id}')">ìŠ¹ì¸</button>
        <button class="btn-danger" onclick="rejectUser('${u.id}')">ê±°ì ˆ</button>
      </td>
    </tr>`).join(''):'<tr><td colspan="4" class="empty-msg">ëŒ€ê¸° ì¤‘ì¸ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';

  const at=document.getElementById('allUserTable');
  at.innerHTML=sysUsers.map(u=>`
    <tr>
      <td>${u.id}</td><td>${u.name}</td>
      <td><span class="badge ${u.role==='admin'?'badge-dday':'badge-scheduled'}">${u.role==='admin'?'ê´€ë¦¬ì':'ì¼ë°˜'}</span></td>
      <td><span class="badge badge-${u.status==='approved'?'approved':u.status==='pending'?'pending':'rejected'}">${u.status==='approved'?'ìŠ¹ì¸ë¨':u.status==='pending'?'ëŒ€ê¸°':'ê±°ì ˆ'}</span></td>
      <td>${u.createdAt?u.createdAt.slice(0,10):'-'}</td>
      <td>${u.role!=='admin'?`<button class="btn-danger" onclick="deleteUser('${u.id}')">ì‚­ì œ</button>`:'-'}</td>
    </tr>`).join('');
  document.getElementById('newAdminId').value=currentUser.id;
}

async function approveUser(id){
  const u=sysUsers.find(x=>x.id===id); if(!u) return;
  u.status='approved';
  showLoading(true);
  try{ await fbSet('sysUsers',id,u); renderAdmin(); showToast(u.name+' ìŠ¹ì¸ ì™„ë£Œ','success'); }
  catch(e){ showToast('ì˜¤ë¥˜: '+e.message,'error'); }
  finally{ showLoading(false); }
}

async function rejectUser(id){
  const u=sysUsers.find(x=>x.id===id); if(!u) return;
  u.status='rejected';
  showLoading(true);
  try{ await fbSet('sysUsers',id,u); renderAdmin(); showToast(u.name+' ê±°ì ˆë¨','info'); }
  catch(e){ showToast('ì˜¤ë¥˜: '+e.message,'error'); }
  finally{ showLoading(false); }
}

async function deleteUser(id){
  if(!confirm('ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  showLoading(true);
  try{ await fbDel('sysUsers',id); sysUsers=sysUsers.filter(u=>u.id!==id); renderAdmin(); showToast('ì‚­ì œ ì™„ë£Œ','success'); }
  catch(e){ showToast('ì˜¤ë¥˜: '+e.message,'error'); }
  finally{ showLoading(false); }
}

async function updateAdminAccount(){
  const newId=document.getElementById('newAdminId').value.trim();
  const curPw=document.getElementById('curAdminPw').value;
  const newPw=document.getElementById('newAdminPw').value;
  const newPw2=document.getElementById('newAdminPw2').value;
  const msg=document.getElementById('adminAccMsg');
  msg.style.color='#e74c3c'; msg.textContent='';
  if(!newId||!curPw){msg.textContent='ì•„ì´ë””ì™€ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';return;}
  if(curPw!==currentUser.pw){msg.textContent='í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';return;}
  if(newPw&&newPw.length<6){msg.textContent='ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';return;}
  if(newPw&&newPw!==newPw2){msg.textContent='ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';return;}
  const updated={...currentUser,id:newId,pw:newPw||currentUser.pw};
  showLoading(true);
  try{
    if(newId!==currentUser.id){ await fbDel('sysUsers',currentUser.id); }
    await fbSet('sysUsers',newId,updated);
    sysUsers=sysUsers.filter(u=>u.id!==currentUser.id);
    sysUsers.push({_docId:newId,...updated});
    currentUser=updated;
    window._currentUserCache=updated;
    document.getElementById('headerUserName').textContent=currentUser.name;
    msg.style.color='#27ae60';
    msg.textContent='ê³„ì •ì´ ì—…ë°ì´íŠ¸ ë˜ì—ˆìŠµë‹ˆë‹¤.';
    document.getElementById('curAdminPw').value='';
    document.getElementById('newAdminPw').value='';
    document.getElementById('newAdminPw2').value='';
    showToast('ê³„ì • ì—…ë°ì´íŠ¸ ì™„ë£Œ','success');
  }catch(e){ msg.textContent='ì˜¤ë¥˜: '+e.message; }
  finally{ showLoading(false); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
                                
