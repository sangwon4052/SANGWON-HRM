<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì§ì›ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
:root {
  --primary:#2563eb;--primary-dark:#1d4ed8;--primary-light:#eff6ff;
  --success:#16a34a;--success-light:#f0fdf4;
  --danger:#dc2626;--danger-light:#fef2f2;
  --warning:#d97706;--warning-light:#fffbeb;
  --g50:#f9fafb;--g100:#f3f4f6;--g200:#e5e7eb;--g300:#d1d5db;
  --g400:#9ca3af;--g500:#6b7280;--g600:#4b5563;--g700:#374151;--g800:#1f2937;
  --shadow:0 1px 3px rgba(0,0,0,.1);--shadow-md:0 4px 6px rgba(0,0,0,.07);
  --shadow-lg:0 10px 15px rgba(0,0,0,.1);--r:8px;--r-lg:12px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Noto Sans KR',sans-serif;background:var(--g50);color:var(--g800);font-size:14px}

/* ì¸ì¦ */
#authOverlay{display:none;position:fixed;inset:0;background:linear-gradient(135deg,#1e3a8a,#2563eb);z-index:9999;align-items:center;justify-content:center}
#authOverlay.on{display:flex}
.auth-box{background:white;border-radius:var(--r-lg);padding:40px;width:400px;box-shadow:var(--shadow-lg)}
.auth-logo{text-align:center;margin-bottom:28px}
.auth-logo h1{font-size:22px;font-weight:700;color:var(--g800);margin-top:8px}
.auth-logo p{font-size:13px;color:var(--g400);margin-top:4px}
.auth-tabs{display:flex;border-bottom:2px solid var(--g200);margin-bottom:24px}
.auth-tab{flex:1;padding:10px;text-align:center;font-size:14px;font-weight:500;color:var(--g400);cursor:pointer;border:none;background:none;transition:.2s;font-family:inherit}
.auth-tab.on{color:var(--primary);border-bottom:2px solid var(--primary);margin-bottom:-2px}
.auth-form{display:none}.auth-form.on{display:block}
.ff{margin-bottom:16px}
.ff label{display:block;font-size:13px;font-weight:500;color:var(--g600);margin-bottom:6px}
.ff input{width:100%;padding:10px 12px;border:1px solid var(--g300);border-radius:var(--r);font-size:14px;font-family:inherit;outline:none;transition:.2s}
.ff input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.btn-full{width:100%;padding:11px;background:var(--primary);color:white;border:none;border-radius:var(--r);font-size:15px;font-weight:600;font-family:inherit;cursor:pointer;margin-top:4px;transition:.2s}
.btn-full:hover{background:var(--primary-dark)}
.amsg{font-size:13px;margin-top:12px;padding:10px 12px;border-radius:var(--r);display:none}
.amsg.err{display:block;background:var(--danger-light);color:var(--danger)}
.amsg.ok{display:block;background:var(--success-light);color:var(--success)}

/* í—¤ë” */
#hdr{background:white;border-bottom:1px solid var(--g200);padding:0 24px;display:flex;align-items:center;justify-content:space-between;height:56px;position:sticky;top:0;z-index:100;box-shadow:0 1px 2px rgba(0,0,0,.05)}
.hdr-logo{font-size:18px;font-weight:700;color:var(--primary);display:flex;align-items:center;gap:8px}
.hdr-right{display:flex;align-items:center;gap:12px}
.uname{font-size:14px;font-weight:500;color:var(--g700)}
.ubadge{font-size:11px;padding:2px 8px;border-radius:99px;font-weight:600}
.ubadge.admin{background:#fef3c7;color:#92400e}
.ubadge.user{background:var(--primary-light);color:var(--primary-dark)}
.hbtn{padding:7px 14px;border-radius:var(--r);font-size:13px;font-weight:500;cursor:pointer;font-family:inherit;transition:.15s;border:1px solid var(--g300);background:white;color:var(--g600)}
.hbtn:hover{background:var(--g50)}

/* ë„¤ë¹„ */
#nav{background:white;border-bottom:1px solid var(--g200);padding:0 24px;display:flex;gap:4px}
.nbtn{padding:14px 16px;font-size:13px;font-weight:500;color:var(--g500);border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;transition:.2s;font-family:inherit;display:flex;align-items:center;gap:4px}
.nbtn:hover{color:var(--primary)}
.nbtn.on{color:var(--primary);border-bottom-color:var(--primary)}
.nbadge{display:inline-flex;align-items:center;justify-content:center;background:var(--danger);color:white;font-size:10px;font-weight:700;min-width:16px;height:16px;border-radius:99px;padding:0 4px}

/* ë©”ì¸ */
#main{padding:24px;max-width:1200px;margin:0 auto}
.page{display:none}.page.on{display:block}

/* ê³µí†µ ë²„íŠ¼ */
.btn{padding:8px 16px;border-radius:var(--r);font-size:13px;font-weight:500;cursor:pointer;border:none;font-family:inherit;transition:.15s;display:inline-flex;align-items:center;gap:6px}
.btn-p{background:var(--primary);color:white}.btn-p:hover{background:var(--primary-dark)}
.btn-s{background:var(--success);color:white}.btn-s:hover{background:#15803d}
.btn-d{background:var(--danger);color:white}.btn-d:hover{background:#b91c1c}
.btn-o{background:white;color:var(--g600);border:1px solid var(--g300)}.btn-o:hover{background:var(--g50)}
.btn-sm{padding:5px 10px;font-size:12px}

/* ì¹´ë“œ */
.card{background:white;border-radius:var(--r-lg);border:1px solid var(--g200);padding:20px;box-shadow:var(--shadow)}
.ctitle{font-size:15px;font-weight:600;color:var(--g800);margin-bottom:16px}

/* ëŒ€ì‹œë³´ë“œ */
.dash-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.dc{background:white;border-radius:var(--r-lg);border:1px solid var(--g200);padding:20px;box-shadow:var(--shadow);transition:.2s}
.dc:hover{box-shadow:var(--shadow-md);transform:translateY(-1px)}
.dc .lbl{font-size:12px;color:var(--g400);font-weight:500;text-transform:uppercase;letter-spacing:.5px}
.dc .num{font-size:32px;font-weight:700;color:var(--g800);margin:8px 0 4px}
.dc .sub{font-size:12px;color:var(--g400)}
.dc.bl{border-top:3px solid var(--primary)}
.dc.gr{border-top:3px solid var(--success)}
.dc.or{border-top:3px solid var(--warning)}
.dc.re{border-top:3px solid var(--danger)}

/* í…Œì´ë¸” */
.tw{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th{padding:10px 14px;text-align:left;font-size:12px;font-weight:600;color:var(--g500);text-transform:uppercase;letter-spacing:.4px;border-bottom:1px solid var(--g200);background:var(--g50)}
td{padding:12px 14px;border-bottom:1px solid var(--g100);font-size:13px;color:var(--g700)}
tr:last-child td{border-bottom:none}
tr:hover td{background:var(--g50)}

/* ë±ƒì§€ */
.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:99px;font-size:11px;font-weight:600}
.b-bl{background:var(--primary-light);color:var(--primary-dark)}
.b-gr{background:var(--success-light);color:var(--success)}
.b-rd{background:var(--danger-light);color:var(--danger)}
.b-yw{background:var(--warning-light);color:var(--warning)}
.b-gy{background:var(--g100);color:var(--g600)}

/* í¼ */
.fg{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.fgi{display:flex;flex-direction:column;gap:6px}
.fgi label{font-size:13px;font-weight:500;color:var(--g600)}
.fgi input,.fgi select,.fgi textarea{padding:9px 12px;border:1px solid var(--g300);border-radius:var(--r);font-size:13px;font-family:inherit;color:var(--g800);outline:none;transition:.2s}
.fgi input:focus,.fgi select:focus,.fgi textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.fgi.full{grid-column:1/-1}

/* ëª¨ë‹¬ */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;align-items:center;justify-content:center}
.mo.on{display:flex}
.mb{background:white;border-radius:var(--r-lg);width:560px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
.mh{padding:20px 24px;border-bottom:1px solid var(--g200);display:flex;align-items:center;justify-content:space-between}
.mh h3{font-size:16px;font-weight:600}
.mc{padding:24px}
.mf{padding:16px 24px;border-top:1px solid var(--g200);display:flex;justify-content:flex-end;gap:8px}
.mclose{background:none;border:none;cursor:pointer;color:var(--g400);font-size:22px;padding:0 4px;line-height:1}
.mclose:hover{color:var(--g700)}

/* íˆ´ë°” */
.tb{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:12px}
.tb-l{display:flex;align-items:center;gap:8px}
.si{padding:8px 12px;border:1px solid var(--g300);border-radius:var(--r);font-size:13px;font-family:inherit;width:220px;outline:none}
.si:focus{border-color:var(--primary)}

/* ë¹ˆ ìƒíƒœ */
.empty{text-align:center;padding:48px 20px;color:var(--g400)}
.empty .ico{font-size:36px;margin-bottom:10px}
.empty p{font-size:13px}

/* ì—°ì°¨ */
.lb-wrap{background:var(--g100);border-radius:99px;height:8px;overflow:hidden;width:80px}
.lb{height:100%;border-radius:99px;background:var(--primary)}

/* ê´€ë¦¬ì */
.pi{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border:1px solid var(--g200);border-radius:var(--r);margin-bottom:8px;background:var(--warning-light)}

@media(max-width:768px){
  .dash-grid{grid-template-columns:1fr 1fr}
  .fg{grid-template-columns:1fr}
  #main{padding:16px}
}
</style>
</head>
<body>

<!-- ì¸ì¦ -->
<div id="authOverlay" class="on">
  <div class="auth-box">
    <div class="auth-logo">
      <div style="font-size:36px">ğŸ¢</div>
      <h1>ì§ì›ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
      <p>Employee Management System</p>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab on" onclick="switchTab('login')">ë¡œê·¸ì¸</button>
      <button class="auth-tab" onclick="switchTab('reg')">íšŒì›ê°€ì…</button>
    </div>
    <div id="fLogin" class="auth-form on">
      <div class="ff"><label>ì•„ì´ë””</label><input id="lId" placeholder="ì•„ì´ë””" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <div class="ff"><label>ë¹„ë°€ë²ˆí˜¸</label><input id="lPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <div id="lMsg" class="amsg"></div>
      <button class="btn-full" onclick="doLogin()">ë¡œê·¸ì¸</button>
    </div>
    <div id="fReg" class="auth-form">
      <div class="ff"><label>ì´ë¦„</label><input id="rName" placeholder="ì´ë¦„"></div>
      <div class="ff"><label>ì•„ì´ë”” (4ì ì´ìƒ)</label><input id="rId" placeholder="ì•„ì´ë””"></div>
      <div class="ff"><label>ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label><input id="rPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"></div>
      <div class="ff"><label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input id="rPw2" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥"></div>
      <div id="rMsg" class="amsg"></div>
      <button class="btn-full" onclick="doRegister()">íšŒì›ê°€ì… ì‹ ì²­</button>
    </div>
  </div>
</div>

<!-- í—¤ë” -->
<header id="hdr" style="display:none">
  <div class="hdr-logo">ğŸ¢ ì§ì›ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
  <div class="hdr-right">
    <span class="uname" id="hName"></span>
    <span class="ubadge" id="hBadge"></span>
    <button class="hbtn" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</header>

<!-- ë„¤ë¹„ -->
<nav id="nav" style="display:none">
  <button class="nbtn on" onclick="go('dash',this)">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
  <button class="nbtn" onclick="go('emp',this)">ğŸ‘¥ ì§ì›ê´€ë¦¬</button>
  <button class="nbtn" id="nLeave" onclick="go('leave',this)" style="display:none">ğŸ“… ì—°ì°¨ê´€ë¦¬</button>
  <button class="nbtn" onclick="go('edu',this)">ğŸ“š ì§ë¬´êµìœ¡</button>
  <button class="nbtn" onclick="go('backup',this)">ğŸ’¾ ë°±ì—…ê´€ë¦¬</button>
  <button class="nbtn" id="nAdmin" onclick="go('admin',this)" style="display:none">ğŸ›¡ï¸ ê´€ë¦¬ì<span class="nbadge" id="pbadge" style="display:none">0</span></button>
</nav>

<!-- ë©”ì¸ -->
<main id="main" style="display:none">

  <!-- ëŒ€ì‹œë³´ë“œ -->
  <div id="p-dash" class="page on">
    <div class="dash-grid">
      <div class="dc bl"><div class="lbl">ì „ì²´ ì§ì›</div><div class="num" id="dTotal">0</div><div class="sub">ëª… ë“±ë¡ë¨</div></div>
      <div class="dc gr"><div class="lbl">ì¬ì§ ì§ì›</div><div class="num" id="dActive">0</div><div class="sub">ëª… ì¬ì§ì¤‘</div></div>
      <div class="dc or"><div class="lbl">í‡´ì‚¬ ì§ì›</div><div class="num" id="dInactive">0</div><div class="sub">ëª… í‡´ì‚¬</div></div>
      <div class="dc re"><div class="lbl">ì´ë²ˆë‹¬ ìƒì¼</div><div class="num" id="dBday">0</div><div class="sub">ëª…</div></div>
    </div>
    <div class="card"><div class="ctitle">ğŸ“‹ ìµœê·¼ ë“±ë¡ ì§ì›</div><div id="dRecent"></div></div>
  </div>

  <!-- ì§ì›ê´€ë¦¬ -->
  <div id="p-emp" class="page">
    <div class="card">
      <div class="tb">
        <div class="tb-l"><input class="si" id="empQ" placeholder="ğŸ” ì´ë¦„, ë¶€ì„œ, ì§ì±…..." oninput="renderEmp()"></div>
        <button class="btn btn-p" onclick="openEmpMo()">+ ì§ì› ë“±ë¡</button>
      </div>
      <div class="tw"><table>
        <thead><tr><th>ì´ë¦„</th><th>ë¶€ì„œ</th><th>ì§ì±…</th><th>ì…ì‚¬ì¼</th><th>ì „í™”ë²ˆí˜¸</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
        <tbody id="empTb"></tbody>
      </table></div>
    </div>
  </div>

  <!-- ì—°ì°¨ê´€ë¦¬ -->
  <div id="p-leave" class="page">
    <div class="card">
      <div class="tb">
        <div class="tb-l">
          <label style="font-size:13px;font-weight:500;color:var(--g600)">íšŒê³„ì—°ë„</label>
          <select id="leaveYr" style="padding:7px 10px;border:1px solid var(--g300);border-radius:var(--r);font-family:inherit;font-size:13px" onchange="renderLeave()"></select>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-o" onclick="openBulkMo()">ì¼ê´„ ì—°ì°¨ ì§€ê¸‰</button>
          <button class="btn btn-p" onclick="openLeaveMo()">+ ì—°ì°¨ ì¶”ê°€</button>
        </div>
      </div>
      <div class="tw"><table>
        <thead><tr><th>ì§ì›</th><th>ë¶€ì„œ</th><th>ì´ ì—°ì°¨</th><th>ì‚¬ìš©</th><th>ì”ì—¬</th><th>ì‚¬ìš©ë¥ </th><th>ê´€ë¦¬</th></tr></thead>
        <tbody id="leaveTb"></tbody>
      </table></div>
    </div>
  </div>

  <!-- ì§ë¬´êµìœ¡ -->
  <div id="p-edu" class="page">
    <div class="card">
      <div class="tb">
        <div class="tb-l"><input class="si" id="eduQ" placeholder="ğŸ” ì§ì›ëª…, êµìœ¡ëª…..." oninput="renderEdu()"></div>
        <button class="btn btn-p" onclick="openEduMo()">+ êµìœ¡ ì¶”ê°€</button>
      </div>
      <div class="tw"><table>
        <thead><tr><th>ì§ì›</th><th>êµìœ¡ëª…</th><th>êµìœ¡ì¼</th><th>ìˆ˜ë£Œì¦</th><th>ë‹¤ìŒêµìœ¡ì¼</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
        <tbody id="eduTb"></tbody>
      </table></div>
    </div>
  </div>

  <!-- ë°±ì—…ê´€ë¦¬ -->
  <div id="p-backup" class="page">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="card">
        <div class="ctitle">ğŸ’¾ ë°ì´í„° í˜„í™©</div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <div style="display:flex;justify-content:space-between;padding:10px;background:var(--g50);border-radius:var(--r)"><span style="color:var(--g600)">ì „ì²´ ì§ì›</span><strong id="bkE">0ëª…</strong></div>
          <div style="display:flex;justify-content:space-between;padding:10px;background:var(--g50);border-radius:var(--r)"><span style="color:var(--g600)">ì—°ì°¨ ë°ì´í„°</span><strong id="bkL">0ê±´</strong></div>
          <div style="display:flex;justify-content:space-between;padding:10px;background:var(--g50);border-radius:var(--r)"><span style="color:var(--g600)">êµìœ¡ ì¼ì •</span><strong id="bkEd">0ê±´</strong></div>
        </div>
      </div>
      <div class="card">
        <div class="ctitle">âš¡ ë¹ ë¥¸ ì‘ì—…</div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <button class="btn btn-p" style="justify-content:center" onclick="dlBackup()">ğŸ’¾ ë°±ì—… ë‹¤ìš´ë¡œë“œ</button>
          <label style="display:flex;align-items:center;justify-content:center;gap:6px;padding:8px 16px;border-radius:var(--r);font-size:13px;font-weight:500;cursor:pointer;border:1px solid var(--g300);background:white;color:var(--g600)">
            ğŸ“‚ ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°<input type="file" accept=".json" onchange="restoreBackup(event)" style="display:none">
          </label>
        </div>
        <p style="font-size:12px;color:var(--danger);margin-top:12px">âš ï¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œ í˜„ì¬ ë°ì´í„°ê°€ ëª¨ë‘ êµì²´ë©ë‹ˆë‹¤</p>
      </div>
    </div>
  </div>

  <!-- ê´€ë¦¬ì -->
  <div id="p-admin" class="page">
    <div class="card" style="margin-bottom:16px">
      <div class="ctitle">â³ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íšŒì›</div>
      <div id="pList"></div>
    </div>
    <div class="card" style="margin-bottom:16px">
      <div class="ctitle">ğŸ‘¥ ì „ì²´ íšŒì› ëª©ë¡</div>
      <div class="tw"><table><thead><tr><th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>ìƒíƒœ</th><th>ê°€ì…ì¼</th><th>ê´€ë¦¬</th></tr></thead><tbody id="uTb"></tbody></table></div>
    </div>
    <div class="card">
      <div class="ctitle">ğŸ”‘ ê´€ë¦¬ì ê³„ì • ë³€ê²½</div>
      <div class="fg">
        <div class="fgi"><label>ìƒˆ ì•„ì´ë”” (ë¹„ì›Œë‘ë©´ ìœ ì§€)</label><input id="aNewId" placeholder="ë³€ê²½í•  ì•„ì´ë””"></div>
        <div class="fgi"><label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ *</label><input id="aCurPw" type="password" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸"></div>
        <div class="fgi"><label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ë¹„ì›Œë‘ë©´ ìœ ì§€)</label><input id="aNewPw" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"></div>
        <div class="fgi"><label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input id="aNewPw2" type="password"></div>
      </div>
      <div style="margin-top:16px"><button class="btn btn-p" onclick="updateAdmin()">ê³„ì • ì—…ë°ì´íŠ¸</button></div>
    </div>
  </div>

</main>

<!-- ì§ì› ëª¨ë‹¬ -->
<div id="moEmp" class="mo">
  <div class="mb">
    <div class="mh"><h3 id="moEmpTitle">ì§ì› ë“±ë¡</h3><button class="mclose" onclick="closeMo('moEmp')">Ã—</button></div>
    <div class="mc">
      <div class="fg">
        <div class="fgi"><label>ì´ë¦„ *</label><input id="eName" placeholder="í™ê¸¸ë™"></div>
        <div class="fgi"><label>ë¶€ì„œ *</label><input id="eDept" placeholder="ê°œë°œíŒ€"></div>
        <div class="fgi"><label>ì§ì±… *</label><input id="ePos" placeholder="ì‚¬ì›"></div>
        <div class="fgi"><label>ì…ì‚¬ì¼ *</label><input type="date" id="eJoin"></div>
        <div class="fgi"><label>ì „í™”ë²ˆí˜¸</label><input id="ePhone" placeholder="010-0000-0000"></div>
        <div class="fgi"><label>ìƒë…„ì›”ì¼</label><input type="date" id="eBirth"></div>
        <div class="fgi"><label>ì´ë©”ì¼</label><input type="email" id="eEmail" placeholder="email@example.com"></div>
        <div class="fgi"><label>í‡´ì‚¬ì¼</label><input type="date" id="eResign"></div>
        <div class="fgi full"><label>ë©”ëª¨</label><textarea id="eMemo" rows="2" style="resize:vertical" placeholder="íŠ¹ì´ì‚¬í•­"></textarea></div>
      </div>
    </div>
    <div class="mf"><button class="btn btn-o" onclick="closeMo('moEmp')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="saveEmp()">ì €ì¥</button></div>
  </div>
</div>

<!-- ì—°ì°¨ ëª¨ë‹¬ -->
<div id="moLeave" class="mo">
  <div class="mb">
    <div class="mh"><h3>ì—°ì°¨ ì¶”ê°€/ìˆ˜ì •</h3><button class="mclose" onclick="closeMo('moLeave')">Ã—</button></div>
    <div class="mc">
      <div class="fg">
        <div class="fgi"><label>ì§ì› *</label><select id="lvEmp"><option value="">ì§ì› ì„ íƒ</option></select></div>
        <div class="fgi"><label>íšŒê³„ì—°ë„ *</label><input type="number" id="lvYr" value="2025"></div>
        <div class="fgi"><label>ì´ ì—°ì°¨ì¼ìˆ˜ *</label><input type="number" id="lvTotal" placeholder="15"></div>
        <div class="fgi"><label>ì‚¬ìš©ì¼ ì¶”ê°€</label><input type="number" id="lvUsed" placeholder="0" min="0"></div>
        <div class="fgi"><label>ì‚¬ìœ </label><input id="lvReason" placeholder="ì‚¬ìœ "></div>
        <div class="fgi"><label>ë‚ ì§œ</label><input type="date" id="lvDate"></div>
      </div>
    </div>
    <div class="mf"><button class="btn btn-o" onclick="closeMo('moLeave')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="saveLeave()">ì €ì¥</button></div>
  </div>
</div>

<!-- ì¼ê´„ ì—°ì°¨ ëª¨ë‹¬ -->
<div id="moBulk" class="mo">
  <div class="mb">
    <div class="mh"><h3>ì¼ê´„ ì—°ì°¨ ì§€ê¸‰</h3><button class="mclose" onclick="closeMo('moBulk')">Ã—</button></div>
    <div class="mc">
      <div class="fg">
        <div class="fgi"><label>íšŒê³„ì—°ë„ *</label><input type="number" id="blYr" value="2025"></div>
        <div class="fgi"><label>ì§€ê¸‰ ì—°ì°¨ì¼ìˆ˜ *</label><input type="number" id="blDays" placeholder="15"></div>
      </div>
      <p style="font-size:13px;color:var(--g500);margin-top:12px">â€» ì¬ì§ ì¤‘ì¸ ëª¨ë“  ì§ì›ì—ê²Œ ì¼ê´„ ì§€ê¸‰ë©ë‹ˆë‹¤.</p>
    </div>
    <div class="mf"><button class="btn btn-o" onclick="closeMo('moBulk')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="saveBulk()">ì§€ê¸‰</button></div>
  </div>
</div>

<!-- êµìœ¡ ëª¨ë‹¬ -->
<div id="moEdu" class="mo">
  <div class="mb">
    <div class="mh"><h3 id="moEduTitle">êµìœ¡ ì¶”ê°€</h3><button class="mclose" onclick="closeMo('moEdu')">Ã—</button></div>
    <div class="mc">
      <div class="fg">
        <div class="fgi"><label>ì§ì› *</label><select id="edEmp"><option value="">ì§ì› ì„ íƒ</option></select></div>
        <div class="fgi"><label>êµìœ¡ëª… *</label><input id="edName" placeholder="ì•ˆì „êµìœ¡"></div>
        <div class="fgi"><label>êµìœ¡ì¼ *</label><input type="date" id="edDate"></div>
        <div class="fgi"><label>êµìœ¡ ìœ í˜•</label><select id="edType"><option>í•„ìˆ˜êµìœ¡</option><option>ì§ë¬´êµìœ¡</option><option>ì•ˆì „êµìœ¡</option><option>ê¸°íƒ€</option></select></div>
        <div class="fgi"><label>ìˆ˜ë£Œì¦</label><input id="edCert" placeholder="ìˆ˜ë£Œì¦ ë²ˆí˜¸"></div>
        <div class="fgi"><label>ìˆ˜ë£Œì¼</label><input type="date" id="edCertDate"></div>
        <div class="fgi"><label>ë‹¤ìŒ êµìœ¡ì¼</label><input type="date" id="edNext"></div>
        <div class="fgi"><label>ë©”ëª¨</label><input id="edMemo" placeholder="ë¹„ê³ "></div>
      </div>
    </div>
    <div class="mf"><button class="btn btn-o" onclick="closeMo('moEdu')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="saveEdu()">ì €ì¥</button></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebase REST API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FB_PROJ='sangwon-hrm';
const FB_KEY='AIzaSyBebDpB0eFP2yDZ4NK6K8IoWS8aTseHkzc';
const FB_URL=`https://firestore.googleapis.com/v1/projects/${FB_PROJ}/databases/(default)/documents`;

function toFV(v){
  if(v===null||v===undefined)return{nullValue:null};
  if(typeof v==='boolean')return{booleanValue:v};
  if(typeof v==='number')return Number.isInteger(v)?{integerValue:String(v)}:{doubleValue:v};
  if(typeof v==='string')return{stringValue:v};
  if(Array.isArray(v))return{arrayValue:{values:v.map(toFV)}};
  if(typeof v==='object')return{mapValue:{fields:toFs(v)}};
  return{stringValue:String(v)};
}
function toFs(obj){const f={};for(const[k,v]of Object.entries(obj))f[k]=toFV(v);return f;}
function fromFV(fv){
  if(!fv)return null;
  if('nullValue'in fv)return null;
  if('booleanValue'in fv)return fv.booleanValue;
  if('integerValue'in fv)return Number(fv.integerValue);
  if('doubleValue'in fv)return fv.doubleValue;
  if('stringValue'in fv)return fv.stringValue;
  if('arrayValue'in fv)return(fv.arrayValue.values||[]).map(fromFV);
  if('mapValue'in fv)return fromFs(fv.mapValue.fields||{});
  return null;
}
function fromFs(fields){const o={};for(const[k,v]of Object.entries(fields))o[k]=fromFV(v);return o;}

async function fbGetAll(col){
  try{
    const r=await fetch(`${FB_URL}/${col}?key=${FB_KEY}&pageSize=500`);
    const j=await r.json();
    if(!j.documents)return[];
    return j.documents.map(d=>fromFs(d.fields||{}));
  }catch(e){console.error('fbGetAll',col,e);return[];}
}
async function fbSet(col,id,data){
  try{
    const eid=encodeURIComponent(String(id));
    await fetch(`${FB_URL}/${col}/${eid}?key=${FB_KEY}`,{
      method:'PATCH',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({fields:toFs(JSON.parse(JSON.stringify(data)))})
    });
  }catch(e){console.error('fbSet',e);}
}
async function fbDel(col,id){
  try{
    const eid=encodeURIComponent(String(id));
    await fetch(`${FB_URL}/${col}/${eid}?key=${FB_KEY}`,{method:'DELETE'});
  }catch(e){console.error('fbDel',e);}
}
async function fbReplaceAll(col,arr){
  const old=await fbGetAll(col);
  await Promise.all(old.map(d=>fbDel(col,d.id||d.employeeId)));
  await Promise.all(arr.map(item=>{
    const id=String(item.id||item.employeeId||Date.now());
    return fbSet(col,id,item);
  }));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì•± ìƒíƒœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let DB={emp:[],leave:[],edu:[],users:[]};
let CU=null;
let editEmp=null,editEdu=null;
let pollTmr=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  const saved=sessionStorage.getItem('cu');
  if(saved){try{CU=JSON.parse(saved);}catch(e){}}
  await loadAll();
  if(!DB.users.find(u=>u.role==='admin')){
    const admin={id:'admin',pw:'admin1234',name:'ê´€ë¦¬ì',role:'admin',status:'approved',createdAt:new Date().toISOString()};
    await fbSet('sysUsers','admin',admin);
    DB.users.push(admin);
  }
  if(CU){
    const fresh=DB.users.find(u=>u.id===CU.id);
    if(fresh&&fresh.status==='approved'){
      CU=fresh;sessionStorage.setItem('cu',JSON.stringify(CU));showApp();
    }else{
      sessionStorage.removeItem('cu');CU=null;showAuth();
    }
  }else{showAuth();}
  startPoll();
}

async function loadAll(){
  const[e,l,ed,u]=await Promise.all([
    fbGetAll('employees'),fbGetAll('annualLeaves'),
    fbGetAll('educations'),fbGetAll('sysUsers')
  ]);
  DB.emp=e;DB.leave=l;DB.edu=ed;DB.users=u;
}

function startPoll(){
  if(pollTmr)clearInterval(pollTmr);
  pollTmr=setInterval(async()=>{await loadAll();if(CU)refreshUI();},30000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì¸ì¦
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(t){
  document.querySelectorAll('.auth-tab').forEach((b,i)=>b.classList.toggle('on',(i===0&&t==='login')||(i===1&&t==='reg')));
  document.getElementById('fLogin').classList.toggle('on',t==='login');
  document.getElementById('fReg').classList.toggle('on',t==='reg');
}
async function doLogin(){
  const id=document.getElementById('lId').value.trim();
  const pw=document.getElementById('lPw').value;
  const msg=document.getElementById('lMsg');
  msg.className='amsg';
  if(!id||!pw){setMsg(msg,'err','ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return;}
  await loadAll();
  const u=DB.users.find(u=>u.id===id&&u.pw===pw);
  if(!u){setMsg(msg,'err','ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');return;}
  if(u.status==='pending'){setMsg(msg,'err','ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.');return;}
  if(u.status==='rejected'){setMsg(msg,'err','ê°€ì…ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.');return;}
  CU=u;sessionStorage.setItem('cu',JSON.stringify(CU));showApp();
}
async function doRegister(){
  const name=document.getElementById('rName').value.trim();
  const id=document.getElementById('rId').value.trim();
  const pw=document.getElementById('rPw').value;
  const pw2=document.getElementById('rPw2').value;
  const msg=document.getElementById('rMsg');
  msg.className='amsg';
  if(!name||!id||!pw||!pw2){setMsg(msg,'err','ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}
  if(id.length<4){setMsg(msg,'err','ì•„ì´ë””ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');return;}
  if(pw.length<6){setMsg(msg,'err','ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');return;}
  if(pw!==pw2){setMsg(msg,'err','ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');return;}
  await loadAll();
  if(DB.users.find(u=>u.id===id)){setMsg(msg,'err','ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.');return;}
  const nu={id,pw,name,role:'user',status:'pending',createdAt:new Date().toISOString()};
  await fbSet('sysUsers',id,nu);
  DB.users.push(nu);
  setMsg(msg,'ok','âœ… íšŒì›ê°€ì… ì‹ ì²­ ì™„ë£Œ! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
  ['rName','rId','rPw','rPw2'].forEach(x=>document.getElementById(x).value='');
}
function doLogout(){
  if(!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  sessionStorage.removeItem('cu');CU=null;location.reload();
}
function setMsg(el,type,text){el.className='amsg '+type;el.textContent=text;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// í™”ë©´ ì „í™˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showAuth(){
  document.getElementById('authOverlay').classList.add('on');
  document.getElementById('hdr').style.display='none';
  document.getElementById('nav').style.display='none';
  document.getElementById('main').style.display='none';
}
function showApp(){
  document.getElementById('authOverlay').classList.remove('on');
  document.getElementById('hdr').style.display='';
  document.getElementById('nav').style.display='';
  document.getElementById('main').style.display='';
  document.getElementById('hName').textContent=CU.name;
  const b=document.getElementById('hBadge');
  b.textContent=CU.role==='admin'?'ê´€ë¦¬ì':'ì¼ë°˜';
  b.className='ubadge '+(CU.role==='admin'?'admin':'user');
  document.getElementById('nAdmin').style.display=CU.role==='admin'?'':'none';
  document.getElementById('nLeave').style.display=CU.role==='admin'?'':'none';
  const ly=document.getElementById('leaveYr');
  const yr=new Date().getFullYear();
  ly.innerHTML='';
  for(let y=yr+1;y>=yr-3;y--)ly.innerHTML+=`<option value="${y}">${y}ë…„</option>`;
  ly.value=yr;
  refreshUI();go('dash');
}
function refreshUI(){
  renderDash();renderEmp();renderLeave();renderEdu();
  document.getElementById('bkE').textContent=DB.emp.length+'ëª…';
  document.getElementById('bkL').textContent=DB.leave.length+'ê±´';
  document.getElementById('bkEd').textContent=DB.edu.length+'ê±´';
  if(CU&&CU.role==='admin')renderAdmin();
}
function go(name,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.nbtn').forEach(b=>b.classList.remove('on'));
  document.getElementById('p-'+name).classList.add('on');
  if(btn)btn.classList.add('on');
  else document.querySelectorAll('.nbtn').forEach(b=>{if(b.getAttribute('onclick')&&b.getAttribute('onclick').includes(`'${name}'`))b.classList.add('on');});
  if(name==='admin')renderAdmin();
}
function closeMo(id){document.getElementById(id).classList.remove('on');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ëŒ€ì‹œë³´ë“œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDash(){
  const now=new Date();
  const total=DB.emp.length;
  const active=DB.emp.filter(e=>!e.resignDate||new Date(e.resignDate)>now).length;
  const mon=now.getMonth()+1;
  const bday=DB.emp.filter(e=>e.birthDate&&new Date(e.birthDate).getMonth()+1===mon).length;
  document.getElementById('dTotal').textContent=total;
  document.getElementById('dActive').textContent=active;
  document.getElementById('dInactive').textContent=total-active;
  document.getElementById('dBday').textContent=bday;
  const recent=[...DB.emp].sort((a,b)=>new Date(b.joinDate||0)-new Date(a.joinDate||0)).slice(0,5);
  const el=document.getElementById('dRecent');
  if(!recent.length){el.innerHTML='<div class="empty"><div class="ico">ğŸ‘¥</div><p>ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';return;}
  el.innerHTML=`<div class="tw"><table><thead><tr><th>ì´ë¦„</th><th>ë¶€ì„œ</th><th>ì§ì±…</th><th>ì…ì‚¬ì¼</th><th>ìƒíƒœ</th></tr></thead><tbody>${
    recent.map(e=>`<tr><td><strong>${e.name}</strong></td><td>${e.department||'-'}</td><td>${e.position||'-'}</td><td>${e.joinDate?new Date(e.joinDate).toLocaleDateString('ko-KR'):'-'}</td><td>${!e.resignDate||new Date(e.resignDate)>now?'<span class="badge b-gr">ì¬ì§</span>':'<span class="badge b-gy">í‡´ì‚¬</span>'}</td></tr>`).join('')
  }</tbody></table></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì§ì›ê´€ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEmp(){
  const q=(document.getElementById('empQ')||{}).value||'';
  const now=new Date();
  let list=DB.emp.filter(e=>!q||(e.name||'').includes(q)||(e.department||'').includes(q)||(e.position||'').includes(q));
  list.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  const tb=document.getElementById('empTb');
  if(!list.length){tb.innerHTML='<tr><td colspan="7"><div class="empty"><div class="ico">ğŸ‘¥</div><p>ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</p></div></td></tr>';return;}
  tb.innerHTML=list.map(e=>{
    const on=!e.resignDate||new Date(e.resignDate)>now;
    return`<tr><td><strong>${e.name}</strong></td><td>${e.department||'-'}</td><td>${e.position||'-'}</td><td>${e.joinDate?new Date(e.joinDate).toLocaleDateString('ko-KR'):'-'}</td><td>${e.phone||'-'}</td><td>${on?'<span class="badge b-gr">ì¬ì§</span>':'<span class="badge b-gy">í‡´ì‚¬</span>'}</td><td>
      <button class="btn btn-o btn-sm" onclick="openEmpMo('${e.id}')">ìˆ˜ì •</button>
      <button class="btn btn-d btn-sm" style="margin-left:4px" onclick="delEmp('${e.id}')">ì‚­ì œ</button>
    </td></tr>`;
  }).join('');
}
function openEmpMo(id){
  editEmp=id?DB.emp.find(e=>e.id===id):null;
  document.getElementById('moEmpTitle').textContent=editEmp?'ì§ì› ìˆ˜ì •':'ì§ì› ë“±ë¡';
  const f=editEmp||{};
  document.getElementById('eName').value=f.name||'';
  document.getElementById('eDept').value=f.department||'';
  document.getElementById('ePos').value=f.position||'';
  document.getElementById('eJoin').value=f.joinDate||'';
  document.getElementById('ePhone').value=f.phone||'';
  document.getElementById('eBirth').value=f.birthDate||'';
  document.getElementById('eEmail').value=f.email||'';
  document.getElementById('eResign').value=f.resignDate||'';
  document.getElementById('eMemo').value=f.memo||'';
  document.getElementById('moEmp').classList.add('on');
}
async function saveEmp(){
  const name=document.getElementById('eName').value.trim();
  const dept=document.getElementById('eDept').value.trim();
  const pos=document.getElementById('ePos').value.trim();
  const join=document.getElementById('eJoin').value;
  if(!name||!dept||!pos||!join){alert('ì´ë¦„, ë¶€ì„œ, ì§ì±…, ì…ì‚¬ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');return;}
  const id=editEmp?editEmp.id:'emp_'+Date.now();
  const emp={id,name,department:dept,position:pos,joinDate:join,
    phone:document.getElementById('ePhone').value.trim(),
    birthDate:document.getElementById('eBirth').value,
    email:document.getElementById('eEmail').value.trim(),
    resignDate:document.getElementById('eResign').value,
    memo:document.getElementById('eMemo').value.trim(),
    updatedAt:new Date().toISOString()
  };
  await fbSet('employees',id,emp);
  const idx=DB.emp.findIndex(e=>e.id===id);
  if(idx>=0)DB.emp[idx]=emp;else DB.emp.push(emp);
  closeMo('moEmp');renderDash();renderEmp();
}
async function delEmp(id){
  if(!confirm('ì´ ì§ì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  await fbDel('employees',id);
  DB.emp=DB.emp.filter(e=>e.id!==id);
  renderDash();renderEmp();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì—°ì°¨ê´€ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLeave(){
  if(!CU||CU.role!=='admin')return;
  const yr=parseInt((document.getElementById('leaveYr')||{}).value||new Date().getFullYear());
  const now=new Date();
  const active=DB.emp.filter(e=>!e.resignDate||new Date(e.resignDate)>now);
  const tb=document.getElementById('leaveTb');
  if(!active.length){tb.innerHTML='<tr><td colspan="7"><div class="empty"><div class="ico">ğŸ“…</div><p>ì¬ì§ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</p></div></td></tr>';return;}
  tb.innerHTML=active.map(emp=>{
    const lv=DB.leave.find(l=>l.employeeId===emp.id&&Number(l.year)===yr);
    const total=lv?Number(lv.totalDays)||0:0;
    const used=lv?(lv.usageHistory||[]).reduce((s,h)=>s+Number(h.days||0),0):0;
    const remain=total-used;
    const pct=total>0?Math.min(100,Math.round(used/total*100)):0;
    return`<tr><td><strong>${emp.name}</strong></td><td>${emp.department||'-'}</td><td>${total}ì¼</td><td>${used}ì¼</td><td>${remain}ì¼</td>
      <td><div style="display:flex;align-items:center;gap:8px"><div class="lb-wrap"><div class="lb" style="width:${pct}%;background:${pct>80?'var(--danger)':'var(--primary)'}"></div></div><span style="font-size:12px;color:var(--g500)">${pct}%</span></div></td>
      <td>
        <button class="btn btn-o btn-sm" onclick="openLeaveMo('${emp.id}')">ì¶”ê°€</button>
        ${lv?`<button class="btn btn-d btn-sm" style="margin-left:4px" onclick="delLeave('${emp.id}',${yr})">ì‚­ì œ</button>`:''}
      </td></tr>`;
  }).join('');
}
function openLeaveMo(empId){
  const sel=document.getElementById('lvEmp');
  sel.innerHTML='<option value="">ì§ì› ì„ íƒ</option>';
  DB.emp.filter(e=>!e.resignDate||new Date(e.resignDate)>new Date()).forEach(e=>{
    sel.innerHTML+=`<option value="${e.id}" ${e.id===empId?'selected':''}>${e.name} (${e.department||'-'})</option>`;
  });
  document.getElementById('lvYr').value=(document.getElementById('leaveYr')||{}).value||new Date().getFullYear();
  document.getElementById('lvTotal').value='';
  document.getElementById('lvUsed').value='';
  document.getElementById('lvReason').value='';
  document.getElementById('lvDate').value=new Date().toISOString().slice(0,10);
  document.getElementById('moLeave').classList.add('on');
}
async function saveLeave(){
  const empId=document.getElementById('lvEmp').value;
  const yr=parseInt(document.getElementById('lvYr').value);
  const total=parseInt(document.getElementById('lvTotal').value);
  const used=parseInt(document.getElementById('lvUsed').value)||0;
  const reason=document.getElementById('lvReason').value.trim();
  const date=document.getElementById('lvDate').value;
  if(!empId||!yr||isNaN(total)){alert('ì§ì›, ì—°ë„, ì´ ì—°ì°¨ì¼ìˆ˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');return;}
  const emp=DB.emp.find(e=>e.id===empId);
  const lid=`lv_${empId}_${yr}`;
  let lv=DB.leave.find(l=>l.id===lid);
  if(lv){
    lv.totalDays=total;
    if(used>0)lv.usageHistory=[...(lv.usageHistory||[]),{days:used,reason,date,recordDate:new Date().toISOString()}];
  }else{
    lv={id:lid,employeeId:empId,employeeName:emp.name,year:yr,totalDays:total,usageHistory:used>0?[{days:used,reason,date,recordDate:new Date().toISOString()}]:[]};
    DB.leave.push(lv);
  }
  await fbSet('annualLeaves',lid,lv);
  const idx=DB.leave.findIndex(l=>l.id===lid);
  if(idx>=0)DB.leave[idx]=lv;
  closeMo('moLeave');renderLeave();
}
async function delLeave(empId,yr){
  if(!confirm('ì´ ì—°ì°¨ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  const lid=`lv_${empId}_${yr}`;
  await fbDel('annualLeaves',lid);
  DB.leave=DB.leave.filter(l=>l.id!==lid);renderLeave();
}
function openBulkMo(){
  document.getElementById('blYr').value=new Date().getFullYear();
  document.getElementById('blDays').value='';
  document.getElementById('moBulk').classList.add('on');
}
async function saveBulk(){
  const yr=parseInt(document.getElementById('blYr').value);
  const days=parseInt(document.getElementById('blDays').value);
  if(!yr||isNaN(days)||days<=0){alert('ì—°ë„ì™€ ì§€ê¸‰ì¼ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return;}
  const active=DB.emp.filter(e=>!e.resignDate||new Date(e.resignDate)>new Date());
  for(const emp of active){
    const lid=`lv_${emp.id}_${yr}`;
    let lv=DB.leave.find(l=>l.id===lid);
    if(!lv){lv={id:lid,employeeId:emp.id,employeeName:emp.name,year:yr,totalDays:days,usageHistory:[]};DB.leave.push(lv);}
    else lv.totalDays=days;
    await fbSet('annualLeaves',lid,lv);
    const idx=DB.leave.findIndex(l=>l.id===lid);if(idx>=0)DB.leave[idx]=lv;
  }
  closeMo('moBulk');renderLeave();
  alert(`âœ… ${active.length}ëª…ì—ê²Œ ${days}ì¼ ì—°ì°¨ë¥¼ ì§€ê¸‰í–ˆìŠµë‹ˆë‹¤.`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì§ë¬´êµìœ¡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEdu(){
  const q=(document.getElementById('eduQ')||{}).value||'';
  const now=new Date();
  let list=DB.edu.filter(e=>!q||(e.employeeName||'').includes(q)||(e.name||'').includes(q));
  list.sort((a,b)=>new Date(b.educationDate||0)-new Date(a.educationDate||0));
  const tb=document.getElementById('eduTb');
  if(!list.length){tb.innerHTML='<tr><td colspan="7"><div class="empty"><div class="ico">ğŸ“š</div><p>êµìœ¡ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p></div></td></tr>';return;}
  tb.innerHTML=list.map(e=>{
    let badge='<span class="badge b-gy">-</span>';
    if(e.nextDate){
      const diff=Math.ceil((new Date(e.nextDate)-now)/86400000);
      if(diff<0)badge='<span class="badge b-rd">ë§Œë£Œ</span>';
      else if(diff<30)badge=`<span class="badge b-yw">D-${diff}</span>`;
      else badge=`<span class="badge b-gr">D-${diff}</span>`;
    }
    return`<tr><td><strong>${e.employeeName||'-'}</strong></td><td>${e.name||'-'}</td><td>${e.educationDate?new Date(e.educationDate).toLocaleDateString('ko-KR'):'-'}</td><td>${e.certificate||'-'}</td><td>${e.nextDate?new Date(e.nextDate).toLocaleDateString('ko-KR'):'-'}</td><td>${badge}</td><td>
      <button class="btn btn-o btn-sm" onclick="openEduMo('${e.id}')">ìˆ˜ì •</button>
      <button class="btn btn-d btn-sm" style="margin-left:4px" onclick="delEdu('${e.id}')">ì‚­ì œ</button>
    </td></tr>`;
  }).join('');
}
function openEduMo(id){
  editEdu=id?DB.edu.find(e=>e.id===id):null;
  document.getElementById('moEduTitle').textContent=editEdu?'êµìœ¡ ìˆ˜ì •':'êµìœ¡ ì¶”ê°€';
  const sel=document.getElementById('edEmp');
  sel.innerHTML='<option value="">ì§ì› ì„ íƒ</option>';
  DB.emp.forEach(e=>sel.innerHTML+=`<option value="${e.id}|${e.name}" ${editEdu&&editEdu.employeeId===e.id?'selected':''}>${e.name} (${e.department||'-'})</option>`);
  const f=editEdu||{};
  document.getElementById('edName').value=f.name||'';
  document.getElementById('edDate').value=f.educationDate||'';
  document.getElementById('edType').value=f.type||'í•„ìˆ˜êµìœ¡';
  document.getElementById('edCert').value=f.certificate||'';
  document.getElementById('edCertDate').value=f.certificateDate||'';
  document.getElementById('edNext').value=f.nextDate||'';
  document.getElementById('edMemo').value=f.memo||'';
  document.getElementById('moEdu').classList.add('on');
}
async function saveEdu(){
  const ev=document.getElementById('edEmp').value;
  const name=document.getElementById('edName').value.trim();
  const date=document.getElementById('edDate').value;
  if(!ev||!name||!date){alert('ì§ì›, êµìœ¡ëª…, êµìœ¡ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');return;}
  const[empId,empName]=ev.split('|');
  const id=editEdu?editEdu.id:'edu_'+Date.now();
  const edu={id,employeeId:empId,employeeName:empName,name,educationDate:date,
    type:document.getElementById('edType').value,
    certificate:document.getElementById('edCert').value.trim(),
    certificateDate:document.getElementById('edCertDate').value,
    nextDate:document.getElementById('edNext').value,
    memo:document.getElementById('edMemo').value.trim()
  };
  await fbSet('educations',id,edu);
  const idx=DB.edu.findIndex(e=>e.id===id);
  if(idx>=0)DB.edu[idx]=edu;else DB.edu.push(edu);
  closeMo('moEdu');renderEdu();
}
async function delEdu(id){
  if(!confirm('ì´ êµìœ¡ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  await fbDel('educations',id);
  DB.edu=DB.edu.filter(e=>e.id!==id);renderEdu();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë°±ì—…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dlBackup(){
  const data={employees:DB.emp,annualLeaves:DB.leave,educations:DB.edu,exportedAt:new Date().toISOString()};
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}));
  a.download=`backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}
async function restoreBackup(event){
  const file=event.target.files[0];if(!file)return;
  if(!confirm('í˜„ì¬ ë°ì´í„°ê°€ ëª¨ë‘ êµì²´ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  try{
    const bd=JSON.parse(await file.text());
    if(bd.employees){await fbReplaceAll('employees',bd.employees);DB.emp=bd.employees;}
    if(bd.annualLeaves){await fbReplaceAll('annualLeaves',bd.annualLeaves);DB.leave=bd.annualLeaves;}
    if(bd.educations){await fbReplaceAll('educations',bd.educations);DB.edu=bd.educations;}
    refreshUI();alert('âœ… ë°±ì—… ë³µì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
  }catch(e){alert('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.');}
  event.target.value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ê´€ë¦¬ì íŒ¨ë„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderAdmin(){
  // ê´€ë¦¬ì íƒ­ í´ë¦­ ì‹œì—ë§Œ ìµœì‹  ë¡œë“œ
  if(document.getElementById('p-admin').classList.contains('on')){
    DB.users=await fbGetAll('sysUsers');
  }
  const pending=DB.users.filter(u=>u.status==='pending');
  const pb=document.getElementById('pbadge');
  if(pending.length){pb.textContent=pending.length;pb.style.display='';}else pb.style.display='none';
  const pl=document.getElementById('pList');
  if(!pending.length){
    pl.innerHTML='<div class="empty"><div class="ico">âœ…</div><p>ëŒ€ê¸° ì¤‘ì¸ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
  }else{
    pl.innerHTML=pending.map(u=>`<div class="pi">
      <div><strong>${u.name}</strong><span style="color:var(--g500);margin-left:8px">(${u.id})</span><span style="font-size:12px;color:var(--g400);margin-left:8px">${new Date(u.createdAt).toLocaleDateString('ko-KR')} ì‹ ì²­</span></div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-s btn-sm" onclick="approveUser('${u.id}')">âœ… ìŠ¹ì¸</button>
        <button class="btn btn-d btn-sm" onclick="rejectUser('${u.id}')">âŒ ê±°ì ˆ</button>
      </div>
    </div>`).join('');
  }
  const all=DB.users.filter(u=>u.role!=='admin');
  const ut=document.getElementById('uTb');
  if(!all.length){
    ut.innerHTML='<tr><td colspan="5"><div class="empty"><div class="ico">ğŸ‘¥</div><p>ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</p></div></td></tr>';
  }else{
    ut.innerHTML=all.map(u=>`<tr>
      <td><strong>${u.name}</strong></td><td>${u.id}</td>
      <td>${u.status==='approved'?'<span class="badge b-gr">ìŠ¹ì¸ë¨</span>':u.status==='pending'?'<span class="badge b-yw">ëŒ€ê¸°ì¤‘</span>':'<span class="badge b-rd">ê±°ì ˆë¨</span>'}</td>
      <td>${new Date(u.createdAt).toLocaleDateString('ko-KR')}</td>
      <td>
        ${u.status!=='approved'?`<button class="btn btn-s btn-sm" onclick="approveUser('${u.id}')">ìŠ¹ì¸</button>`:''}
        <button class="btn btn-d btn-sm" style="margin-left:4px" onclick="delUser('${u.id}')">ì‚­ì œ</button>
      </td>
    </tr>`).join('');
  }
}
async function approveUser(id){
  const u=DB.users.find(u=>u.id===id);if(!u)return;
  u.status='approved';await fbSet('sysUsers',id,u);
  renderAdmin();alert(`âœ… ${u.name}(${u.id}) ìŠ¹ì¸ ì™„ë£Œ`);
}
async function rejectUser(id){
  const u=DB.users.find(u=>u.id===id);
  if(!u||!confirm(`${u.name}(${u.id}) íšŒì› ê°€ì…ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  u.status='rejected';await fbSet('sysUsers',id,u);renderAdmin();
}
async function delUser(id){
  if(!confirm('ì´ íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  await fbDel('sysUsers',id);
  DB.users=DB.users.filter(u=>u.id!==id);renderAdmin();
}
async function updateAdmin(){
  const newId=document.getElementById('aNewId').value.trim();
  const curPw=document.getElementById('aCurPw').value;
  const newPw=document.getElementById('aNewPw').value;
  const newPw2=document.getElementById('aNewPw2').value;
  if(!curPw){alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return;}
  if(curPw!==CU.pw){alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');return;}
  if(newPw&&newPw.length<6){alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');return;}
  if(newPw&&newPw!==newPw2){alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');return;}
  const updated={...CU,pw:newPw||CU.pw};
  if(newId)updated.id=newId;
  await fbSet('sysUsers',updated.id,updated);
  if(newId&&newId!==CU.id)await fbDel('sysUsers',CU.id);
  CU=updated;sessionStorage.setItem('cu',JSON.stringify(CU));
  alert('âœ… ê³„ì •ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ì‹œì‘
init();
</script>
</body>
</html>
